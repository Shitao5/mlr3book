<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Applied Machine Learning Using mlr3 in R - Appendix A — Solutions to exercises</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/appendices/tasks.html" rel="next">
<link href="../../chapters/references.html" rel="prev">
<link href="../../Figures/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html">Appendices</a></li><li class="breadcrumb-item"><a href="../../chapters/appendices/solutions.html"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Applied Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../../Applied-Machine-Learning-Using-mlr3-in-R.pdf" rel="" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter1/introduction_and_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter2/data_and_basic_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data and Basic Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter3/evaluation_and_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Evaluation and Benchmarking</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Tuning and Feature Selection</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter4/hyperparameter_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter5/advanced_tuning_methods_and_black_box_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Advanced Tuning Methods and Black Box Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter6/feature_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Feature Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Pipelines and Preprocessing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter7/sequential_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Sequential Pipelines</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter8/non-sequential_pipelines_and_tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Non-sequential Pipelines and Tuning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter9/preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Preprocessing</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter10/advanced_technical_aspects_of_mlr3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Technical Aspects of mlr3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter11/large-scale_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Large-Scale Benchmarking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter12/model_interpretation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Interpretation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter13/beyond_regression_and_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Beyond Regression and Classification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter14/algorithmic_fairness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Algorithmic Fairness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/solutions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Tasks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/overview-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Overview Tables</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#solutions-to-sec-basics" id="toc-solutions-to-sec-basics" class="nav-link active" data-scroll-target="#solutions-to-sec-basics"><span class="header-section-number">A.1</span> Solutions to <span>Chapter&nbsp;2</span></a></li>
  <li><a href="#solutions-to-sec-performance" id="toc-solutions-to-sec-performance" class="nav-link" data-scroll-target="#solutions-to-sec-performance"><span class="header-section-number">A.2</span> Solutions to <span>Chapter&nbsp;3</span></a></li>
  <li><a href="#solutions-to-sec-optimization" id="toc-solutions-to-sec-optimization" class="nav-link" data-scroll-target="#solutions-to-sec-optimization"><span class="header-section-number">A.3</span> Solutions to <span>Chapter&nbsp;4</span></a></li>
  <li><a href="#solutions-to-sec-optimization-advanced" id="toc-solutions-to-sec-optimization-advanced" class="nav-link" data-scroll-target="#solutions-to-sec-optimization-advanced"><span class="header-section-number">A.4</span> Solutions to <span>Chapter&nbsp;5</span></a></li>
  <li><a href="#solutions-to-sec-feature-selection" id="toc-solutions-to-sec-feature-selection" class="nav-link" data-scroll-target="#solutions-to-sec-feature-selection"><span class="header-section-number">A.5</span> Solutions to <span>Chapter&nbsp;6</span></a></li>
  <li><a href="#solutions-to-sec-pipelines" id="toc-solutions-to-sec-pipelines" class="nav-link" data-scroll-target="#solutions-to-sec-pipelines"><span class="header-section-number">A.6</span> Solutions to <span>Chapter&nbsp;7</span></a></li>
  <li><a href="#solutions-to-sec-pipelines-nonseq" id="toc-solutions-to-sec-pipelines-nonseq" class="nav-link" data-scroll-target="#solutions-to-sec-pipelines-nonseq"><span class="header-section-number">A.7</span> Solutions to <span>Chapter&nbsp;8</span></a></li>
  <li><a href="#solutions-for-sec-preprocessing" id="toc-solutions-for-sec-preprocessing" class="nav-link" data-scroll-target="#solutions-for-sec-preprocessing"><span class="header-section-number">A.8</span> Solutions for <span>Chapter&nbsp;9</span></a></li>
  <li><a href="#solutions-to-sec-special" id="toc-solutions-to-sec-special" class="nav-link" data-scroll-target="#solutions-to-sec-special"><span class="header-section-number">A.9</span> Solutions to <span>Chapter&nbsp;13</span></a></li>
  <li><a href="#solutions-to-sec-technical" id="toc-solutions-to-sec-technical" class="nav-link" data-scroll-target="#solutions-to-sec-technical"><span class="header-section-number">A.10</span> Solutions to <span>Chapter&nbsp;10</span></a></li>
  <li><a href="#solutions-to-sec-large-benchmarking" id="toc-solutions-to-sec-large-benchmarking" class="nav-link" data-scroll-target="#solutions-to-sec-large-benchmarking"><span class="header-section-number">A.11</span> Solutions to <span>Chapter&nbsp;11</span></a></li>
  <li><a href="#solutions-to-sec-interpretation" id="toc-solutions-to-sec-interpretation" class="nav-link" data-scroll-target="#solutions-to-sec-interpretation"><span class="header-section-number">A.12</span> Solutions to <span>Chapter&nbsp;12</span></a></li>
  <li><a href="#solutions-to-sec-fairness" id="toc-solutions-to-sec-fairness" class="nav-link" data-scroll-target="#solutions-to-sec-fairness"><span class="header-section-number">A.13</span> Solutions to <span>Chapter&nbsp;14</span></a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mlr-org/mlr3book/edit/main/book/chapters/appendices/solutions.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/mlr-org/mlr3book/blob/main/book/chapters/appendices/solutions.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-solutions" class="quarto-section-identifier">Appendix A — Solutions to exercises</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><!-- ENSURE ONLINE ONLY AND REFERENCE IN PREFACE --><section id="solutions-to-sec-basics" class="level2" data-number="A.1"><h2 data-number="A.1" class="anchored" data-anchor-id="solutions-to-sec-basics">
<span class="header-section-number">A.1</span> Solutions to <a href="../chapter2/data_and_basic_modeling.html"><span>Chapter&nbsp;2</span></a>
</h2>
<ol type="1">
<li>Set the seed to <code>124</code> then train a classification tree model with <code>lrn("classif.rpart")</code> and default hyperparameters on 80% of the data in the predefined <code>"sonar"</code> task. Evaluate the model’s performance with the classification error measure on the remaining data. Also think about why we need to set the seed in this example.</li>
</ol>
<p>Set the seed, load the <code>"sonar"</code> task, then the classification tree with <code>predict_type = "prob"</code> (needed for exercise 3), and the required measure.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-001_364665967393605d71187f201c8979fe">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"sonar"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code><a href="https://mlr3.mlr-org.com/reference/partition.html">partition()</a></code> to split the dataset then train the model. We set the seed because <code><a href="https://mlr3.mlr-org.com/reference/partition.html">partition()</a></code> introduces an element of randomness when splitting the data.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-2_d42e9ebca110e5979b32958be09b0bd2">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">splits</span> <span class="op">=</span> <span class="fu">partition</span><span class="op">(</span><span class="va">task</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, <span class="va">splits</span><span class="op">$</span><span class="va">train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the model is trained, generate the predictions on the test set and score them.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-002_e2c85d6ae847b2529671b62fdb7a48e1">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, <span class="va">splits</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
    0.2195 </code></pre>
</div>
</div>
<ol type="1">
<li>Calculate the true positive, false positive, true negative, and false negative rates of the predictions made by the model in exercise 1.</li>
</ol>
<p>Using <code>$confusion</code>, generate a confusion matrix and extract the required statistics,</p>
<div class="cell" data-hash="solutions_cache/html/solutions-003_e72993764c5e1a4208f27f900b46b33a">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="va">confusion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response  M  R
       M 20  7
       R  2 12</code></pre>
</div>
</div>
<p>Since the rows represent predictions (response) and the columns represent the ground truth values, the TP, FP, TN, and FN rates are as follows:</p>
<ul>
<li><p>True Positive (TP) = 20</p></li>
<li><p>False Positive (FP) = 2</p></li>
<li><p>True Negative (TN) = 12</p></li>
<li><p>False Positive (FN) = 7</p></li>
</ul>
<ol type="1">
<li>Since in this case we want the model to predict the negative class more often, we will raise the threshold (note the <code>predict_type</code> for the learner must be <code>prob</code> for this to work).</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-005_b8235ee6b8b97ae00ca80e229064e6bb">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># raise threshold from 0.5 default to 0.6</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="va">confusion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        truth
response  M  R
       M 14  4
       R  8 15</code></pre>
</div>
</div>
<p>One reason we might want the false positive rate to be lower than the false negative rate is if we felt it was worse for a positive prediction to be incorrect (meaning the true label was the negative label) than it was for a negative prediction to be incorrect (meaning the true label was the positive label).</p>
</section><section id="solutions-to-sec-performance" class="level2" data-number="A.2"><h2 data-number="A.2" class="anchored" data-anchor-id="solutions-to-sec-performance">
<span class="header-section-number">A.2</span> Solutions to <a href="../chapter3/evaluation_and_benchmarking.html"><span>Chapter&nbsp;3</span></a>
</h2>
<ol type="1">
<li>Apply the “bootstrap” resampling strategy on <code>tsk("mtcars")</code> and evaluate the performance of <code>lrn("classif.rpart")</code>. Use 100 replicates and a sampling ratio of 80%. Calculate the MSE for each iteration and visualize the result. Finally, calculate the aggregated performance score.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-006_e8f9c7aa61811d697e170b4e3d2979d4">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"bootstrap"</span>, repeats <span class="op">=</span> <span class="fl">100</span>, ratio <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     task_id learner_id resampling_id iteration regr.mse
  1:  mtcars regr.rpart     bootstrap         1    17.53
  2:  mtcars regr.rpart     bootstrap         2    15.71
  3:  mtcars regr.rpart     bootstrap         3    31.63
  4:  mtcars regr.rpart     bootstrap         4    22.59
  5:  mtcars regr.rpart     bootstrap         5    36.64
 ---                                                    
 96:  mtcars regr.rpart     bootstrap        96    18.79
 97:  mtcars regr.rpart     bootstrap        97    19.10
 98:  mtcars regr.rpart     bootstrap        98    18.72
 99:  mtcars regr.rpart     bootstrap        99    33.32
100:  mtcars regr.rpart     bootstrap       100    25.87
Hidden columns: task, learner, resampling, prediction</code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">autoplot</span><span class="op">(</span><span class="va">rr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-006-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Alternatively: Histogram</span></span>
<span><span class="fu">autoplot</span><span class="op">(</span><span class="va">rr</span>, type <span class="op">=</span> <span class="st">"histogram"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-006-2.png" class="img-fluid" style="width:100.0%"></p>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
   20.75 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use <code>tsk("spam")</code> and five-fold CV to benchmark Random forest (<code>lrn("classif.ranger")</code>), Logistic Regression (<code>lrn("classif.log_reg")</code>), and XGBoost (<code>lrn("classif.xgboost")</code>) with respect to AUC. Which learner appears to do best? How confident are you in your conclusion? How would you improve upon this?</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-007_924ac47b6c07c948bfb87160c53e8395">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"spam"</span><span class="op">)</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu">lrns</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.ranger"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.xgboost"</span><span class="op">)</span>,</span>
<span>                  predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mlr3viz</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bmr</span>, measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.auc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-007-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>This is only a small example for a benchmark workflow, but without tuning (see <a href="../chapter4/hyperparameter_optimization.html"><span>Chapter&nbsp;4</span></a>), the results are naturally not suitable to make any broader statements about the superiority of either learner for this task.</p>
<ol start="3" type="1">
<li>A colleague claims to have achieved a 93.1% classification accuracy using <code>lrn("classif.rpart")</code> on <code>tsk("penguins_simple")</code>. You want to reproduce their results and ask them about their resampling strategy. They said they used a custom three-fold CV with folds assigned as <code>factor(task$row_ids %% 3)</code>. See if you can reproduce their results.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-008_3189d48898afcd0b6acac8e4f7d0c2aa">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"penguins_simple"</span><span class="op">)</span></span>
<span><span class="va">rsmp_cv</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"custom_cv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rsmp_cv</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">row_ids</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">rsmp_cv</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu">msr</span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
     0.9309 </code></pre>
</div>
</div>
</section><section id="solutions-to-sec-optimization" class="level2" data-number="A.3"><h2 data-number="A.3" class="anchored" data-anchor-id="solutions-to-sec-optimization">
<span class="header-section-number">A.3</span> Solutions to <a href="../chapter4/hyperparameter_optimization.html"><span>Chapter&nbsp;4</span></a>
</h2>
<ol type="1">
<li>Tune the <code>mtry</code>, <code>sample.fraction</code>, <code>num.trees</code> hyperparameters of a random forest model (<code>lrn("regr.ranger")</code>) on the <code>"mtcars"</code> task. Use a simple random search with 50 evaluations and select a suitable batch size. Evaluate with a three-fold CV and the root mean squared error.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-009_6c87475c935879b841f3cf996c4b6716">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>,</span>
<span>  mtry.ratio      <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1e-1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  num.trees       <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="fu">ti</span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measures <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span> <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tuner</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mtry.ratio sample.fraction num.trees learner_param_vals  x_domain
1:     0.2764          0.9772       556          &lt;list[4]&gt; &lt;list[3]&gt;
1 variable not shown: [regr.rmse]</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Evaluate the performance of the model created in Question 1 with nested resampling. Use a holdout validation for the inner resampling and a three-fold CV for the outer resampling. Print the unbiased performance estimate of the model.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-010_6b416b87cb994c0f16a49dba6ad83f8f">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>,</span>
<span>  mtry.ratio      <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  sample.fraction <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1e-1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  num.trees       <span class="op">=</span> <span class="fu">to_tune</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">at</span> <span class="op">=</span> <span class="fu">auto_tuner</span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">outer_resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span><span class="va">task</span>, <span class="va">at</span>, <span class="va">outer_resampling</span>, store_models <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regr.mse 
   8.322 </code></pre>
</div>
</div>
<ol type="1">
<li>Tune and benchmark an XGBoost model against a logistic regression model on the <code>"spam"</code> task and determine which has the best Brier score. Use mlr3tuningspaces and nested resampling.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-011_4291015a4471caf3516e9ca6e8ce1433">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3tuningspaces.mlr-org.com">mlr3tuningspaces</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: mlr3tuning</code></pre>
</div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_xgboost</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuningspaces.mlr-org.com/reference/lts.html">lts</a></span><span class="op">(</span><span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.xgboost"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">at_xgboost</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">lrn_xgboost</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.bbrier"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">2</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lrn_logreg</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">at_logreg</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/auto_tuner.html">auto_tuner</a></span><span class="op">(</span></span>
<span>  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="va">lrn_logreg</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"classif.bbrier"</span><span class="op">)</span>,</span>
<span>  term_evals <span class="op">=</span> <span class="fl">2</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"spam"</span><span class="op">)</span></span>
<span><span class="va">outer_resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  tasks <span class="op">=</span> <span class="va">task</span>,</span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">at_xgboost</span>, <span class="va">at_logreg</span><span class="op">)</span>,</span>
<span>  resamplings <span class="op">=</span> <span class="va">outer_resampling</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">design</span>, store_models <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred

Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BenchmarkResult&gt; of 6 rows with 2 resampling runs
 nr task_id            learner_id resampling_id iters warnings errors
  1    spam classif.xgboost.tuned            cv     3        0      0
  2    spam classif.log_reg.tuned            cv     3        0      0</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-optimization-advanced" class="level2" data-number="A.4"><h2 data-number="A.4" class="anchored" data-anchor-id="solutions-to-sec-optimization-advanced">
<span class="header-section-number">A.4</span> Solutions to <a href="../chapter5/advanced_tuning_methods_and_black_box_optimization.html"><span>Chapter&nbsp;5</span></a>
</h2>
<ol type="1">
<li>We first construct the objective function and optimization instance:</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-3_4bed58435967291bd3cb84c2f301fc24">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bbotk.mlr-org.com">bbotk</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3mbo.mlr-org.com">mlr3mbo</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">rastrigin</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">xdt</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">xdt</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">xdt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">data.table</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">objective</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunDt.html">ObjectiveRFunDt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">rastrigin</span>,</span>
<span>  domain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">5.12</span>, upper <span class="op">=</span> <span class="fl">5.12</span><span class="op">)</span>,</span>
<span>    x2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">5.12</span>, upper <span class="op">=</span> <span class="fl">5.12</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  codomain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"rastrigin2D"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/OptimInstanceSingleCrit.html">OptimInstanceSingleCrit</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  objective <span class="op">=</span> <span class="va">objective</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the different surrogate models, we can construct two optimizers:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-4_7060177d37547ded6718ea132c91e4f6">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3mbo.mlr-org.com">mlr3mbo</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">surrogate_gp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.km"</span>, covtype <span class="op">=</span> <span class="st">"matern5_2"</span>,</span>
<span>  optim.method <span class="op">=</span> <span class="st">"BFGS"</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">surrogate_rf</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">10L</span>, keep.inbag <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  se.method <span class="op">=</span> <span class="st">"jack"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_function</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqf.html">acqf</a></span><span class="op">(</span><span class="st">"cb"</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqo.html">acqo</a></span><span class="op">(</span><span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"nloptr"</span>, algorithm <span class="op">=</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"stagnation"</span>, iters <span class="op">=</span> <span class="fl">100</span>, threshold <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_gp</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_ego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate_gp</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_rf</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_ego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate_rf</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then evaluate the given initial design on the instance and optimize it with the first BO algorithm using a Gaussian Process as surrogate model:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-5_7e2c4ea84244c7b6823d0ef624a01a73">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">initial_design</span> <span class="op">=</span> <span class="fu">data.table</span><span class="op">(</span></span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.95</span>, <span class="fl">1.16</span>, <span class="fl">3.72</span>, <span class="op">-</span><span class="fl">1.39</span>, <span class="op">-</span><span class="fl">0.11</span>, <span class="fl">5.00</span>, <span class="op">-</span><span class="fl">2.67</span>, <span class="fl">2.44</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.18</span>, <span class="op">-</span><span class="fl">3.93</span>, <span class="fl">3.74</span>, <span class="op">-</span><span class="fl">1.37</span>, <span class="fl">5.02</span>, <span class="op">-</span><span class="fl">0.09</span>, <span class="op">-</span><span class="fl">2.65</span>, <span class="fl">2.46</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">initial_design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_gp</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gp_data</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">y_min</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">nr_eval</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">gp_data</span><span class="op">[</span>, <span class="va">surrogate</span> <span class="op">:=</span> <span class="st">"Gaussian Process"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Afterwards, we clear the instance, evaluate the initial design again and optimize the instance with the second BO algorithm using a random forest as surrogate model:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-6_192ffa034cff5954ce0247e0bb64aa66">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">clear</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span><span class="op">$</span><span class="fu">eval_batch</span><span class="op">(</span><span class="va">initial_design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer_rf</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_data</span> <span class="op">=</span> <span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">y_min</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cummin</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">nr_eval</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">.N</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">rf_data</span><span class="op">[</span>, <span class="va">surrogate</span> <span class="op">:=</span> <span class="st">"Random forest"</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We collect all data and visualize the anytime performance:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-7_d0d1fe4ac13b90a83ef85d5bf0a2a0df">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridisLite/">viridisLite</a></span><span class="op">)</span></span>
<span><span class="va">all_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">gp_data</span>, <span class="va">rf_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nr_eval</span>, y <span class="op">=</span> <span class="va">y_min</span>, colour <span class="op">=</span> <span class="va">surrogate</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">all_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">2</span>, end <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Best Observed Function Value"</span>, x <span class="op">=</span> <span class="st">"Number of Function Evaluations"</span>,</span>
<span>       colour <span class="op">=</span> <span class="st">"Surrogate Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<ol start="2" type="1">
<li>We first construct the non-parallelized objective function and the optimization instance:</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-8_75e44290291328de0b090982ba14dcfa">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schaffer1</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xss</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">evaluations</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">xss</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="va">xs</span><span class="op">$</span><span class="va">x</span>, y2 <span class="op">=</span> <span class="op">(</span><span class="va">xs</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">rbindlist</span><span class="op">(</span><span class="va">evaluations</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">objective</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunMany.html">ObjectiveRFunMany</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">schaffer1</span>,</span>
<span>  domain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  codomain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span>, y2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"schaffer1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/OptimInstanceMultiCrit.html">OptimInstanceMultiCrit</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  objective <span class="op">=</span> <span class="va">objective</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"run_time"</span>, secs <span class="op">=</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the surrogate, acquisition function and acquisition function optimizer that are provided, we can proceed to optimize the instance via ParEGO:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-9_e7d99b4a5975b9c2ae7969d375a48ad2">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surrogate</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/srlrn.html">srlrn</a></span><span class="op">(</span><span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">10L</span>, keep.inbag <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  se.method <span class="op">=</span> <span class="st">"jack"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_function</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqf.html">acqf</a></span><span class="op">(</span><span class="st">"ei"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">acq_optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3mbo.mlr-org.com/reference/acqo.html">acqo</a></span><span class="op">(</span><span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"random_search"</span>, batch_size <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optimizer</span> <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/opt.html">opt</a></span><span class="op">(</span><span class="st">"mbo"</span>,</span>
<span>  loop_function <span class="op">=</span> <span class="va">bayesopt_parego</span>,</span>
<span>  surrogate <span class="op">=</span> <span class="va">surrogate</span>,</span>
<span>  acq_function <span class="op">=</span> <span class="va">acq_function</span>,</span>
<span>  acq_optimizer <span class="op">=</span> <span class="va">acq_optimizer</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-10_2a507e1f240670bbfc1e1a0f7e1b163e">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">optimizer</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We observe that 12 points were evaluated in total (which makes sense as the objective function evaluation is not yet parallelized and the overhead of each function evaluation is given by 5 seconds). While the points are appropriately evaluated in batches of size <code>q = 4</code> (with the initial design automatically constructed as the first batch), we do not experience any acceleration of the optimization process unless the function evaluation is explicitly parallelized.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-11_5c67863c4c871f3342721bea12233e4b">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12</code></pre>
</div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"timestamp"</span>, <span class="st">"batch_nr"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           x           timestamp batch_nr
 1:  0.03433 2023-07-12 09:16:13        1
 2: -9.96567 2023-07-12 09:16:13        1
 3: -4.96567 2023-07-12 09:16:13        1
 4:  5.03433 2023-07-12 09:16:13        1
 5:  7.34464 2023-07-12 09:16:34        2
---                                      
 8: -8.50644 2023-07-12 09:16:34        2
 9: -2.22408 2023-07-12 09:16:54        3
10: -6.44530 2023-07-12 09:16:54        3
11:  0.90963 2023-07-12 09:16:54        3
12: -2.21318 2023-07-12 09:16:54        3</code></pre>
</div>
</div>
<p>We now parallelize the evaluation of the objective function and proceed to optimize the instance again:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-12_d9e4bc51e7597c5f7eeb808b7e877622">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org">future.apply</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">schaffer1_parallel</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xss</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">evaluations</span> <span class="op">=</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html">future_lapply</a></span><span class="op">(</span><span class="va">xss</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">xs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="va">xs</span><span class="op">$</span><span class="va">x</span>, y2 <span class="op">=</span> <span class="op">(</span><span class="va">xs</span><span class="op">$</span><span class="va">x</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu">rbindlist</span><span class="op">(</span><span class="va">evaluations</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">objective_parallel</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/ObjectiveRFunMany.html">ObjectiveRFunMany</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  fun <span class="op">=</span> <span class="va">schaffer1_parallel</span>,</span>
<span>  domain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  codomain <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>y1 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span>, y2 <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"schaffer1_parallel"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance_parallel</span> <span class="op">=</span> <span class="va"><a href="https://bbotk.mlr-org.com/reference/OptimInstanceMultiCrit.html">OptimInstanceMultiCrit</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  objective <span class="op">=</span> <span class="va">objective_parallel</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"run_time"</span>, secs <span class="op">=</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-13_f26fd8f57b775dc9b90a00e88fbc7d53">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">optimizer</span><span class="op">$</span><span class="fu">optimize</span><span class="op">(</span><span class="va">instance_parallel</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By parallelizing the evaluation of the objective function we used our compute resources much more efficiently and evaluated many more points:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-14_1b8ff34f87f16eb6bd900784c90ba01f">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">instance_parallel</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44</code></pre>
</div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance_parallel</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"timestamp"</span>, <span class="st">"batch_nr"</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         x           timestamp batch_nr
 1: -8.010 2023-07-12 09:17:01        1
 2:  1.990 2023-07-12 09:17:01        1
 3: -3.010 2023-07-12 09:17:01        1
 4:  6.990 2023-07-12 09:17:01        1
 5:  9.454 2023-07-12 09:17:07        2
---                                    
40:  6.300 2023-07-12 09:17:52       10
41: -8.767 2023-07-12 09:17:57       11
42: -9.546 2023-07-12 09:17:57       11
43:  3.432 2023-07-12 09:17:57       11
44:  3.917 2023-07-12 09:17:57       11</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-feature-selection" class="level2" data-number="A.5"><h2 data-number="A.5" class="anchored" data-anchor-id="solutions-to-sec-feature-selection">
<span class="header-section-number">A.5</span> Solutions to <a href="../chapter6/feature_selection.html"><span>Chapter&nbsp;6</span></a>
</h2>
<ol type="1">
<li>Calculate a correlation filter on the <code>"mtcars"</code> task.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-012_366072991ab1eae1b88a1c4fb66eb298">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="va">filter</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3filters.mlr-org.com/reference/flt.html">flt</a></span><span class="op">(</span><span class="st">"correlation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">filter</span><span class="op">$</span><span class="fu">calculate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    feature  score
 1:      wt 0.8677
 2:     cyl 0.8522
 3:    disp 0.8476
 4:      hp 0.7762
 5:    drat 0.6812
 6:      vs 0.6640
 7:      am 0.5998
 8:    carb 0.5509
 9:    gear 0.4803
10:    qsec 0.4187</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use the filter from the first exercise to select the five best features in the <code>mtcars</code> dataset.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-013_0cdd079c0c815cb8b23c18a7ccf17bdf">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">keep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="va">scores</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="va">keep</span><span class="op">)</span></span>
<span><span class="va">task</span><span class="op">$</span><span class="va">feature_names</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "cyl"  "disp" "drat" "hp"   "wt"  </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Apply a backward selection to <code>tsk("penguins")</code> with <code>lrn("classif.rpart")</code> and holdout resampling by the measure classification accuracy. Compare the results with those in <a href="../chapter6/feature_selection.html#sec-fs-wrapper-example"><span>Section&nbsp;6.2.1</span></a>.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-014_2bf3bdf05a61b61e2bdca4deab791e1d">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3fselect.mlr-org.com">mlr3fselect</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'mlr3fselect'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:mlr3tuning':

    ContextEval</code></pre>
</div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fselect.html">fselect</a></span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sbs"</span><span class="op">)</span>,</span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">instance</span><span class="op">$</span><span class="va">result</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">bill_depth</span>, <span class="va">bill_length</span>, <span class="va">body_mass</span>, <span class="va">classif.acc</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass classif.acc
1:       TRUE        TRUE      TRUE      0.9565</code></pre>
</div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">instance</span><span class="op">$</span><span class="va">result_feature_set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "bill_depth"  "bill_length" "body_mass"   "island"      "sex"        
[6] "year"       </code></pre>
</div>
</div>
<p>Answer the following questions:</p>
<ol type="a">
<li>Do the selected features differ?</li>
</ol>
<p>Yes, the backward selection selects more features.</p>
<ol start="2" type="a">
<li>Which feature selection method achieves a higher classification accuracy?</li>
</ol>
<p>In this example, the backwards example performs slightly better, but this depends heavily on the random seed and could look different in another run.</p>
<ol start="3" type="a">
<li>Are the accuracy values in b) directly comparable? If not, what has to be changed to make them comparable?</li>
</ol>
<p>No, they are not comparable because the holdout sampling called with <code>rsmp("holdout")</code> creates a different holdout set for the two runs. A fair comparison would create a single resampling instance and use it for both feature selections (see <a href="../chapter3/evaluation_and_benchmarking.html"><span>Chapter&nbsp;3</span></a> for details):</p>
<div class="cell" data-hash="solutions_cache/html/solutions-015_df838c48ede556d1fb14481656afe11c">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span></span>
<span><span class="va">resampling</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">instance_sfs</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fselect.html">fselect</a></span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sfs"</span><span class="op">)</span>,</span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">instance_sbs</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fselect.html">fselect</a></span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span><span class="st">"sequential"</span>, strategy <span class="op">=</span> <span class="st">"sbs"</span><span class="op">)</span>,</span>
<span>  task <span class="op">=</span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">instance_sfs</span><span class="op">$</span><span class="va">result</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">bill_depth</span>, <span class="va">bill_length</span>, <span class="va">body_mass</span>, <span class="va">classif.acc</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass classif.acc
1:      FALSE        TRUE     FALSE      0.9304</code></pre>
</div>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">instance_sbs</span><span class="op">$</span><span class="va">result</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">bill_depth</span>, <span class="va">bill_length</span>, <span class="va">body_mass</span>, <span class="va">classif.acc</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   bill_depth bill_length body_mass classif.acc
1:      FALSE        TRUE      TRUE      0.9565</code></pre>
</div>
</div>
<p>Alternatively, one could automate the feature selection and perform a benchmark between the two wrapped learners.</p>
<ol start="4" type="1">
<li>Automate the feature selection as in <a href="../chapter6/feature_selection.html#sec-autofselect"><span>Section&nbsp;6.2.6</span></a> with <code>tsk("spam")</code> and <code>lrn("classif.log_reg")</code>.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-016_de7ccca3219d41d9eb170f2ea86e497c">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3fselect.mlr-org.com">mlr3fselect</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">at</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/auto_fselector.html">auto_fselector</a></span><span class="op">(</span></span>
<span>  fselector <span class="op">=</span> <span class="fu"><a href="https://mlr3fselect.mlr-org.com/reference/fs.html">fs</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span>,</span>
<span>  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.acc"</span><span class="op">)</span>,</span>
<span>  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span></span>
<span>  task <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"spam"</span><span class="op">)</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">at</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggr</span> <span class="op">=</span> <span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msrs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.acc"</span>, <span class="st">"time_train"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">aggr</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">learner_id</span>, <span class="va">classif.acc</span>, <span class="va">time_train</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  learner_id classif.acc time_train
1: classif.log_reg.fselector      0.9226     15.666
2:           classif.log_reg      0.9268      0.372</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-pipelines" class="level2" data-number="A.6"><h2 data-number="A.6" class="anchored" data-anchor-id="solutions-to-sec-pipelines">
<span class="header-section-number">A.6</span> Solutions to <a href="../chapter7/sequential_pipelines.html"><span>Chapter&nbsp;7</span></a>
</h2>
<ol type="1">
<li>Concatenate the named PipeOps using <code>%&gt;&gt;%</code>. To get a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> object, use <a href="https://mlr3.mlr-org.com/reference/as_learner.html"><code>as_learner()</code></a>
</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-001_e8c606d165fd99719e508c580e9d143f">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span></span>
<span><span class="va">graph_learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>After training, the underlying <code>lrn("classif.log_reg")</code> can be accessed through the <code>$base_learner()</code> method. Alternatively, the learner can be accessed explicitly using <code>po("learner")</code>.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-002_de0939336abe6af24e51ac711d31d161">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># access the learner through the $base_learner() method</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="fu">base_learner</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age     glucose     insulin        mass    pedigree 
   -0.88835     0.15584     1.13631    -0.17477     0.74383     0.32121 
   pregnant    pressure     triceps 
    0.39594    -0.24967     0.05599 </code></pre>
</div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># access the learner explicitly through the PipeOp</span></span>
<span><span class="va">pipeop</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">classif.log_reg</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va">pipeop</span><span class="op">$</span><span class="va">learner_model</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age     glucose     insulin        mass    pedigree 
   -0.88835     0.15584     1.13631    -0.17477     0.74383     0.32121 
   pregnant    pressure     triceps 
    0.39594    -0.24967     0.05599 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Set the <code>$keep_results</code> flag of the Graph to <code>TRUE</code> to keep the results of the individual PipeOps. Afterwards, the input of the <code>lrn("classif.log_reg")</code> can be accessed through the <code>$.result</code> field of its predecessor, the <code>po("scale")</code>. Note that the <code>$.result</code> is a <code>list</code>, we want to access its only element, named <code>$output</code>.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-003_c0d22e01fab71214a90dff86b4987d90">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="va">graph</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"pima"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># access the input of the learner</span></span>
<span><span class="va">scale_result</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">scale</span><span class="op">$</span><span class="va">.result</span></span>
<span></span>
<span><span class="va">scale_output_task</span> <span class="op">=</span> <span class="va">scale_result</span><span class="op">$</span><span class="va">output</span></span>
<span></span>
<span><span class="va">age_column</span> <span class="op">=</span> <span class="va">scale_output_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">age</span></span>
<span></span>
<span><span class="co"># check if the age column is standardized:</span></span>
<span><span class="co"># 1. does it have mean 0? -- almost, up to numerical precision!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age_column</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.988e-16</code></pre>
</div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 2. does it have standard deviation 1? -- yes!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">age_column</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-pipelines-nonseq" class="level2" data-number="A.7"><h2 data-number="A.7" class="anchored" data-anchor-id="solutions-to-sec-pipelines-nonseq">
<span class="header-section-number">A.7</span> Solutions to <a href="../chapter8/non-sequential_pipelines_and_tuning.html"><span>Chapter&nbsp;8</span></a>
</h2>
<ol type="1">
<li>To use <code>po("select")</code> to <em>remove</em>, instead of <em>keep</em>, a feature based on a pattern, use <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>selector_invert</code></a> together with <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>selector_grep</code></a>. To remove the “<code>R</code>” class columns in <a href="../chapter8/non-sequential_pipelines_and_tuning.html#sec-pipelines-stack"><span>Section&nbsp;8.3.2</span></a>, the following <code>po("select")</code> could be used:</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-004_b3e2e45c256bcef8c66ab4ccec213438">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"select"</span>, selector <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_grep</a></span><span class="op">(</span><span class="st">"\\.R"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;select&gt; (not trained)
values: &lt;selector=&lt;Selector&gt;&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<p>which would have the benefit that it would keep the columns pertaining to all other classes, even if the <code>"sonar"</code> task had more target classes.</p>
<ol start="2" type="1">
<li>A solution that does not need to specify the target classes at all is to use a custom <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html"><code>Selector</code></a>, as was shown in <a href="../chapter8/non-sequential_pipelines_and_tuning.html#sec-pipelines-bagging"><span>Section&nbsp;8.3.1</span></a>:</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-005_c99c738246cc24206350613e6d4af442">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">selector_remove_one_prob_column</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">class_removing</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">class_names</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">selector_use</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_invert</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="va">class_removing</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">selector_use</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using this selector in <a href="../chapter8/non-sequential_pipelines_and_tuning.html#sec-pipelines-stack"><span>Section&nbsp;8.3.2</span></a>, one could use the resulting stacking learner on any classification task with arbitrary target classes.</p>
<ol start="3" type="1">
<li>As the first hint states, two <code>po("imputelearner")</code> objects are necessary: one to impute missing values in factor columns using a classification learner, and another to impute missing values in numeric columns using a regression learner. Additionally, <code>ppl("robustify")</code> is used along with the <a href="https://www.rdocumentation.org/packages/ranger/topics/ranger"><code>ranger</code></a>-based learners inside <code>po("imputelearner")</code> because the data passed to the imputation learners still contains missing values, which <code><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger::ranger</a></code> cannot handle.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/pipelines-006_3fa6992f8ab2c7a1c2e838d9b4830f58">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr_impute_factors</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputelearner"</span>, id <span class="op">=</span> <span class="st">"impute_factors"</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span>,</span>
<span>  affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"factor"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gr_impute_numerics</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputelearner"</span>, id <span class="op">=</span> <span class="st">"impute_numerics"</span>,</span>
<span>  learner <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span>,</span>
<span>  affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"numeric"</span>, <span class="st">"integer"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr_impute</span> <span class="op">=</span> <span class="va">gr_impute_numerics</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">gr_impute_factors</span></span>
<span></span>
<span><span class="va">imputed</span> <span class="op">=</span> <span class="va">gr_impute</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># e.g. see how row 4 was imputed</span></span>
<span><span class="co"># original:</span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   species bill_depth bill_length body_mass flipper_length    island
1:  Adelie         NA          NA        NA             NA Torgersen
    sex
1: &lt;NA&gt;
1 variable not shown: [year]</code></pre>
</div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># imputed:</span></span>
<span><span class="va">imputed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   species    island year bill_depth bill_length body_mass
1:  Adelie Torgersen 2007         19       41.67      4278
2 variables not shown: [flipper_length, sex]</code></pre>
</div>
</div>
</section><section id="solutions-for-sec-preprocessing" class="level2" data-number="A.8"><h2 data-number="A.8" class="anchored" data-anchor-id="solutions-for-sec-preprocessing">
<span class="header-section-number">A.8</span> Solutions for <a href="../chapter9/preprocessing.html"><span>Chapter&nbsp;9</span></a>
</h2>
<p>We will consider a similar prediction problem as throughout this section, using the King County Housing data instead (available with <code>tsk("kc_housing")</code>). To evaluate the models, we again use 10-fold cv and the mean absolute error. The learner we want to use is a elastic-net regression by <code>lrn("regr.glmnet")</code>. For now we will ignore the <code>date</code> column and simply remove it:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-15_700bf62d14c294fbbce1d2323f314533">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kc_housing</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"kc_housing"</span><span class="op">)</span></span>
<span><span class="va">kc_housing</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">kc_housing</span><span class="op">$</span><span class="va">feature_names</span>, <span class="st">"date"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Have a look at the features, are there any features which might be problematic? If so, change or remove them.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-16_c5c2a4b85b3f03d0605b74791c9ce0fb">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">kc_housing</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     price           bathrooms       bedrooms       condition   
 Min.   :  75000   Min.   :0.00   Min.   : 0.00   Min.   :1.00  
 1st Qu.: 321950   1st Qu.:1.75   1st Qu.: 3.00   1st Qu.:3.00  
 Median : 450000   Median :2.25   Median : 3.00   Median :3.00  
 Mean   : 540088   Mean   :2.12   Mean   : 3.37   Mean   :3.41  
 3rd Qu.: 645000   3rd Qu.:2.50   3rd Qu.: 4.00   3rd Qu.:4.00  
 Max.   :7700000   Max.   :8.00   Max.   :33.00   Max.   :5.00  
                                                                
     floors         grade            lat            long     
 Min.   :1.00   Min.   : 1.00   Min.   :47.2   Min.   :-123  
 1st Qu.:1.00   1st Qu.: 7.00   1st Qu.:47.5   1st Qu.:-122  
 Median :1.50   Median : 7.00   Median :47.6   Median :-122  
 Mean   :1.49   Mean   : 7.66   Mean   :47.6   Mean   :-122  
 3rd Qu.:2.00   3rd Qu.: 8.00   3rd Qu.:47.7   3rd Qu.:-122  
 Max.   :3.50   Max.   :13.00   Max.   :47.8   Max.   :-121  
                                                             
   sqft_above   sqft_basement    sqft_living    sqft_living15 
 Min.   : 290   Min.   :  10    Min.   :  290   Min.   : 399  
 1st Qu.:1190   1st Qu.: 450    1st Qu.: 1427   1st Qu.:1490  
 Median :1560   Median : 700    Median : 1910   Median :1840  
 Mean   :1788   Mean   : 742    Mean   : 2080   Mean   :1987  
 3rd Qu.:2210   3rd Qu.: 980    3rd Qu.: 2550   3rd Qu.:2360  
 Max.   :9410   Max.   :4820    Max.   :13540   Max.   :6210  
                NA's   :13126                                 
    sqft_lot         sqft_lot15          view       waterfront     
 Min.   :    520   Min.   :   651   Min.   :0.000   Mode :logical  
 1st Qu.:   5040   1st Qu.:  5100   1st Qu.:0.000   FALSE:21450    
 Median :   7618   Median :  7620   Median :0.000   TRUE :163      
 Mean   :  15107   Mean   : 12768   Mean   :0.234                  
 3rd Qu.:  10688   3rd Qu.: 10083   3rd Qu.:0.000                  
 Max.   :1651359   Max.   :871200   Max.   :4.000                  
                                                                   
    yr_built     yr_renovated      zipcode     
 Min.   :1900   Min.   :1934    Min.   :98001  
 1st Qu.:1951   1st Qu.:1987    1st Qu.:98033  
 Median :1975   Median :2000    Median :98065  
 Mean   :1971   Mean   :1996    Mean   :98078  
 3rd Qu.:1997   3rd Qu.:2007    3rd Qu.:98118  
 Max.   :2015   Max.   :2015    Max.   :98199  
                NA's   :20699                  </code></pre>
</div>
</div>
<p><code>zipcode</code> should not really be interpreted as a numeric value, so we cast it to a factor. We could argue to remove <code>lat</code> and <code>long</code> as handling them as linear effects is not necessarily a suitable, but we will keep them since <code>glmnet</code> performs internal feature selection anyways.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-17_0a0707ee7a5d3cac029502bb32dee709">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">zipencode</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>, mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>zipcode <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">zipcode</span><span class="op">)</span><span class="op">)</span>, id <span class="op">=</span> <span class="st">"zipencode"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Check the dataset and learner properties to understand which preprocessing steps you need to do.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-18_4ab750666279b8dd83d59c6e89d473fa">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">kc_housing</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskRegr:kc_housing&gt; (21613 x 19): King County House Sales
* Target: price
* Properties: -
* Features (18):
  - int (13): bedrooms, condition, grade, sqft_above,
    sqft_basement, sqft_living, sqft_living15, sqft_lot,
    sqft_lot15, view, yr_built, yr_renovated, zipcode
  - dbl (4): bathrooms, floors, lat, long
  - lgl (1): waterfront</code></pre>
</div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kc_housing</span><span class="op">$</span><span class="fu">missings</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        price     bathrooms      bedrooms     condition        floors 
            0             0             0             0             0 
        grade           lat          long    sqft_above sqft_basement 
            0             0             0             0         13126 
  sqft_living sqft_living15      sqft_lot    sqft_lot15          view 
            0             0             0             0             0 
   waterfront      yr_built  yr_renovated       zipcode 
            0             0         20699             0 </code></pre>
</div>
</div>
<p>The data has missings and a categorical feature (since we are encoding the zipcode as a factor).</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-19_f5e07a1f4a99db1b29ad04182955ff6f">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glmnet</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.glmnet"</span><span class="op">)</span></span>
<span><span class="va">glmnet</span><span class="op">$</span><span class="va">properties</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "weights"</code></pre>
</div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glmnet</span><span class="op">$</span><span class="va">feature_types</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "logical" "integer" "numeric"</code></pre>
</div>
</div>
<p><code>glmnet</code> does not support factors or missing values. So our pipeline needs to handle both.</p>
<ol start="3" type="1">
<li>Build a suitable pipeline that allows glmnet to be trained on the dataset.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-20_076e0d7e7320e8087905f5ebe4fa1be8">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glmnet_preproc</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html">GraphLearner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">zipencode</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"fixfactors"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"encodeimpact"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"missind"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"integer"</span>,</span>
<span>        affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputehist"</span>,</span>
<span>        affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"integer"</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"featureunion"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"imputeoor"</span>,</span>
<span>        affect_columns <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html">selector_type</a></span><span class="op">(</span><span class="st">"factor"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="va">glmnet</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"regr.glmnet_preproc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_glmnet_preproc</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"targettrafo"</span>, graph <span class="op">=</span> <span class="va">glmnet_preproc</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_preproc</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">targetmutate.trafo</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_preproc</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">targetmutate.inverter</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">response</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_preproc</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html">GraphLearner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">log_glmnet_preproc</span>, id <span class="op">=</span> <span class="st">"regr.log_glmnet_preproc"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we fix the factor levels to ensure that all 70 zipcodes are fixed. We can consider 70 levels high cardinality, so we use impact encoding. We use the same imputation strategy as in <a href="../chapter9/preprocessing.html"><span>Chapter&nbsp;9</span></a>. Since the target is highly skewed, we also apply a log-transformation of the target.</p>
<ol start="4" type="1">
<li>As a comparison, apply <code>pipeline_robustify</code> to glmnet and compare the results with your pipeline.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-21_fd0b9934a65cc2fbc39e71eefe0490f9">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glmnet_robustify</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html">GraphLearner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="va">zipencode</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_graphs_robustify.html">pipeline_robustify</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>      <span class="va">glmnet</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"regr.glmnet_robustify"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_glmnet_robustify</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"targettrafo"</span>, graph <span class="op">=</span> <span class="va">glmnet_robustify</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_robustify</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">targetmutate.trafo</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_robustify</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">targetmutate.inverter</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">response</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">log_glmnet_robustify</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html">GraphLearner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">log_glmnet_robustify</span>, id <span class="op">=</span> <span class="st">"regr.log_glmnet_robustify"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.featureless"</span>, robust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="va">glmnet_preproc</span>,</span>
<span>  <span class="va">log_glmnet_preproc</span>,</span>
<span>  <span class="va">glmnet_robustify</span>,</span>
<span>  <span class="va">log_glmnet_robustify</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123L</span><span class="op">)</span></span>
<span><span class="va">cv10</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span></span>
<span><span class="va">cv10</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="va">kc_housing</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">kc_housing</span>, learners <span class="op">=</span> <span class="va">learners</span>, <span class="va">cv10</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">learner_id</span>, <span class="va">regr.mae</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  learner_id regr.mae
1:          regr.featureless   221817
2:       regr.glmnet_preproc   101229
3:   regr.log_glmnet_preproc    84477
4:     regr.glmnet_robustify    96478
5: regr.log_glmnet_robustify    84958</code></pre>
</div>
</div>
<p>The log-transformed <code>glmnet</code> with impact encoding results in the best model, although only by a very small margin.</p>
<ol start="5" type="1">
<li>Consider the <code>date</code> feature: How can you extract information from this feature that <code>glmnet</code> can use? Check how much this improves your pipeline. Also consider the spatial nature of the dataset: Can you extract an additional feature from the lat/long coordinates? (Hint: Downtown Seattle has lat/long coordinates <code>47.605</code>/<code>-122.334</code>).</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-22_055e21075230665217b98de8ec1843d4">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">extractors</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>, mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>  distance_downtown <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fl">47.605</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">long</span>  <span class="op">+</span> <span class="fl">122.334</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">kc_housing_full</span> <span class="op">=</span> <span class="va">extractors</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"kc_housing"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">kc_housing_full</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"kc_housing_feat_extr"</span></span>
<span></span>
<span></span>
<span><span class="va">design_ext</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">kc_housing_full</span>, learners <span class="op">=</span> <span class="va">learners</span>, <span class="va">cv10</span><span class="op">)</span></span>
<span><span class="va">bmr_ext</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design_ext</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">combine</span><span class="op">(</span><span class="va">bmr_ext</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">learner_id</span>, <span class="va">task_id</span>, <span class="va">regr.mae</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   learner_id              task_id regr.mae
 1:          regr.featureless           kc_housing   221817
 2:       regr.glmnet_preproc           kc_housing   101229
 3:   regr.log_glmnet_preproc           kc_housing    84477
 4:     regr.glmnet_robustify           kc_housing    96478
 5: regr.log_glmnet_robustify           kc_housing    84958
 6:          regr.featureless kc_housing_feat_extr   221817
 7:       regr.glmnet_preproc kc_housing_feat_extr   100228
 8:   regr.log_glmnet_preproc kc_housing_feat_extr    82832
 9:     regr.glmnet_robustify kc_housing_feat_extr    95458
10: regr.log_glmnet_robustify kc_housing_feat_extr    84444</code></pre>
</div>
</div>
<p>We simply convert the <code>date</code> feature into a numeric timestamp so that <code>glmnet</code> can handle the feature. We create one additional feature as the distance to downtown Seattle. This improves the average error of our model by a further 1600$.</p>
</section><section id="solutions-to-sec-special" class="level2" data-number="A.9"><h2 data-number="A.9" class="anchored" data-anchor-id="solutions-to-sec-special">
<span class="header-section-number">A.9</span> Solutions to <a href="../chapter13/beyond_regression_and_classification.html"><span>Chapter&nbsp;13</span></a>
</h2>
<ol type="1">
<li>Run a benchmark experiment on the <code>"german_credit"</code> task with algorithms: <code>lrn("classif.featureless")</code>, <code>lrn("classif.log_reg")</code>, <code>lrn("classif.ranger")</code>. Tune the <code>lrn("classif.featureless")</code> model using <code>tunetreshold</code> and <code>learner_cv</code>. Use two-fold CV and evaluate with <code>msr("classif.costs", costs = costs)</code> where you should make the parameter <code>costs</code> so that the cost of a true positive is -10, the cost of a true negative is -1, the cost of a false positive is 2, and the cost of a false negative is 3. Use <code>set.seed(11)</code> to make sure you get the same results as us. Are your results surprising?</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-017_12dcd7e0e5cf3bb428891f5efebd5804">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">costs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, dimnames <span class="op">=</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Predicted Credit"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span>,</span>
<span>    Truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">msr_costs</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.costs"</span>, costs <span class="op">=</span> <span class="va">costs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.featureless"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"tunethreshold"</span>, measure <span class="op">=</span> <span class="va">msr_costs</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"german_credit"</span><span class="op">)</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">msr_costs</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          learner_id classif.costs
1: classif.featureless.tunethreshold        -6.400
2:                   classif.log_reg        -5.420
3:                    classif.ranger        -5.923</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Train and predict a survival forest using <code>rfsrc</code> (from <code>mlr3extralearners</code>). Run this experiment using <code>task = tsk("rats"); split = partition(task)</code>. Evaluate your model with the RCLL measure.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-018_b2d308a14a98dd3865abfc1867dc6ed9">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3proba.mlr-org.com">mlr3proba</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mlr3extralearners</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"rats"</span><span class="op">)</span></span>
<span><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/partition.html">partition</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.rfsrc"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">train</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">test</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"surv.rcll"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>surv.rcll 
    4.031 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Estimate the density of the <code>tsk("precip")</code> data using <code>lrn("dens.logspline")</code> (from <code>mlr3extralearners</code>). Run this experiment using <code>task = tsk("precip"); split = partition(task)</code>. Evaluate your model with the logloss measure.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-019_79bb677eedf646c29e5bade5e3b0048f">
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3proba.mlr-org.com">mlr3proba</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mlr3extralearners</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"precip"</span><span class="op">)</span></span>
<span><span class="va">split</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/partition.html">partition</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"dens.logspline"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">train</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">train</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, <span class="va">split</span><span class="op">$</span><span class="va">test</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">score</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"dens.logloss"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dens.logloss 
       3.979 </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Run a benchmark clustering experiment on the <code>wine</code> dataset without a label column. Compare the performance of <code>"clust.kmeans"</code> learner with <code>k</code> equal to 2, 3 and 4 using the silhouette measure. Use insample resampling technique. What value of <code>k</code> would you choose based on the silhouette scores?</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-020_2d98ac5bbace19bfd76bd50aaac367d1">
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3cluster.mlr-org.com">mlr3cluster</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">2L</span>, id <span class="op">=</span> <span class="st">"k-means, k=2"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">3L</span>, id <span class="op">=</span> <span class="st">"k-means, k=3"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">4L</span>, id <span class="op">=</span> <span class="st">"k-means, k=4"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3cluster.mlr-org.com/reference/as_task_clust.html">as_task_clust</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"wine"</span><span class="op">)</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"clust.silhouette"</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"insample"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">measure</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     learner_id clust.silhouette
1: k-means, k=2           0.6569
2: k-means, k=3           0.5711
3: k-means, k=4           0.5606</code></pre>
</div>
</div>
<p>Based on the silhouette score, we can choose <code>k = 2</code>.</p>
<ol start="5" type="1">
<li>Run a (spatially) unbiased classification benchmark experiment on the <code>"ecuador"</code> task with a featureless learner and xgboost, evaluate with the binary Brier score.</li>
</ol>
<p>You can use any resampling method from <a href="https://mlr3spatiotempcv.mlr-org.com"><code>mlr3spatiotempcv</code></a>, in this solution we use 4-fold spatial environmental blocking.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-021_80b1dd03f29dee1a29753c49954155ca">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3spatial.mlr-org.com">mlr3spatial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3spatiotempcv.mlr-org.com/">mlr3spatiotempcv</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'mlr3spatiotempcv'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:mlr3spatial':

    as_task_classif_st, as_task_classif_st.data.frame,
    as_task_classif_st.DataBackend, as_task_classif_st.sf,
    as_task_classif_st.TaskClassifST, as_task_regr_st,
    as_task_regr_st.data.frame, as_task_regr_st.DataBackend,
    as_task_regr_st.sf, as_task_regr_st.TaskClassifST,
    as_task_regr_st.TaskRegrST, TaskClassifST, TaskRegrST</code></pre>
</div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"classif."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"xgboost"</span>, <span class="st">"featureless"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">rsmp_sp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"spcv_env"</span>, folds <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"ecuador"</span><span class="op">)</span>, <span class="va">learners</span>, <span class="va">rsmp_sp</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.bbrier"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            learner_id classif.bbrier
1:     classif.xgboost         0.2303
2: classif.featureless         0.2413</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-technical" class="level2" data-number="A.10"><h2 data-number="A.10" class="anchored" data-anchor-id="solutions-to-sec-technical">
<span class="header-section-number">A.10</span> Solutions to <a href="../chapter10/advanced_technical_aspects_of_mlr3.html"><span>Chapter&nbsp;10</span></a>
</h2>
<ol type="1">
<li>Consider the following example where you resample a learner (debug learner, sleeps for 3 seconds during train) on 4 workers using the multisession backend:</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/technical-050_3f65ff5e0f5f1502630575fa1f3f7ea7">
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.debug"</span>, sleep_train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="i">
<li>Assuming that the learner would actually calculate something and not just sleep: Would all CPUs be busy?</li>
<li>Prove your point by measuring the elapsed time, e.g., using <a href="https://www.rdocumentation.org/packages/base/topics/system.time"><code>system.time()</code></a>.</li>
<li>What would you change in the setup and why?</li>
</ol>
<p>Not all CPUs would be utilized in the example. All 4 of them are occupied for the first 4 iterations of the cross validation. The 5th iteration, however, only runs in parallel to the 6th fold, leaving 2 cores idle. This is supported by the elapsed time of roughly 6 seconds for 6 jobs compared to also roughly 6 seconds for 8 jobs:</p>
<div class="cell" data-hash="solutions_cache/html/solutions-022_7ec8ba3af8c27abb6479c798ea4f51b8">
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.debug"</span>, sleep_train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="va">resampling</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If possible, the number of resampling iterations should be an integer multiple of the number of workers. Therefore, a simple adaptation either increases the number of folds for improved accuracy of the error estimate or reduces the number of folds for improved runtime.</p>
<ol start="2" type="1">
<li>Create a new custom classification measure (either using methods demonstrated in <a href="../chapter10/advanced_technical_aspects_of_mlr3.html#sec-extending"><span>Section&nbsp;10.5</span></a> or with <code>msr("classif.costs")</code> which scores predictions using the mean over the following classification costs:</li>
</ol>
<ul>
<li>If the learner predicted label “A” and the truth is “A”, assign score 0</li>
<li>If the learner predicted label “B” and the truth is “B”, assign score 0</li>
<li>If the learner predicted label “A” and the truth is “B”, assign score 1</li>
<li>If the learner predicted label “B” and the truth is “A”, assign score 10</li>
</ul>
<p>The rules can easily be translated to R code where we expect <code>truth</code> and <code>prediction</code> to be factor vectors of the same length with levels <code>"A"</code> and <code>"B"</code>:</p>
<div class="cell" data-hash="solutions_cache/html/solutions-023_1607c766a96933a45baaf8f3474ee385">
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">costsens</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">score</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">score</span><span class="op">[</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">prediction</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="va">score</span><span class="op">[</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">prediction</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function can be embedded in the <code>Measure</code> class accordingly.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-024_1137c792419833fa04952a79e808a05c">
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">MeasureCustom</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"MeasureCustom"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="va"><a href="https://mlr3.mlr-org.com/reference/MeasureClassif.html">MeasureClassif</a></span>, <span class="co"># classification measure</span></span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span> <span class="co"># initialize class</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span></span>
<span>        id <span class="op">=</span> <span class="st">"custom"</span>, <span class="co"># unique ID</span></span>
<span>        packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># no dependencies</span></span>
<span>        properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># no special properties</span></span>
<span>        predict_type <span class="op">=</span> <span class="st">"response"</span>, <span class="co"># measures response prediction</span></span>
<span>        range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">Inf</span><span class="op">)</span>, <span class="co"># results in values between (0, 1)</span></span>
<span>        minimize <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># smaller values are better</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    .score <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="co"># define score as private method</span></span>
<span>      <span class="co"># define loss</span></span>
<span>      <span class="va">costsens</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">score</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">score</span><span class="op">[</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"A"</span> <span class="op">&amp;</span> <span class="va">prediction</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">10</span></span>
<span>        <span class="va">score</span><span class="op">[</span><span class="va">truth</span> <span class="op">==</span> <span class="st">"B"</span> <span class="op">&amp;</span> <span class="va">prediction</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># call loss function</span></span>
<span>      <span class="fu">costsens</span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">$</span><span class="va">response</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An alternative (as pointed to by the hint) can be constructed by first translating the rules to a matrix of misclassification costs, and then feeding this matrix to the constructor of <code>msr("classif.costs")</code>:</p>
<div class="cell" data-hash="solutions_cache/html/solutions-025_458c8d3add817be0a9d9b064efa0fec7">
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># truth in columns, prediction in rows</span></span>
<span><span class="va">C</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span></span>
<span><span class="va">C</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   A B
A  0 1
B 10 0</code></pre>
</div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.costs"</span>, costs <span class="op">=</span> <span class="va">C</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MeasureClassifCosts:classif.costs&gt;: Cost-sensitive Classification
* Packages: mlr3
* Range: [0, Inf]
* Minimize: TRUE
* Average: macro
* Parameters: normalize=TRUE
* Properties: -
* Predict type: response</code></pre>
</div>
</div>
</section><section id="solutions-to-sec-large-benchmarking" class="level2" data-number="A.11"><h2 data-number="A.11" class="anchored" data-anchor-id="solutions-to-sec-large-benchmarking">
<span class="header-section-number">A.11</span> Solutions to <a href="../chapter11/large-scale_benchmarking.html"><span>Chapter&nbsp;11</span></a>
</h2>
<ol type="1">
<li>Load the OpenML collection with ID 269, which contains regression tasks from the AutoML benchmark <span class="citation" data-cites="amlb2022">(<a href="../references.html#ref-amlb2022" role="doc-biblioref">Gijsbers et al. 2022</a>)</span>.</li>
</ol>
<p>We access the AutoML benchmark suite with ID 269 using the <a href="https://mlr3oml.mlr-org.com/reference/ocl.html"><code>ocl()</code></a> function.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-028_2992354f21a567a549dda12947855454">
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3oml.mlr-org.com">mlr3oml</a></span><span class="op">)</span></span>
<span><span class="va">automl_suite</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3oml.mlr-org.com/reference/oml_sugar.html">ocl</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">269</span><span class="op">)</span></span>
<span><span class="va">automl_suite</span><span class="op">$</span><span class="va">task_ids</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 167210 233211 233212 233213 233214 233215 317614 359929 359930
[10] 359931 359932 359933 359934 359935 359936 359937 359938 359939
[19] 359940 359941 359942 359943 359944 359945 359946 359948 359949
[28] 359950 359951 359952 360932 360933 360945</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Find all tasks with less than 4000 observations and convert them to <code>mlr3</code> tasks.</li>
</ol>
<p>We can find all tasks with less than 4000 observations by specifying this constraint in <a href="https://mlr3oml.mlr-org.com/reference/list_oml_tasks.html"><code>list_oml_tasks()</code></a>.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-030_00d6112cc13b1317b16843e2e84e3d56">
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tbl</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3oml.mlr-org.com/reference/list_oml.html">list_oml_tasks</a></span><span class="op">(</span></span>
<span>  task_id <span class="op">=</span> <span class="va">automl_suite</span><span class="op">$</span><span class="va">task_ids</span>, number_instances <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4000</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This returns a table which only contains matching tasks from the AutoML benchmark.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-032_ed23d2348507f3d4c24a6c5181d69151">
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tbl</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">task_id</span>, <span class="va">data_id</span>, <span class="va">name</span>, <span class="va">NumberOfInstances</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    task_id data_id                 name NumberOfInstances
 1:  167210   41021            Moneyball              1232
 2:  359930     550                quake              2178
 3:  359931     546              sensory               576
 4:  359932     541               socmob              1156
 5:  359933     507             space_ga              3107
 6:  359934     505              tecator               240
 7:  359945   42730             us_crime              1994
 8:  359950     531               boston               506
 9:  359951   42563 house_prices_nominal              1460
10:  360945   43071  MIP-2016-regression              1090</code></pre>
</div>
</div>
<p>We can create <code>mlr3</code> tasks from these OpenML IDs using <code>tsk("oml")</code>.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-033_c41404fd714551a94467dbcb3a05de0c">
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tasks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">$</span><span class="va">task_id</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"oml"</span>, task_id <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Create an experimental design that compares <code>regr.ranger</code> to <code>regr.rpart</code>, use the robustify pipeline for both learners and a featureless fallback learner. Use three-fold cross-validation instead of the OpenML resamplings.</li>
</ol>
<p>Below, we define the robustified learners with a featureless fallback learner.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-034_c5b5069ddc801788a0c14f7658c6d538">
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lrn_ranger</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lrn_ranger</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"ranger"</span></span>
<span><span class="va">lrn_ranger</span><span class="op">$</span><span class="va">fallback</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.featureless"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lrn_rpart</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"robustify"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">lrn_rpart</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="st">"rpart"</span></span>
<span><span class="va">lrn_rpart</span><span class="op">$</span><span class="va">fallback</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.featureless"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn_ranger</span>, <span class="va">lrn_rpart</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we create the experimental design using <a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html"><code>benchmark_grid()</code></a>.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-035_d7d210082733583d395a16f369b82509">
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># we set the seed, as benchmark_grid instantiates the resamplings</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tasks</span>, <span class="va">learners</span>, <span class="va">resampling</span><span class="op">)</span></span>
<span><span class="va">design</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    task learner resampling
 1:            Moneyball  ranger         cv
 2:            Moneyball   rpart         cv
 3:                quake  ranger         cv
 4:                quake   rpart         cv
 5:              sensory  ranger         cv
---                                        
16:               boston   rpart         cv
17: house_prices_nominal  ranger         cv
18: house_prices_nominal   rpart         cv
19:  MIP-2016-regression  ranger         cv
20:  MIP-2016-regression   rpart         cv</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Create a registry and populate it with the experiments. Optionally: change the cluster function to either “Socket” or “Multicore” (the latter does not work on Windows).</li>
</ol>
<p>We start with loading the relevant libraries and creating a registry. By specifying the registry’s <code>file.dir</code> to <code>NA</code> we are using a temporary directory.</p>
<div class="cell">
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https:///mlr3batchmark.mlr-org.com">mlr3batchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mllg/batchtools">batchtools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/makeExperimentRegistry.html">makeExperimentRegistry</a></span><span class="op">(</span></span>
<span>  file.dir <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  packages <span class="op">=</span> <span class="st">"mlr3verse"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No readable configuration file found</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Created registry in '/tmp/RtmpNVR0BP/registry375d443618bb' using cluster functions 'Interactive'</code></pre>
</div>
</div>
<p>Then, we change the cluster function to “Multicore” (or “Socket” if you are on Windows).</p>
<div class="cell">
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mac and Linux</span></span>
<span><span class="va">reg</span><span class="op">$</span><span class="va">cluster.functions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/makeClusterFunctionsMulticore.html">makeClusterFunctionsMulticore</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-detected 2 CPUs</code></pre>
</div>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Windows:</span></span>
<span><span class="va">reg</span><span class="op">$</span><span class="va">cluster.functions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/makeClusterFunctionsSocket.html">makeClusterFunctionsSocket</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-detected 2 CPUs</code></pre>
</div>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/saveRegistry.html">saveRegistry</a></span><span class="op">(</span><span class="va">reg</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<ol start="5" type="1">
<li>Submit the jobs and once they are finished, collect the results.</li>
</ol>
<p>The next two steps are to populate the registry with the experiments using <code><a href="https:///mlr3batchmark.mlr-org.com/reference/batchmark.html">batchmark()</a></code> and to submit them. By specifying no IDs in <code><a href="https://rdrr.io/pkg/batchtools/man/submitJobs.html">submitJobs()</a></code>, all jobs returned by <code><a href="https://rdrr.io/pkg/batchtools/man/findJobs.html">findNotSubmitted()</a></code> are queued, which in this case are all existing jobs.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-038_2fe70de816d62f77f5d59dde69e2fbee">
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https:///mlr3batchmark.mlr-org.com/reference/batchmark.html">batchmark</a></span><span class="op">(</span><span class="va">design</span>, reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/submitJobs.html">submitJobs</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/batchtools/man/waitForJobs.html">waitForJobs</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After the execution of the experiment finished, we can collect the results like below.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-040_502decf3bdde3fc81a76d41704129889">
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https:///mlr3batchmark.mlr-org.com/reference/reduceResultsBatchmark.html">reduceResultsBatchmark</a></span><span class="op">(</span>reg <span class="op">=</span> <span class="va">reg</span><span class="op">)</span></span>
<span><span class="va">bmr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BenchmarkResult&gt; of 60 rows with 20 resampling runs
    nr              task_id learner_id resampling_id iters warnings
     1            Moneyball     ranger            cv     3        0
     2            Moneyball      rpart            cv     3        0
     3                quake     ranger            cv     3        0
     4                quake      rpart            cv     3        0
     5              sensory     ranger            cv     3        0
---                                                                
    16               boston      rpart            cv     3        0
    17 house_prices_nominal     ranger            cv     3        0
    18 house_prices_nominal      rpart            cv     3        0
    19  MIP-2016-regression     ranger            cv     3        0
    20  MIP-2016-regression      rpart            cv     3        0
    errors
         0
         0
         0
         0
         0
---       
         0
         0
         0
         0
         0</code></pre>
</div>
</div>
<ol start="6" type="1">
<li>Conduct a global Friedman test and interpret the results using <code>regr.mse</code>. Why do we not need to use the post-hoc test?</li>
</ol>
<p>As a first step, we load <a href="https://mlr3benchmark.mlr-org.com"><code>mlr3benchmark</code></a> and create a benchmark aggregate using <code>msr("regr.mse")</code>.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-041_cc903ea9c5ad72618956a111f82339aa">
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3benchmark.mlr-org.com">mlr3benchmark</a></span><span class="op">)</span></span>
<span><span class="va">bma</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3benchmark.mlr-org.com/reference/as_benchmark_aggr.html">as_benchmark_aggr</a></span><span class="op">(</span><span class="va">bmr</span>, measures <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bma</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BenchmarkAggr&gt; of 20 rows with 10 tasks, 2 learners and 1 measure
                 task_id learner_id       mse
 1:            Moneyball     ranger 6.167e+02
 2:            Moneyball      rpart 1.357e+03
 3:                quake     ranger 3.827e-02
 4:                quake      rpart 3.567e-02
 5:              sensory     ranger 5.072e-01
---                                          
16:               boston      rpart 2.293e+01
17: house_prices_nominal     ranger 9.020e+08
18: house_prices_nominal      rpart 1.949e+09
19:  MIP-2016-regression     ranger 7.505e+08
20:  MIP-2016-regression      rpart 6.277e+08</code></pre>
</div>
</div>
<p>We can now use the <code>$friedman_test()</code> method to apply the test to the experiment results. We do not need a post-hoc test, because we are only comparing two algorithms.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-042_c47bf5f6671ed0c48b6c3a334801e506">
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bma</span><span class="op">$</span><span class="fu">friedman_test</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Friedman rank sum test

data:  mse and learner_id and task_id
Friedman chi-squared = 1.6, df = 1, p-value = 0.2</code></pre>
</div>
</div>
<p>This experimental design was not able to detect a significant difference on the 5% level so we cannot reject our null hypothesis that the regression tree performs equally well as the random forest.</p>
<ol type="1">
<li>Inspect the ranks of the results.</li>
</ol>
<p>We inspect the ranks using the <code>$rank_data()</code> method of the <a href="https://mlr3benchmark.mlr-org.com/reference/BenchmarkAggr.html"><code>BenchmarkAggr</code></a>, where we specify <code>minimize</code> to <code>TRUE</code>, because a lower mean square error is better.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-043_c097d71e77d4ef5a56f32f5e130235ca">
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bma</span><span class="op">$</span><span class="fu">rank_data</span><span class="op">(</span>minimize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Moneyball quake sensory socmob space_ga tecator us_crime boston
ranger         1     2       1      1        1       2        1      1
rpart          2     1       2      2        2       1        2      2
       house_prices_nominal MIP-2016-regression
ranger                    1                   2
rpart                     2                   1</code></pre>
</div>
</div>
<p>The random forest is better on 7 of the 10 tasks.</p>
</section><section id="solutions-to-sec-interpretation" class="level2" data-number="A.12"><h2 data-number="A.12" class="anchored" data-anchor-id="solutions-to-sec-interpretation">
<span class="header-section-number">A.12</span> Solutions to <a href="../chapter12/model_interpretation.html"><span>Chapter&nbsp;12</span></a>
</h2>
<ol type="1">
<li>Prepare a <code>mlr3</code> regression task for <code>fifa</code> data. Select only variables describing the age and skills of footballers. Train any predictive model for this task, e.g.&nbsp;<code>lrn("regr.ranger")</code>.</li>
</ol>
<div class="cell" data-hash="solutions_cache/html/solutions-044_54cdf796fe6e2451a65028f1f289ed9d">
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/">DALEX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"fifa"</span>, package <span class="op">=</span> <span class="st">"DALEX"</span><span class="op">)</span></span>
<span><span class="va">old_theme</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/theme_dalex.html">set_theme_dalex</a></span><span class="op">(</span><span class="st">"ema"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fifa20</span> <span class="op">=</span> <span class="va">fifa</span><span class="op">[</span>,<span class="fl">5</span><span class="op">:</span><span class="fl">42</span><span class="op">]</span></span>
<span><span class="va">task_fifa</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html">as_task_regr</a></span><span class="op">(</span><span class="va">fifa20</span>, target <span class="op">=</span> <span class="st">"value_eur"</span>, id <span class="op">=</span> <span class="st">"fifa20"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_fifa</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      case.weights = task$weights$weight, num.threads = 1L) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      5000 
Number of independent variables:  37 
Mtry:                             6 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       1.023e+13 
R squared (OOB):                  0.8699 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use the permutation importance method to calculate variable importance ranking. Which variable is the most important? Is it surprising?</li>
</ol>
<p><strong>With <code>iml</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-045_45d29705ae43536c5c7a9ed18b09a29d">
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://christophm.github.io/iml/">iml</a></span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Predictor.html">Predictor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">learner</span>,</span>
<span>                data <span class="op">=</span> <span class="va">fifa20</span>,</span>
<span>                y <span class="op">=</span> <span class="va">fifa</span><span class="op">$</span><span class="va">value_eur</span><span class="op">)</span></span>
<span></span>
<span><span class="va">effect</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureImp.html">FeatureImp</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>,</span>
<span>                loss <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span><span class="va">effect</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-045-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-046_0c0fca3b9bc579cef04ad8a847401fb4">
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/">DALEX</a></span><span class="op">)</span></span>
<span><span class="va">ranger_exp</span> <span class="op">=</span> <span class="fu">DALEX</span><span class="fu">::</span><span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/explain.html">explain</a></span><span class="op">(</span><span class="va">learner</span>,</span>
<span>  data <span class="op">=</span> <span class="va">fifa20</span>,</span>
<span>  y <span class="op">=</span> <span class="va">fifa</span><span class="op">$</span><span class="va">value_eur</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"Fifa 2020"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_effect</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts</a></span><span class="op">(</span><span class="va">ranger_exp</span>, B <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ranger_effect</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             variable mean_dropout_loss     label
1        _full_model_           1402526 Fifa 2020
2           value_eur           1402526 Fifa 2020
3           weight_kg           1471865 Fifa 2020
4 goalkeeping_kicking           1472795 Fifa 2020
5           height_cm           1474859 Fifa 2020
6    movement_balance           1475618 Fifa 2020</code></pre>
</div>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_effect</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-046-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<ol start="3" type="1">
<li>Use the Partial Dependence profile to draw the global behavior of the model for this variable. Is it aligned with your expectations?</li>
</ol>
<p><strong>With <code>iml</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-047_4c6b136823a8e8763446e59104d3cc24">
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">effect</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/FeatureEffects.html">FeatureEffects</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">effect</span>, features <span class="op">=</span> <span class="va">num_features</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-047-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-048_88ac01ea4e6f33c874ea8f22601946a7">
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_profiles</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html">model_profile</a></span><span class="op">(</span><span class="va">ranger_exp</span>, variables <span class="op">=</span> <span class="va">num_features</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_profiles</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-048-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>4 Choose one of the football players. You can choose some well-known striker (e.g.&nbsp;Robert Lewandowski) or a well-known goalkeeper (e.g.&nbsp;Manuel Neuer). The following tasks are worth repeating for several different choices.</p>
<div class="cell" data-hash="solutions_cache/html/solutions-049_72e53c8c03161fbbc49e8b67f11b078b">
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">player_1</span> <span class="op">=</span> <span class="va">fifa</span><span class="op">[</span><span class="st">"R. Lewandowski"</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">42</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>For the selected footballer, calculate and plot the Shapley values. Which variable is locally the most important and has the strongest influence on the valuation of the footballer?</li>
</ol>
<p><strong>With <code>iml</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-050_bbccafbb8e379b56b3c1cc9f634f9af5">
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shapley</span> <span class="op">=</span> <span class="va"><a href="https://christophm.github.io/iml/reference/Shapley.html">Shapley</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">model</span>, x.interest <span class="op">=</span> <span class="va">player_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">shapley</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-050-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-051_634a01aa72962e5769d166e6f91ee8c8">
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ranger_shap</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span><span class="va">ranger_exp</span>,</span>
<span>             new_observation <span class="op">=</span> <span class="va">player_1</span>,</span>
<span>             type <span class="op">=</span> <span class="st">"shap"</span>, B <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_shap</span>, show_boxplots <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-051-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<ol start="6" type="1">
<li>For the selected footballer, calculate the Ceteris Paribus / Individual Conditional Expectation profiles to draw the local behavior of the model for this variable. Is it different from the global behavior?</li>
</ol>
<p><strong>With <code>DALEX</code></strong></p>
<div class="cell" data-hash="solutions_cache/html/solutions-052_25e18e1c085edc27760eedc10128fd1e">
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_features</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranger_ceteris</span> <span class="op">=</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_profile.html">predict_profile</a></span><span class="op">(</span><span class="va">ranger_exp</span>, <span class="va">player_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ranger_ceteris</span>, variables <span class="op">=</span> <span class="va">num_features</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Ceteris paribus for R. Lewandowski"</span>, <span class="st">" "</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/solutions-052-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section><section id="solutions-to-sec-fairness" class="level2" data-number="A.13"><h2 data-number="A.13" class="anchored" data-anchor-id="solutions-to-sec-fairness">
<span class="header-section-number">A.13</span> Solutions to <a href="../chapter14/algorithmic_fairness.html"><span>Chapter&nbsp;14</span></a>
</h2>
<ol type="1">
<li>Load the <code>adult_train</code> task and try to build a first model. Train a simple model and evaluate it on the <code>adult_test</code> task that is also available with <code>mlr3fairness</code>.</li>
</ol>
<p>For now we simply load the data and look at the data.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-28_81aac803a7e58b51b9501d4657ccae19">
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3fairness.mlr-org.com">mlr3fairness</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tsk_adult_train</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"adult_train"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_test</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"adult_test"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:adult_train&gt; (30718 x 13)
* Target: target
* Properties: twoclass
* Features (12):
  - fct (7): education, marital_status, occupation, race,
    relationship, sex, workclass
  - int (5): age, capital_gain, capital_loss, education_num,
    hours_per_week
* Protected attribute: sex</code></pre>
</div>
</div>
<p>We can now train a simple model, e.g., a decision tree and evaluate for accuracy.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-29_2b4cb9a45c887c9d1b0817337bdcc152">
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">tsk_adult_train</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">tsk_adult_test</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
     0.161 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Assume our goal is to achieve parity in <em>false omission rates</em>. Construct a fairness metric that encodes this and againg evaluate your model. Construct a fairness metric that encodes this and evaluate your model. In order to get a deeper understanding, look at the <code>groupwise_metrics</code> function to obtain performance in each group.</li>
</ol>
<p>The metric is available via the key <code>"fairness.fomr"</code>. Note, that evaluating our prediction now requires that we also provide the task.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-30_9f1a5b31959d1328453d3d2cd9e2ea08">
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"fairness.fomr"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_1</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fairness.fomr 
      0.03533 </code></pre>
</div>
</div>
<p>The <code>groupwise_metrics</code> function creates a metric for each group specified in the <code>pta</code> column role:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-31_524a362b1a4db01d37845bbaea6ae9f6">
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="va">col_roles</span><span class="op">$</span><span class="va">pta</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sex"</code></pre>
</div>
</div>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-32_c0b42be1d97accae11b98bb04eaaf144">
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/groupwise_metrics.html">groupwise_metrics</a></span><span class="op">(</span>base_measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.fomr"</span><span class="op">)</span>, task <span class="op">=</span> <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use this metric to evaluate our model again. This gives us the false omission rates for male and female individuals separately.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-33_5741fe15238bcee168e3a181eb1748f6">
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_2</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  subgroup.fomr_Male subgroup.fomr_Female 
              0.2442               0.2089 </code></pre>
</div>
</div>
<ol type="1">
<li>Improve your model by employing pipelines that use pre- or post-processing methods for fairness. Evaluate your model along the two metrics and visualize the results. Compare the different models using an appropriate visualization.</li>
</ol>
<p>First we can again construct the learners above.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-34_46ab8e47ab949c27a32cc1920117ca56">
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a></span><span class="op">)</span></span>
<span><span class="va">lrn_1</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"reweighing_wts"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">lrn_2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"EOd"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And run the benchmark again. Note, that we use three-fold CV this time for comparison.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-35_cac598da19b101055c8f9892e9c009d6">
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">learner</span>, <span class="va">lrn_1</span>, <span class="va">lrn_2</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">tsk_adult_train</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msrs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.acc"</span>, <span class="st">"fairness.fomr"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr     task_id                   learner_id resampling_id iters
1:  1 adult_train                classif.rpart            cv     3
2:  2 adult_train reweighing_wts.classif.rpart            cv     3
3:  3 adult_train            classif.rpart.EOd            cv     3
2 variables not shown: [classif.acc, fairness.fomr]
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>We can now again visualize the result.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-36_39d1769e1fe86e7f308635ab993dfd78">
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/fairness_accuracy_tradeoff.html">fairness_accuracy_tradeoff</a></span><span class="op">(</span><span class="va">bmr</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"fairness.fomr"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_d</a></span><span class="op">(</span><span class="st">"Learner"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="solutions_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<ol type="1">
<li>Add <code>"race"</code> as a second sensitive attribute to your dataset. Add the information to your task and evaluate the initial model again. What changes? Again study the <code>groupwise_metrics</code>.</li>
</ol>
<p>This can be achieved by adding “race” to the <code>"pta"</code> col_role.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-37_5b3c7e80d7504a08f26a8ccf1f345d68">
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_train</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span><span class="st">"race"</span>, add_to <span class="op">=</span> <span class="st">"pta"</span><span class="op">)</span></span>
<span><span class="va">tsk_adult_train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TaskClassif:adult_train&gt; (30718 x 13)
* Target: target
* Properties: twoclass
* Features (12):
  - fct (7): education, marital_status, occupation, race,
    relationship, sex, workclass
  - int (5): age, capital_gain, capital_loss, education_num,
    hours_per_week
* Protected attribute: sex, race</code></pre>
</div>
</div>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-38_58b748b968c9d0339194aa555100dfa9">
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span><span class="st">"race"</span>, add_to <span class="op">=</span> <span class="st">"pta"</span><span class="op">)</span></span>
<span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_1</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>fairness.fomr 
       0.8889 </code></pre>
</div>
</div>
<p>If we now evaluate for the intersection, we obtain a large deviation from <code>0</code>. Note, that the metric by default computes the maximum discrepancy between all metrics for the non-binary case.</p>
<p>If we now get the <code>groupwise_metrics</code>, we will get a metric for the intersection of each group.</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-39_b80c214d9b044a1fdbf93a59356a2b2b">
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">msr_3</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3fairness.mlr-org.com/reference/groupwise_metrics.html">groupwise_metrics</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.fomr"</span><span class="op">)</span>,  <span class="va">tsk_adult_train</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">msr_3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "subgroup.fomr_Male, White"               
 [2] "subgroup.fomr_Male, Black"               
 [3] "subgroup.fomr_Female, Black"             
 [4] "subgroup.fomr_Female, White"             
 [5] "subgroup.fomr_Male, Asian-Pac-Islander"  
 [6] "subgroup.fomr_Male, Amer-Indian-Eskimo"  
 [7] "subgroup.fomr_Female, Other"             
 [8] "subgroup.fomr_Female, Asian-Pac-Islander"
 [9] "subgroup.fomr_Female, Amer-Indian-Eskimo"
[10] "subgroup.fomr_Male, Other"               </code></pre>
</div>
</div>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-40_c5c8ed6a63c30196ebdcf326337c4d14">
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prediction</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span><span class="va">msr_3</span>, <span class="va">tsk_adult_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               subgroup.fomr_Male, White 
                                  0.2402 
               subgroup.fomr_Male, Black 
                                  0.2716 
             subgroup.fomr_Female, Black 
                                  0.2609 
             subgroup.fomr_Female, White 
                                  0.1919 
  subgroup.fomr_Male, Asian-Pac-Islander 
                                  0.3168 
  subgroup.fomr_Male, Amer-Indian-Eskimo 
                                  0.1667 
             subgroup.fomr_Female, Other 
                                  0.2500 
subgroup.fomr_Female, Asian-Pac-Islander 
                                  0.3529 
subgroup.fomr_Female, Amer-Indian-Eskimo 
                                  1.0000 
               subgroup.fomr_Male, Other 
                                  0.1111 </code></pre>
</div>
</div>
<p>And we can see, that the reason might be, that the false omission rate for female Amer-Indian-Eskimo is at <code>1.0</code>! We can investigate this further by looking at actual counts:</p>
<div class="cell" data-hash="solutions_cache/html/unnamed-chunk-41_9d2aefbc75632ba9b9810f12bcfcf51a">
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">tsk_adult_test</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"target"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, , target = &lt;=50K

                    sex
race                 Female Male
  Amer-Indian-Eskimo     56   74
  Asian-Pac-Islander    131  186
  Black                 654  619
  Other                  37   66
  White                3544 6176

, , target = &gt;50K

                    sex
race                 Female Male
  Amer-Indian-Eskimo      3   16
  Asian-Pac-Islander     26  106
  Black                  41  133
  Other                   5   19
  White                 492 2931</code></pre>
</div>
</div>
<p>One of the reasons might be that there are only 3 individuals in the “&gt;50k” category! This is an often encountered problem, as error metrics have a large variance when samples are small. Note, that the pre- and post-processing methods in general do not all support multiple protected attributes.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-amlb2022" class="csl-entry" role="listitem">
Gijsbers, Pieter, Marcos L. P. Bueno, Stefan Coors, Erin LeDell, Sébastien Poirier, Janek Thomas, Bernd Bischl, and Joaquin Vanschoren. 2022. <span>“AMLB: An AutoML Benchmark.”</span> arXiv. <a href="https://doi.org/10.48550/ARXIV.2207.12560">https://doi.org/10.48550/ARXIV.2207.12560</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../chapters/references.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">References</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/appendices/tasks.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Tasks</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb182" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="an">params:</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="co">    rebuild_cache: true</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Solutions to exercises {#sec-solutions}</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="html"}</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>{{&lt; include ../../common/_setup.qmd &gt;}}</span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ENSURE ONLINE ONLY AND REFERENCE IN PREFACE --&gt;</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-basics</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Set the seed to <span class="in">`124`</span> then train a classification tree model with <span class="in">`lrn("classif.rpart")`</span> and default hyperparameters on 80% of the data in the predefined <span class="in">`"sonar"`</span> task. Evaluate the model's performance with the classification error measure on the remaining data. Also think about why we need to set the seed in this example.</span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>Set the seed, load the <span class="in">`"sonar"`</span> task, then the classification tree with <span class="in">`predict_type = "prob"`</span> (needed for exercise 3), and the required measure.</span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-001}</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">124</span>)</span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>)</span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>)</span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`partition()`</span> to split the dataset then train the model.</span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>We set the seed because <span class="in">`partition()`</span> introduces an element of randomness when splitting the data.</span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">=</span> <span class="fu">partition</span>(task, <span class="at">ratio =</span> <span class="fl">0.8</span>)</span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task, splits<span class="sc">$</span>train)</span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-35"><a href="#cb182-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-36"><a href="#cb182-36" aria-hidden="true" tabindex="-1"></a>Once the model is trained, generate the predictions on the test set and score them.</span>
<span id="cb182-37"><a href="#cb182-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-38"><a href="#cb182-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-002}</span></span>
<span id="cb182-39"><a href="#cb182-39" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(task, splits<span class="sc">$</span>test)</span>
<span id="cb182-40"><a href="#cb182-40" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(measure)</span>
<span id="cb182-41"><a href="#cb182-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-42"><a href="#cb182-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-43"><a href="#cb182-43" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Calculate the true positive, false positive, true negative, and false negative rates of the predictions made by the model in exercise 1.</span>
<span id="cb182-44"><a href="#cb182-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-45"><a href="#cb182-45" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`$confusion`</span>, generate a confusion matrix and extract the required statistics,</span>
<span id="cb182-46"><a href="#cb182-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-47"><a href="#cb182-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-003}</span></span>
<span id="cb182-48"><a href="#cb182-48" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>confusion</span>
<span id="cb182-49"><a href="#cb182-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-50"><a href="#cb182-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-51"><a href="#cb182-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-004, echo=FALSE}</span></span>
<span id="cb182-52"><a href="#cb182-52" aria-hidden="true" tabindex="-1"></a>confusion <span class="ot">=</span> <span class="fu">as.data.frame</span>(prediction<span class="sc">$</span>confusion)</span>
<span id="cb182-53"><a href="#cb182-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-54"><a href="#cb182-54" aria-hidden="true" tabindex="-1"></a>TP <span class="ot">=</span> confusion<span class="sc">$</span>Freq[<span class="dv">1</span>]</span>
<span id="cb182-55"><a href="#cb182-55" aria-hidden="true" tabindex="-1"></a>FP <span class="ot">=</span> confusion<span class="sc">$</span>Freq[<span class="dv">2</span>]</span>
<span id="cb182-56"><a href="#cb182-56" aria-hidden="true" tabindex="-1"></a>TN <span class="ot">=</span> confusion<span class="sc">$</span>Freq[<span class="dv">4</span>]</span>
<span id="cb182-57"><a href="#cb182-57" aria-hidden="true" tabindex="-1"></a>FN <span class="ot">=</span> confusion<span class="sc">$</span>Freq[<span class="dv">3</span>]</span>
<span id="cb182-58"><a href="#cb182-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-59"><a href="#cb182-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-60"><a href="#cb182-60" aria-hidden="true" tabindex="-1"></a>Since the rows represent predictions (response) and the columns represent the ground truth values, the TP, FP, TN, and FN rates are as follows:</span>
<span id="cb182-61"><a href="#cb182-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-62"><a href="#cb182-62" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>True Positive (TP) = <span class="in">`r TP`</span></span>
<span id="cb182-63"><a href="#cb182-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-64"><a href="#cb182-64" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>False Positive (FP) = <span class="in">`r FP`</span></span>
<span id="cb182-65"><a href="#cb182-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-66"><a href="#cb182-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>True Negative (TN) = <span class="in">`r TN`</span></span>
<span id="cb182-67"><a href="#cb182-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-68"><a href="#cb182-68" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>False Positive (FN) = <span class="in">`r FN`</span></span>
<span id="cb182-69"><a href="#cb182-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-70"><a href="#cb182-70" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Since in this case we want the model to predict the negative class more often, we will raise the threshold (note the <span class="in">`predict_type`</span> for the learner must be <span class="in">`prob`</span> for this to work).</span>
<span id="cb182-71"><a href="#cb182-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-72"><a href="#cb182-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-005}</span></span>
<span id="cb182-73"><a href="#cb182-73" aria-hidden="true" tabindex="-1"></a><span class="co"># raise threshold from 0.5 default to 0.6</span></span>
<span id="cb182-74"><a href="#cb182-74" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="fl">0.6</span>)</span>
<span id="cb182-75"><a href="#cb182-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-76"><a href="#cb182-76" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span>confusion</span>
<span id="cb182-77"><a href="#cb182-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-78"><a href="#cb182-78" aria-hidden="true" tabindex="-1"></a>One reason we might want the false positive rate to be lower than the false negative rate is if we felt it was worse for a positive prediction to be incorrect (meaning the true label was the negative label) than it was for a negative prediction to be incorrect (meaning the true label was the positive label).</span>
<span id="cb182-79"><a href="#cb182-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-80"><a href="#cb182-80" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-performance</span></span>
<span id="cb182-81"><a href="#cb182-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-82"><a href="#cb182-82" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Apply the "bootstrap" resampling strategy on <span class="in">`tsk("mtcars")`</span> and evaluate the performance of <span class="in">`lrn("classif.rpart")`</span>.</span>
<span id="cb182-83"><a href="#cb182-83" aria-hidden="true" tabindex="-1"></a>Use 100 replicates and a sampling ratio of 80%.</span>
<span id="cb182-84"><a href="#cb182-84" aria-hidden="true" tabindex="-1"></a>Calculate the MSE for each iteration and visualize the result.</span>
<span id="cb182-85"><a href="#cb182-85" aria-hidden="true" tabindex="-1"></a>Finally, calculate the aggregated performance score.</span>
<span id="cb182-86"><a href="#cb182-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-87"><a href="#cb182-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-006}</span></span>
<span id="cb182-88"><a href="#cb182-88" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb182-89"><a href="#cb182-89" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb182-90"><a href="#cb182-90" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb182-91"><a href="#cb182-91" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"bootstrap"</span>, <span class="at">repeats =</span> <span class="dv">100</span>, <span class="at">ratio =</span> <span class="fl">0.8</span>)</span>
<span id="cb182-92"><a href="#cb182-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-93"><a href="#cb182-93" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, learner, resampling)</span>
<span id="cb182-94"><a href="#cb182-94" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb182-95"><a href="#cb182-95" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr)</span>
<span id="cb182-96"><a href="#cb182-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively: Histogram</span></span>
<span id="cb182-97"><a href="#cb182-97" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rr, <span class="at">type =</span> <span class="st">"histogram"</span>)</span>
<span id="cb182-98"><a href="#cb182-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-99"><a href="#cb182-99" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb182-100"><a href="#cb182-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-101"><a href="#cb182-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-102"><a href="#cb182-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-103"><a href="#cb182-103" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use <span class="in">`tsk("spam")`</span> and five-fold CV to benchmark Random forest (<span class="in">`lrn("classif.ranger")`</span>), Logistic Regression (<span class="in">`lrn("classif.log_reg")`</span>), and XGBoost (<span class="in">`lrn("classif.xgboost")`</span>) with respect to AUC.</span>
<span id="cb182-104"><a href="#cb182-104" aria-hidden="true" tabindex="-1"></a>Which learner appears to do best? How confident are you in your conclusion?</span>
<span id="cb182-105"><a href="#cb182-105" aria-hidden="true" tabindex="-1"></a>How would you improve upon this?</span>
<span id="cb182-106"><a href="#cb182-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-107"><a href="#cb182-107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-007, warning=FALSE}</span></span>
<span id="cb182-108"><a href="#cb182-108" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb182-109"><a href="#cb182-109" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb182-110"><a href="#cb182-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>),</span>
<span id="cb182-111"><a href="#cb182-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">lrns</span>(<span class="fu">c</span>(<span class="st">"classif.ranger"</span>, <span class="st">"classif.log_reg"</span>, <span class="st">"classif.xgboost"</span>),</span>
<span id="cb182-112"><a href="#cb182-112" aria-hidden="true" tabindex="-1"></a>                  <span class="at">predict_type =</span> <span class="st">"prob"</span>),</span>
<span id="cb182-113"><a href="#cb182-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>)</span>
<span id="cb182-114"><a href="#cb182-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-115"><a href="#cb182-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-116"><a href="#cb182-116" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb182-117"><a href="#cb182-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-118"><a href="#cb182-118" aria-hidden="true" tabindex="-1"></a>mlr3viz<span class="sc">::</span><span class="fu">autoplot</span>(bmr, <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.auc"</span>))</span>
<span id="cb182-119"><a href="#cb182-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-120"><a href="#cb182-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-121"><a href="#cb182-121" aria-hidden="true" tabindex="-1"></a>This is only a small example for a benchmark workflow, but without tuning (see @sec-optimization), the results are naturally not suitable to make any broader statements about the superiority of either learner for this task.</span>
<span id="cb182-122"><a href="#cb182-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-123"><a href="#cb182-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-124"><a href="#cb182-124" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>A colleague claims to have achieved a 93.1% classification accuracy using <span class="in">`lrn("classif.rpart")`</span> on <span class="in">`tsk("penguins_simple")`</span>.</span>
<span id="cb182-125"><a href="#cb182-125" aria-hidden="true" tabindex="-1"></a>You want to reproduce their results and ask them about their resampling strategy.</span>
<span id="cb182-126"><a href="#cb182-126" aria-hidden="true" tabindex="-1"></a>They said they used a custom three-fold CV with folds assigned as <span class="in">`factor(task$row_ids %% 3)`</span>.</span>
<span id="cb182-127"><a href="#cb182-127" aria-hidden="true" tabindex="-1"></a>See if you can reproduce their results.</span>
<span id="cb182-128"><a href="#cb182-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-129"><a href="#cb182-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-008}</span></span>
<span id="cb182-130"><a href="#cb182-130" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins_simple"</span>)</span>
<span id="cb182-131"><a href="#cb182-131" aria-hidden="true" tabindex="-1"></a>rsmp_cv <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"custom_cv"</span>)</span>
<span id="cb182-132"><a href="#cb182-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-133"><a href="#cb182-133" aria-hidden="true" tabindex="-1"></a>rsmp_cv<span class="sc">$</span><span class="fu">instantiate</span>(<span class="at">task =</span> task, <span class="at">f =</span> <span class="fu">factor</span>(task<span class="sc">$</span>row_ids <span class="sc">%%</span> <span class="dv">3</span>))</span>
<span id="cb182-134"><a href="#cb182-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-135"><a href="#cb182-135" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(</span>
<span id="cb182-136"><a href="#cb182-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb182-137"><a href="#cb182-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb182-138"><a href="#cb182-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> rsmp_cv</span>
<span id="cb182-139"><a href="#cb182-139" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-140"><a href="#cb182-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-141"><a href="#cb182-141" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span>
<span id="cb182-142"><a href="#cb182-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-143"><a href="#cb182-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-144"><a href="#cb182-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-145"><a href="#cb182-145" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-optimization</span></span>
<span id="cb182-146"><a href="#cb182-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-147"><a href="#cb182-147" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Tune the <span class="in">`mtry`</span>, <span class="in">`sample.fraction`</span>, <span class="in">` num.trees`</span> hyperparameters of a random forest model (<span class="in">`lrn("regr.ranger")`</span>) on the <span class="in">`"mtcars"`</span> task.</span>
<span id="cb182-148"><a href="#cb182-148" aria-hidden="true" tabindex="-1"></a>Use a simple random search with 50 evaluations and select a suitable batch size.</span>
<span id="cb182-149"><a href="#cb182-149" aria-hidden="true" tabindex="-1"></a>Evaluate with a three-fold CV and the root mean squared error.</span>
<span id="cb182-150"><a href="#cb182-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-151"><a href="#cb182-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-009}</span></span>
<span id="cb182-152"><a href="#cb182-152" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb182-153"><a href="#cb182-153" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>,</span>
<span id="cb182-154"><a href="#cb182-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry.ratio      =</span> <span class="fu">to_tune</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb182-155"><a href="#cb182-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fu">to_tune</span>(<span class="fl">1e-1</span>, <span class="dv">1</span>),</span>
<span id="cb182-156"><a href="#cb182-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees       =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">2000</span>)</span>
<span id="cb182-157"><a href="#cb182-157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-158"><a href="#cb182-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-159"><a href="#cb182-159" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">ti</span>(</span>
<span id="cb182-160"><a href="#cb182-160" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>),</span>
<span id="cb182-161"><a href="#cb182-161" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb182-162"><a href="#cb182-162" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb182-163"><a href="#cb182-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb182-164"><a href="#cb182-164" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb182-165"><a href="#cb182-165" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-166"><a href="#cb182-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-167"><a href="#cb182-167" aria-hidden="true" tabindex="-1"></a>tuner <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">10</span>)</span>
<span id="cb182-168"><a href="#cb182-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-169"><a href="#cb182-169" aria-hidden="true" tabindex="-1"></a>tuner<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb182-170"><a href="#cb182-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-171"><a href="#cb182-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-172"><a href="#cb182-172" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Evaluate the performance of the model created in Question 1 with nested resampling.</span>
<span id="cb182-173"><a href="#cb182-173" aria-hidden="true" tabindex="-1"></a>Use a holdout validation for the inner resampling and a three-fold CV for the outer resampling.</span>
<span id="cb182-174"><a href="#cb182-174" aria-hidden="true" tabindex="-1"></a>Print the unbiased performance estimate of the model.</span>
<span id="cb182-175"><a href="#cb182-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-176"><a href="#cb182-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-010}</span></span>
<span id="cb182-177"><a href="#cb182-177" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb182-178"><a href="#cb182-178" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>,</span>
<span id="cb182-179"><a href="#cb182-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry.ratio      =</span> <span class="fu">to_tune</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb182-180"><a href="#cb182-180" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fu">to_tune</span>(<span class="fl">1e-1</span>, <span class="dv">1</span>),</span>
<span id="cb182-181"><a href="#cb182-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees       =</span> <span class="fu">to_tune</span>(<span class="dv">1</span>, <span class="dv">2000</span>)</span>
<span id="cb182-182"><a href="#cb182-182" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-183"><a href="#cb182-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-184"><a href="#cb182-184" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb182-185"><a href="#cb182-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">10</span>),</span>
<span id="cb182-186"><a href="#cb182-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> learner,</span>
<span id="cb182-187"><a href="#cb182-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb182-188"><a href="#cb182-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.rmse"</span>),</span>
<span id="cb182-189"><a href="#cb182-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb182-190"><a href="#cb182-190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-191"><a href="#cb182-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-192"><a href="#cb182-192" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb182-193"><a href="#cb182-193" aria-hidden="true" tabindex="-1"></a>outer_resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb182-194"><a href="#cb182-194" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, at, outer_resampling, <span class="at">store_models =</span> <span class="cn">TRUE</span>)</span>
<span id="cb182-195"><a href="#cb182-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-196"><a href="#cb182-196" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>()</span>
<span id="cb182-197"><a href="#cb182-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-198"><a href="#cb182-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-199"><a href="#cb182-199" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Tune and benchmark an XGBoost model against a logistic regression model on the <span class="in">`"spam"`</span> task and determine which has the best Brier score.</span>
<span id="cb182-200"><a href="#cb182-200" aria-hidden="true" tabindex="-1"></a>Use mlr3tuningspaces and nested resampling.</span>
<span id="cb182-201"><a href="#cb182-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-202"><a href="#cb182-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-011}</span></span>
<span id="cb182-203"><a href="#cb182-203" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3tuningspaces)</span>
<span id="cb182-204"><a href="#cb182-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-205"><a href="#cb182-205" aria-hidden="true" tabindex="-1"></a>lrn_xgboost <span class="ot">=</span> <span class="fu">lts</span>(<span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>))</span>
<span id="cb182-206"><a href="#cb182-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-207"><a href="#cb182-207" aria-hidden="true" tabindex="-1"></a>at_xgboost <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb182-208"><a href="#cb182-208" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">1</span>),</span>
<span id="cb182-209"><a href="#cb182-209" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lrn_xgboost,</span>
<span id="cb182-210"><a href="#cb182-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb182-211"><a href="#cb182-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.bbrier"</span>),</span>
<span id="cb182-212"><a href="#cb182-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">2</span>,</span>
<span id="cb182-213"><a href="#cb182-213" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-214"><a href="#cb182-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-215"><a href="#cb182-215" aria-hidden="true" tabindex="-1"></a>lrn_logreg <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb182-216"><a href="#cb182-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-217"><a href="#cb182-217" aria-hidden="true" tabindex="-1"></a>at_logreg <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb182-218"><a href="#cb182-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">1</span>),</span>
<span id="cb182-219"><a href="#cb182-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> lrn_logreg,</span>
<span id="cb182-220"><a href="#cb182-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb182-221"><a href="#cb182-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.bbrier"</span>),</span>
<span id="cb182-222"><a href="#cb182-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">2</span>,</span>
<span id="cb182-223"><a href="#cb182-223" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-224"><a href="#cb182-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-225"><a href="#cb182-225" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>)</span>
<span id="cb182-226"><a href="#cb182-226" aria-hidden="true" tabindex="-1"></a>outer_resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb182-227"><a href="#cb182-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-228"><a href="#cb182-228" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb182-229"><a href="#cb182-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">tasks =</span> task,</span>
<span id="cb182-230"><a href="#cb182-230" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(at_xgboost, at_logreg),</span>
<span id="cb182-231"><a href="#cb182-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> outer_resampling</span>
<span id="cb182-232"><a href="#cb182-232" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-233"><a href="#cb182-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-234"><a href="#cb182-234" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design, <span class="at">store_models =</span> <span class="cn">TRUE</span>)</span>
<span id="cb182-235"><a href="#cb182-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-236"><a href="#cb182-236" aria-hidden="true" tabindex="-1"></a>bmr</span>
<span id="cb182-237"><a href="#cb182-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-238"><a href="#cb182-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-239"><a href="#cb182-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-240"><a href="#cb182-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-241"><a href="#cb182-241" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-optimization-advanced</span></span>
<span id="cb182-242"><a href="#cb182-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-243"><a href="#cb182-243" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>We first construct the objective function and optimization instance:</span>
<span id="cb182-244"><a href="#cb182-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-247"><a href="#cb182-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-248"><a href="#cb182-248" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbotk)</span>
<span id="cb182-249"><a href="#cb182-249" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3mbo)</span>
<span id="cb182-250"><a href="#cb182-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-251"><a href="#cb182-251" aria-hidden="true" tabindex="-1"></a>rastrigin <span class="ot">=</span> <span class="cf">function</span>(xdt) {</span>
<span id="cb182-252"><a href="#cb182-252" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">=</span> <span class="fu">ncol</span>(xdt)</span>
<span id="cb182-253"><a href="#cb182-253" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="dv">10</span> <span class="sc">*</span> D <span class="sc">+</span> <span class="fu">rowSums</span>(xdt<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (<span class="dv">10</span> <span class="sc">*</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> xdt)))</span>
<span id="cb182-254"><a href="#cb182-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">y =</span> y)</span>
<span id="cb182-255"><a href="#cb182-255" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-256"><a href="#cb182-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-257"><a href="#cb182-257" aria-hidden="true" tabindex="-1"></a>objective <span class="ot">=</span> ObjectiveRFunDt<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-258"><a href="#cb182-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> rastrigin,</span>
<span id="cb182-259"><a href="#cb182-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">ps</span>(<span class="at">x1 =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="fl">5.12</span>, <span class="at">upper =</span> <span class="fl">5.12</span>),</span>
<span id="cb182-260"><a href="#cb182-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2 =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="fl">5.12</span>, <span class="at">upper =</span> <span class="fl">5.12</span>)),</span>
<span id="cb182-261"><a href="#cb182-261" aria-hidden="true" tabindex="-1"></a>  <span class="at">codomain =</span> <span class="fu">ps</span>(<span class="at">y =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>)),</span>
<span id="cb182-262"><a href="#cb182-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"rastrigin2D"</span>)</span>
<span id="cb182-263"><a href="#cb182-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-264"><a href="#cb182-264" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> OptimInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-265"><a href="#cb182-265" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> objective,</span>
<span id="cb182-266"><a href="#cb182-266" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">40</span>))</span>
<span id="cb182-267"><a href="#cb182-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-268"><a href="#cb182-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-269"><a href="#cb182-269" aria-hidden="true" tabindex="-1"></a>Based on the different surrogate models, we can construct two optimizers:</span>
<span id="cb182-270"><a href="#cb182-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-273"><a href="#cb182-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-274"><a href="#cb182-274" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3mbo)</span>
<span id="cb182-275"><a href="#cb182-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-276"><a href="#cb182-276" aria-hidden="true" tabindex="-1"></a>surrogate_gp <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">lrn</span>(<span class="st">"regr.km"</span>, <span class="at">covtype =</span> <span class="st">"matern5_2"</span>,</span>
<span id="cb182-277"><a href="#cb182-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">optim.method =</span> <span class="st">"BFGS"</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">trace =</span> <span class="cn">FALSE</span>)))</span>
<span id="cb182-278"><a href="#cb182-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-279"><a href="#cb182-279" aria-hidden="true" tabindex="-1"></a>surrogate_rf <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>, <span class="at">num.trees =</span> 10L, <span class="at">keep.inbag =</span> <span class="cn">TRUE</span>,</span>
<span id="cb182-280"><a href="#cb182-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">se.method =</span> <span class="st">"jack"</span>))</span>
<span id="cb182-281"><a href="#cb182-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-282"><a href="#cb182-282" aria-hidden="true" tabindex="-1"></a>acq_function <span class="ot">=</span> <span class="fu">acqf</span>(<span class="st">"cb"</span>, <span class="at">lambda =</span> <span class="dv">1</span>)</span>
<span id="cb182-283"><a href="#cb182-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-284"><a href="#cb182-284" aria-hidden="true" tabindex="-1"></a>acq_optimizer <span class="ot">=</span> <span class="fu">acqo</span>(<span class="fu">opt</span>(<span class="st">"nloptr"</span>, <span class="at">algorithm =</span> <span class="st">"NLOPT_GN_ORIG_DIRECT"</span>),</span>
<span id="cb182-285"><a href="#cb182-285" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"stagnation"</span>, <span class="at">iters =</span> <span class="dv">100</span>, <span class="at">threshold =</span> <span class="fl">1e-5</span>))</span>
<span id="cb182-286"><a href="#cb182-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-287"><a href="#cb182-287" aria-hidden="true" tabindex="-1"></a>optimizer_gp <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb182-288"><a href="#cb182-288" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_ego,</span>
<span id="cb182-289"><a href="#cb182-289" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate_gp,</span>
<span id="cb182-290"><a href="#cb182-290" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb182-291"><a href="#cb182-291" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer)</span>
<span id="cb182-292"><a href="#cb182-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-293"><a href="#cb182-293" aria-hidden="true" tabindex="-1"></a>optimizer_rf <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb182-294"><a href="#cb182-294" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_ego,</span>
<span id="cb182-295"><a href="#cb182-295" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate_rf,</span>
<span id="cb182-296"><a href="#cb182-296" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb182-297"><a href="#cb182-297" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer)</span>
<span id="cb182-298"><a href="#cb182-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-299"><a href="#cb182-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-300"><a href="#cb182-300" aria-hidden="true" tabindex="-1"></a>We then evaluate the given initial design on the instance and optimize it with the first BO algorithm using a Gaussian Process as surrogate model:</span>
<span id="cb182-301"><a href="#cb182-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-302"><a href="#cb182-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, output=FALSE}</span></span>
<span id="cb182-303"><a href="#cb182-303" aria-hidden="true" tabindex="-1"></a>initial_design <span class="ot">=</span> <span class="fu">data.table</span>(</span>
<span id="cb182-304"><a href="#cb182-304" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3.95</span>, <span class="fl">1.16</span>, <span class="fl">3.72</span>, <span class="sc">-</span><span class="fl">1.39</span>, <span class="sc">-</span><span class="fl">0.11</span>, <span class="fl">5.00</span>, <span class="sc">-</span><span class="fl">2.67</span>, <span class="fl">2.44</span>),</span>
<span id="cb182-305"><a href="#cb182-305" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">c</span>(<span class="fl">1.18</span>, <span class="sc">-</span><span class="fl">3.93</span>, <span class="fl">3.74</span>, <span class="sc">-</span><span class="fl">1.37</span>, <span class="fl">5.02</span>, <span class="sc">-</span><span class="fl">0.09</span>, <span class="sc">-</span><span class="fl">2.65</span>, <span class="fl">2.46</span>))</span>
<span id="cb182-306"><a href="#cb182-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-307"><a href="#cb182-307" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span><span class="fu">eval_batch</span>(initial_design)</span>
<span id="cb182-308"><a href="#cb182-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-309"><a href="#cb182-309" aria-hidden="true" tabindex="-1"></a>optimizer_gp<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb182-310"><a href="#cb182-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-311"><a href="#cb182-311" aria-hidden="true" tabindex="-1"></a>gp_data <span class="ot">=</span> instance<span class="sc">$</span>archive<span class="sc">$</span>data</span>
<span id="cb182-312"><a href="#cb182-312" aria-hidden="true" tabindex="-1"></a>gp_data[, y_min <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(y)]</span>
<span id="cb182-313"><a href="#cb182-313" aria-hidden="true" tabindex="-1"></a>gp_data[, nr_eval <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb182-314"><a href="#cb182-314" aria-hidden="true" tabindex="-1"></a>gp_data[, surrogate <span class="sc">:</span><span class="er">=</span> <span class="st">"Gaussian Process"</span>]</span>
<span id="cb182-315"><a href="#cb182-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-316"><a href="#cb182-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-317"><a href="#cb182-317" aria-hidden="true" tabindex="-1"></a>Afterwards, we clear the instance, evaluate the initial design again and optimize the instance with the second BO algorithm using a random forest as surrogate model:</span>
<span id="cb182-318"><a href="#cb182-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-319"><a href="#cb182-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, output=FALSE}</span></span>
<span id="cb182-320"><a href="#cb182-320" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>archive<span class="sc">$</span><span class="fu">clear</span>()</span>
<span id="cb182-321"><a href="#cb182-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-322"><a href="#cb182-322" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span><span class="fu">eval_batch</span>(initial_design)</span>
<span id="cb182-323"><a href="#cb182-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-324"><a href="#cb182-324" aria-hidden="true" tabindex="-1"></a>optimizer_rf<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb182-325"><a href="#cb182-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-326"><a href="#cb182-326" aria-hidden="true" tabindex="-1"></a>rf_data <span class="ot">=</span> instance<span class="sc">$</span>archive<span class="sc">$</span>data</span>
<span id="cb182-327"><a href="#cb182-327" aria-hidden="true" tabindex="-1"></a>rf_data[, y_min <span class="sc">:</span><span class="er">=</span> <span class="fu">cummin</span>(y)]</span>
<span id="cb182-328"><a href="#cb182-328" aria-hidden="true" tabindex="-1"></a>rf_data[, nr_eval <span class="sc">:</span><span class="er">=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb182-329"><a href="#cb182-329" aria-hidden="true" tabindex="-1"></a>rf_data[, surrogate <span class="sc">:</span><span class="er">=</span> <span class="st">"Random forest"</span>]</span>
<span id="cb182-330"><a href="#cb182-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-331"><a href="#cb182-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-332"><a href="#cb182-332" aria-hidden="true" tabindex="-1"></a>We collect all data and visualize the anytime performance:</span>
<span id="cb182-333"><a href="#cb182-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-336"><a href="#cb182-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-337"><a href="#cb182-337" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb182-338"><a href="#cb182-338" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridisLite)</span>
<span id="cb182-339"><a href="#cb182-339" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">=</span> <span class="fu">rbind</span>(gp_data, rf_data)</span>
<span id="cb182-340"><a href="#cb182-340" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> nr_eval, <span class="at">y =</span> y_min, <span class="at">colour =</span> surrogate), <span class="at">data =</span> all_data) <span class="sc">+</span></span>
<span id="cb182-341"><a href="#cb182-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb182-342"><a href="#cb182-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">viridis</span>(<span class="dv">2</span>, <span class="at">end =</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb182-343"><a href="#cb182-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Best Observed Function Value"</span>, <span class="at">x =</span> <span class="st">"Number of Function Evaluations"</span>,</span>
<span id="cb182-344"><a href="#cb182-344" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">"Surrogate Model"</span>) <span class="sc">+</span></span>
<span id="cb182-345"><a href="#cb182-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb182-346"><a href="#cb182-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb182-347"><a href="#cb182-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-348"><a href="#cb182-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-349"><a href="#cb182-349" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>We first construct the non-parallelized objective function and the optimization instance:</span>
<span id="cb182-350"><a href="#cb182-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-353"><a href="#cb182-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-354"><a href="#cb182-354" aria-hidden="true" tabindex="-1"></a>schaffer1 <span class="ot">=</span> <span class="cf">function</span>(xss) {</span>
<span id="cb182-355"><a href="#cb182-355" aria-hidden="true" tabindex="-1"></a>  evaluations <span class="ot">=</span> <span class="fu">lapply</span>(xss, <span class="at">FUN =</span> <span class="cf">function</span>(xs) {</span>
<span id="cb182-356"><a href="#cb182-356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb182-357"><a href="#cb182-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">y1 =</span> xs<span class="sc">$</span>x, <span class="at">y2 =</span> (xs<span class="sc">$</span>x <span class="sc">-</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb182-358"><a href="#cb182-358" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb182-359"><a href="#cb182-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(evaluations)</span>
<span id="cb182-360"><a href="#cb182-360" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-361"><a href="#cb182-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-362"><a href="#cb182-362" aria-hidden="true" tabindex="-1"></a>objective <span class="ot">=</span> ObjectiveRFunMany<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-363"><a href="#cb182-363" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> schaffer1,</span>
<span id="cb182-364"><a href="#cb182-364" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">ps</span>(<span class="at">x =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">upper =</span> <span class="dv">10</span>)),</span>
<span id="cb182-365"><a href="#cb182-365" aria-hidden="true" tabindex="-1"></a>  <span class="at">codomain =</span> <span class="fu">ps</span>(<span class="at">y1 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>), <span class="at">y2 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>)),</span>
<span id="cb182-366"><a href="#cb182-366" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"schaffer1"</span>)</span>
<span id="cb182-367"><a href="#cb182-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-368"><a href="#cb182-368" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> OptimInstanceMultiCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-369"><a href="#cb182-369" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> objective,</span>
<span id="cb182-370"><a href="#cb182-370" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"run_time"</span>, <span class="at">secs =</span> <span class="dv">60</span>))</span>
<span id="cb182-371"><a href="#cb182-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-372"><a href="#cb182-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-373"><a href="#cb182-373" aria-hidden="true" tabindex="-1"></a>Using the surrogate, acquisition function and acquisition function optimizer that are provided, we can proceed to optimize the instance via ParEGO:</span>
<span id="cb182-374"><a href="#cb182-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-377"><a href="#cb182-377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-378"><a href="#cb182-378" aria-hidden="true" tabindex="-1"></a>surrogate <span class="ot">=</span> <span class="fu">srlrn</span>(<span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>, <span class="at">num.trees =</span> 10L, <span class="at">keep.inbag =</span> <span class="cn">TRUE</span>,</span>
<span id="cb182-379"><a href="#cb182-379" aria-hidden="true" tabindex="-1"></a>  <span class="at">se.method =</span> <span class="st">"jack"</span>))</span>
<span id="cb182-380"><a href="#cb182-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-381"><a href="#cb182-381" aria-hidden="true" tabindex="-1"></a>acq_function <span class="ot">=</span> <span class="fu">acqf</span>(<span class="st">"ei"</span>)</span>
<span id="cb182-382"><a href="#cb182-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-383"><a href="#cb182-383" aria-hidden="true" tabindex="-1"></a>acq_optimizer <span class="ot">=</span> <span class="fu">acqo</span>(<span class="fu">opt</span>(<span class="st">"random_search"</span>, <span class="at">batch_size =</span> <span class="dv">100</span>),</span>
<span id="cb182-384"><a href="#cb182-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">100</span>))</span>
<span id="cb182-385"><a href="#cb182-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-386"><a href="#cb182-386" aria-hidden="true" tabindex="-1"></a>optimizer <span class="ot">=</span> <span class="fu">opt</span>(<span class="st">"mbo"</span>,</span>
<span id="cb182-387"><a href="#cb182-387" aria-hidden="true" tabindex="-1"></a>  <span class="at">loop_function =</span> bayesopt_parego,</span>
<span id="cb182-388"><a href="#cb182-388" aria-hidden="true" tabindex="-1"></a>  <span class="at">surrogate =</span> surrogate,</span>
<span id="cb182-389"><a href="#cb182-389" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_function =</span> acq_function,</span>
<span id="cb182-390"><a href="#cb182-390" aria-hidden="true" tabindex="-1"></a>  <span class="at">acq_optimizer =</span> acq_optimizer,</span>
<span id="cb182-391"><a href="#cb182-391" aria-hidden="true" tabindex="-1"></a>  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">q =</span> <span class="dv">4</span>))</span>
<span id="cb182-392"><a href="#cb182-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-393"><a href="#cb182-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-394"><a href="#cb182-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, output=FALSE}</span></span>
<span id="cb182-395"><a href="#cb182-395" aria-hidden="true" tabindex="-1"></a>optimizer<span class="sc">$</span><span class="fu">optimize</span>(instance)</span>
<span id="cb182-396"><a href="#cb182-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-397"><a href="#cb182-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-398"><a href="#cb182-398" aria-hidden="true" tabindex="-1"></a>We observe that 12 points were evaluated in total (which makes sense as the objective function evaluation is not yet parallelized and the overhead of each function evaluation is given by 5 seconds).</span>
<span id="cb182-399"><a href="#cb182-399" aria-hidden="true" tabindex="-1"></a>While the points are appropriately evaluated in batches of size <span class="in">`q = 4`</span> (with the initial design automatically constructed as the first batch), we do not experience any acceleration of the optimization process unless the function evaluation is explicitly parallelized.</span>
<span id="cb182-400"><a href="#cb182-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-403"><a href="#cb182-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-404"><a href="#cb182-404" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(instance<span class="sc">$</span>archive<span class="sc">$</span>data)</span>
<span id="cb182-405"><a href="#cb182-405" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>archive<span class="sc">$</span>data[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"timestamp"</span>, <span class="st">"batch_nr"</span>)]</span>
<span id="cb182-406"><a href="#cb182-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-407"><a href="#cb182-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-408"><a href="#cb182-408" aria-hidden="true" tabindex="-1"></a>We now parallelize the evaluation of the objective function and proceed to optimize the instance again:</span>
<span id="cb182-409"><a href="#cb182-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-412"><a href="#cb182-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-413"><a href="#cb182-413" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb182-414"><a href="#cb182-414" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future.apply)</span>
<span id="cb182-415"><a href="#cb182-415" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">4</span>)</span>
<span id="cb182-416"><a href="#cb182-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-417"><a href="#cb182-417" aria-hidden="true" tabindex="-1"></a>schaffer1_parallel <span class="ot">=</span> <span class="cf">function</span>(xss) {</span>
<span id="cb182-418"><a href="#cb182-418" aria-hidden="true" tabindex="-1"></a>  evaluations <span class="ot">=</span> <span class="fu">future_lapply</span>(xss, <span class="at">FUN =</span> <span class="cf">function</span>(xs) {</span>
<span id="cb182-419"><a href="#cb182-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb182-420"><a href="#cb182-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">y1 =</span> xs<span class="sc">$</span>x, <span class="at">y2 =</span> (xs<span class="sc">$</span>x <span class="sc">-</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb182-421"><a href="#cb182-421" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb182-422"><a href="#cb182-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbindlist</span>(evaluations)</span>
<span id="cb182-423"><a href="#cb182-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-424"><a href="#cb182-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-425"><a href="#cb182-425" aria-hidden="true" tabindex="-1"></a>objective_parallel <span class="ot">=</span> ObjectiveRFunMany<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-426"><a href="#cb182-426" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> schaffer1_parallel,</span>
<span id="cb182-427"><a href="#cb182-427" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> <span class="fu">ps</span>(<span class="at">x =</span> <span class="fu">p_dbl</span>(<span class="at">lower =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">upper =</span> <span class="dv">10</span>)),</span>
<span id="cb182-428"><a href="#cb182-428" aria-hidden="true" tabindex="-1"></a>  <span class="at">codomain =</span> <span class="fu">ps</span>(<span class="at">y1 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>), <span class="at">y2 =</span> <span class="fu">p_dbl</span>(<span class="at">tags =</span> <span class="st">"minimize"</span>)),</span>
<span id="cb182-429"><a href="#cb182-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"schaffer1_parallel"</span>)</span>
<span id="cb182-430"><a href="#cb182-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-431"><a href="#cb182-431" aria-hidden="true" tabindex="-1"></a>instance_parallel <span class="ot">=</span> OptimInstanceMultiCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-432"><a href="#cb182-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">objective =</span> objective_parallel,</span>
<span id="cb182-433"><a href="#cb182-433" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"run_time"</span>, <span class="at">secs =</span> <span class="dv">60</span>))</span>
<span id="cb182-434"><a href="#cb182-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-435"><a href="#cb182-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-436"><a href="#cb182-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, output=FALSE}</span></span>
<span id="cb182-437"><a href="#cb182-437" aria-hidden="true" tabindex="-1"></a>optimizer<span class="sc">$</span><span class="fu">optimize</span>(instance_parallel)</span>
<span id="cb182-438"><a href="#cb182-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-439"><a href="#cb182-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-440"><a href="#cb182-440" aria-hidden="true" tabindex="-1"></a>By parallelizing the evaluation of the objective function we used our compute resources much more efficiently and evaluated many more points:</span>
<span id="cb182-441"><a href="#cb182-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-444"><a href="#cb182-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-445"><a href="#cb182-445" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(instance_parallel<span class="sc">$</span>archive<span class="sc">$</span>data)</span>
<span id="cb182-446"><a href="#cb182-446" aria-hidden="true" tabindex="-1"></a>instance_parallel<span class="sc">$</span>archive<span class="sc">$</span>data[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"timestamp"</span>, <span class="st">"batch_nr"</span>)]</span>
<span id="cb182-447"><a href="#cb182-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-448"><a href="#cb182-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-449"><a href="#cb182-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-450"><a href="#cb182-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-451"><a href="#cb182-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-452"><a href="#cb182-452" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-feature-selection</span></span>
<span id="cb182-453"><a href="#cb182-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-454"><a href="#cb182-454" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Calculate a correlation filter on the <span class="in">`"mtcars"`</span> task.</span>
<span id="cb182-455"><a href="#cb182-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-456"><a href="#cb182-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-012}</span></span>
<span id="cb182-457"><a href="#cb182-457" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb182-458"><a href="#cb182-458" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">=</span> <span class="fu">flt</span>(<span class="st">"correlation"</span>)</span>
<span id="cb182-459"><a href="#cb182-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-460"><a href="#cb182-460" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"mtcars"</span>)</span>
<span id="cb182-461"><a href="#cb182-461" aria-hidden="true" tabindex="-1"></a>filter<span class="sc">$</span><span class="fu">calculate</span>(task)</span>
<span id="cb182-462"><a href="#cb182-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-463"><a href="#cb182-463" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(filter)</span>
<span id="cb182-464"><a href="#cb182-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-465"><a href="#cb182-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-466"><a href="#cb182-466" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use the filter from the first exercise to select the five best features in the <span class="in">`mtcars`</span> dataset.</span>
<span id="cb182-467"><a href="#cb182-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-468"><a href="#cb182-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-013}</span></span>
<span id="cb182-469"><a href="#cb182-469" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">head</span>(filter<span class="sc">$</span>scores, <span class="dv">5</span>))</span>
<span id="cb182-470"><a href="#cb182-470" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span><span class="fu">select</span>(keep)</span>
<span id="cb182-471"><a href="#cb182-471" aria-hidden="true" tabindex="-1"></a>task<span class="sc">$</span>feature_names</span>
<span id="cb182-472"><a href="#cb182-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-473"><a href="#cb182-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-474"><a href="#cb182-474" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Apply a backward selection to <span class="in">`tsk("penguins")`</span> with <span class="in">`lrn("classif.rpart")`</span> and holdout resampling by the measure classification accuracy. Compare the results with those in @sec-fs-wrapper-example.</span>
<span id="cb182-475"><a href="#cb182-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-476"><a href="#cb182-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-014}</span></span>
<span id="cb182-477"><a href="#cb182-477" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3fselect)</span>
<span id="cb182-478"><a href="#cb182-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-479"><a href="#cb182-479" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb182-480"><a href="#cb182-480" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sbs"</span>),</span>
<span id="cb182-481"><a href="#cb182-481" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb182-482"><a href="#cb182-482" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb182-483"><a href="#cb182-483" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb182-484"><a href="#cb182-484" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb182-485"><a href="#cb182-485" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-486"><a href="#cb182-486" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance<span class="sc">$</span>result)[, .(bill_depth, bill_length, body_mass, classif.acc)]</span>
<span id="cb182-487"><a href="#cb182-487" aria-hidden="true" tabindex="-1"></a>instance<span class="sc">$</span>result_feature_set</span>
<span id="cb182-488"><a href="#cb182-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-489"><a href="#cb182-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-490"><a href="#cb182-490" aria-hidden="true" tabindex="-1"></a>Answer the following questions:</span>
<span id="cb182-491"><a href="#cb182-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-492"><a href="#cb182-492" aria-hidden="true" tabindex="-1"></a>  a. Do the selected features differ?</span>
<span id="cb182-493"><a href="#cb182-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-494"><a href="#cb182-494" aria-hidden="true" tabindex="-1"></a>Yes, the backward selection selects more features.</span>
<span id="cb182-495"><a href="#cb182-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-496"><a href="#cb182-496" aria-hidden="true" tabindex="-1"></a>  b. Which feature selection method achieves a higher classification accuracy?</span>
<span id="cb182-497"><a href="#cb182-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-498"><a href="#cb182-498" aria-hidden="true" tabindex="-1"></a>In this example, the backwards example performs slightly better, but this depends heavily on the random seed and could look different in another run.</span>
<span id="cb182-499"><a href="#cb182-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-500"><a href="#cb182-500" aria-hidden="true" tabindex="-1"></a>  c. Are the accuracy values in b) directly comparable? If not, what has to be changed to make them comparable?</span>
<span id="cb182-501"><a href="#cb182-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-502"><a href="#cb182-502" aria-hidden="true" tabindex="-1"></a>No, they are not comparable because the holdout sampling called with <span class="in">`rsmp("holdout")`</span> creates a different holdout set for the two runs. A fair comparison would create a single resampling instance and use it for both feature selections (see @sec-performance for details):</span>
<span id="cb182-503"><a href="#cb182-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-504"><a href="#cb182-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-015}</span></span>
<span id="cb182-505"><a href="#cb182-505" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb182-506"><a href="#cb182-506" aria-hidden="true" tabindex="-1"></a>resampling<span class="sc">$</span><span class="fu">instantiate</span>(<span class="fu">tsk</span>(<span class="st">"penguins"</span>))</span>
<span id="cb182-507"><a href="#cb182-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-508"><a href="#cb182-508" aria-hidden="true" tabindex="-1"></a>instance_sfs <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb182-509"><a href="#cb182-509" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sfs"</span>),</span>
<span id="cb182-510"><a href="#cb182-510" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb182-511"><a href="#cb182-511" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb182-512"><a href="#cb182-512" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling,</span>
<span id="cb182-513"><a href="#cb182-513" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb182-514"><a href="#cb182-514" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-515"><a href="#cb182-515" aria-hidden="true" tabindex="-1"></a>instance_sbs <span class="ot">=</span> <span class="fu">fselect</span>(</span>
<span id="cb182-516"><a href="#cb182-516" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"sequential"</span>, <span class="at">strategy =</span> <span class="st">"sbs"</span>),</span>
<span id="cb182-517"><a href="#cb182-517" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span>  <span class="fu">tsk</span>(<span class="st">"penguins"</span>),</span>
<span id="cb182-518"><a href="#cb182-518" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>),</span>
<span id="cb182-519"><a href="#cb182-519" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> resampling,</span>
<span id="cb182-520"><a href="#cb182-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>)</span>
<span id="cb182-521"><a href="#cb182-521" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-522"><a href="#cb182-522" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance_sfs<span class="sc">$</span>result)[, .(bill_depth, bill_length, body_mass, classif.acc)]</span>
<span id="cb182-523"><a href="#cb182-523" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance_sbs<span class="sc">$</span>result)[, .(bill_depth, bill_length, body_mass, classif.acc)]</span>
<span id="cb182-524"><a href="#cb182-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-525"><a href="#cb182-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-526"><a href="#cb182-526" aria-hidden="true" tabindex="-1"></a>Alternatively, one could automate the feature selection and perform a benchmark between the two wrapped learners.</span>
<span id="cb182-527"><a href="#cb182-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-528"><a href="#cb182-528" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Automate the feature selection as in @sec-autofselect with <span class="in">`tsk("spam")`</span> and <span class="in">`lrn("classif.log_reg")`</span>.</span>
<span id="cb182-529"><a href="#cb182-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-530"><a href="#cb182-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-016, warning=FALSE}</span></span>
<span id="cb182-531"><a href="#cb182-531" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3fselect)</span>
<span id="cb182-532"><a href="#cb182-532" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb182-533"><a href="#cb182-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-534"><a href="#cb182-534" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_fselector</span>(</span>
<span id="cb182-535"><a href="#cb182-535" aria-hidden="true" tabindex="-1"></a>  <span class="at">fselector =</span> <span class="fu">fs</span>(<span class="st">"random_search"</span>),</span>
<span id="cb182-536"><a href="#cb182-536" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>),</span>
<span id="cb182-537"><a href="#cb182-537" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>),</span>
<span id="cb182-538"><a href="#cb182-538" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb182-539"><a href="#cb182-539" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"evals"</span>, <span class="at">n_evals =</span> <span class="dv">50</span>)</span>
<span id="cb182-540"><a href="#cb182-540" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-541"><a href="#cb182-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-542"><a href="#cb182-542" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb182-543"><a href="#cb182-543" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> <span class="fu">tsk</span>(<span class="st">"spam"</span>),</span>
<span id="cb182-544"><a href="#cb182-544" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">list</span>(at, <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>)),</span>
<span id="cb182-545"><a href="#cb182-545" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb182-546"><a href="#cb182-546" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-547"><a href="#cb182-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-548"><a href="#cb182-548" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb182-549"><a href="#cb182-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-550"><a href="#cb182-550" aria-hidden="true" tabindex="-1"></a>aggr <span class="ot">=</span> bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.acc"</span>, <span class="st">"time_train"</span>)))</span>
<span id="cb182-551"><a href="#cb182-551" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(aggr)[, .(learner_id, classif.acc, time_train)]</span>
<span id="cb182-552"><a href="#cb182-552" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-553"><a href="#cb182-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-554"><a href="#cb182-554" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-pipelines</span></span>
<span id="cb182-555"><a href="#cb182-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-556"><a href="#cb182-556" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Concatenate the named PipeOps using <span class="in">`%&gt;&gt;%`</span>.</span>
<span id="cb182-557"><a href="#cb182-557" aria-hidden="true" tabindex="-1"></a>  To get a <span class="in">`r ref("Learner")`</span> object, use <span class="in">`r ref("as_learner()")`</span></span>
<span id="cb182-558"><a href="#cb182-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-001}</span></span>
<span id="cb182-559"><a href="#cb182-559" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb182-560"><a href="#cb182-560" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb182-561"><a href="#cb182-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-562"><a href="#cb182-562" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputeoor"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>)</span>
<span id="cb182-563"><a href="#cb182-563" aria-hidden="true" tabindex="-1"></a>graph_learner <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span>
<span id="cb182-564"><a href="#cb182-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-565"><a href="#cb182-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-566"><a href="#cb182-566" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>After training, the underlying <span class="in">`lrn("classif.log_reg")`</span> can be accessed through the <span class="in">`$base_learner()`</span> method.</span>
<span id="cb182-567"><a href="#cb182-567" aria-hidden="true" tabindex="-1"></a>  Alternatively, the learner can be accessed explicitly using <span class="in">`po("learner")`</span>.</span>
<span id="cb182-568"><a href="#cb182-568" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-002}</span></span>
<span id="cb182-569"><a href="#cb182-569" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb182-570"><a href="#cb182-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-571"><a href="#cb182-571" aria-hidden="true" tabindex="-1"></a><span class="co"># access the learner through the $base_learner() method</span></span>
<span id="cb182-572"><a href="#cb182-572" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> graph_learner<span class="sc">$</span><span class="fu">base_learner</span>()<span class="sc">$</span>model</span>
<span id="cb182-573"><a href="#cb182-573" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb182-574"><a href="#cb182-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-575"><a href="#cb182-575" aria-hidden="true" tabindex="-1"></a><span class="co"># access the learner explicitly through the PipeOp</span></span>
<span id="cb182-576"><a href="#cb182-576" aria-hidden="true" tabindex="-1"></a>pipeop <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>classif.log_reg</span>
<span id="cb182-577"><a href="#cb182-577" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> pipeop<span class="sc">$</span>learner_model<span class="sc">$</span>model</span>
<span id="cb182-578"><a href="#cb182-578" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model)</span>
<span id="cb182-579"><a href="#cb182-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-580"><a href="#cb182-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-581"><a href="#cb182-581" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Set the <span class="in">`$keep_results`</span> flag of the Graph to <span class="in">`TRUE`</span> to keep the results of the individual PipeOps.</span>
<span id="cb182-582"><a href="#cb182-582" aria-hidden="true" tabindex="-1"></a>  Afterwards, the input of the <span class="in">`lrn("classif.log_reg")`</span> can be accessed through the <span class="in">`$.result`</span> field of its predecessor, the <span class="in">`po("scale")`</span>.</span>
<span id="cb182-583"><a href="#cb182-583" aria-hidden="true" tabindex="-1"></a>  Note that the <span class="in">`$.result`</span> is a <span class="in">`list`</span>, we want to access its only element, named <span class="in">`$output`</span>.</span>
<span id="cb182-584"><a href="#cb182-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-003}</span></span>
<span id="cb182-585"><a href="#cb182-585" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span>graph<span class="sc">$</span>keep_results <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb182-586"><a href="#cb182-586" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"pima"</span>))</span>
<span id="cb182-587"><a href="#cb182-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-588"><a href="#cb182-588" aria-hidden="true" tabindex="-1"></a><span class="co"># access the input of the learner</span></span>
<span id="cb182-589"><a href="#cb182-589" aria-hidden="true" tabindex="-1"></a>scale_result <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>scale<span class="sc">$</span>.result</span>
<span id="cb182-590"><a href="#cb182-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-591"><a href="#cb182-591" aria-hidden="true" tabindex="-1"></a>scale_output_task <span class="ot">=</span> scale_result<span class="sc">$</span>output</span>
<span id="cb182-592"><a href="#cb182-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-593"><a href="#cb182-593" aria-hidden="true" tabindex="-1"></a>age_column <span class="ot">=</span> scale_output_task<span class="sc">$</span><span class="fu">data</span>()<span class="sc">$</span>age</span>
<span id="cb182-594"><a href="#cb182-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-595"><a href="#cb182-595" aria-hidden="true" tabindex="-1"></a><span class="co"># check if the age column is standardized:</span></span>
<span id="cb182-596"><a href="#cb182-596" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. does it have mean 0? -- almost, up to numerical precision!</span></span>
<span id="cb182-597"><a href="#cb182-597" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(age_column)</span>
<span id="cb182-598"><a href="#cb182-598" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. does it have standard deviation 1? -- yes!</span></span>
<span id="cb182-599"><a href="#cb182-599" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(age_column)</span>
<span id="cb182-600"><a href="#cb182-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-601"><a href="#cb182-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-602"><a href="#cb182-602" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-pipelines-nonseq</span></span>
<span id="cb182-603"><a href="#cb182-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-604"><a href="#cb182-604" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>To use <span class="in">`po("select")`</span> to *remove*, instead of *keep*, a feature based on a pattern, use <span class="in">`r ref("selector_invert")`</span> together with <span class="in">`r ref("selector_grep")`</span>.</span>
<span id="cb182-605"><a href="#cb182-605" aria-hidden="true" tabindex="-1"></a>  To remove the "<span class="in">`R`</span>" class columns in @sec-pipelines-stack, the following <span class="in">`po("select")`</span> could be used:</span>
<span id="cb182-606"><a href="#cb182-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-607"><a href="#cb182-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-004}</span></span>
<span id="cb182-608"><a href="#cb182-608" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"select"</span>, <span class="at">selector =</span> <span class="fu">selector_invert</span>(<span class="fu">selector_grep</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.R"</span>)))</span>
<span id="cb182-609"><a href="#cb182-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-610"><a href="#cb182-610" aria-hidden="true" tabindex="-1"></a>which would have the benefit that it would keep the columns pertaining to all other classes, even if the <span class="in">`"sonar"`</span> task had more target classes.</span>
<span id="cb182-611"><a href="#cb182-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-612"><a href="#cb182-612" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>A solution that does not need to specify the target classes at all is to use a custom <span class="in">`r ref("Selector")`</span>, as was shown in @sec-pipelines-bagging:</span>
<span id="cb182-613"><a href="#cb182-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-614"><a href="#cb182-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-005}</span></span>
<span id="cb182-615"><a href="#cb182-615" aria-hidden="true" tabindex="-1"></a>selector_remove_one_prob_column <span class="ot">=</span> <span class="cf">function</span>(task) {</span>
<span id="cb182-616"><a href="#cb182-616" aria-hidden="true" tabindex="-1"></a>  class_removing <span class="ot">=</span> task<span class="sc">$</span>class_names[[<span class="dv">1</span>]]</span>
<span id="cb182-617"><a href="#cb182-617" aria-hidden="true" tabindex="-1"></a>  selector_use <span class="ot">=</span> <span class="fu">selector_invert</span>(<span class="fu">selector_grep</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, class_removing)))</span>
<span id="cb182-618"><a href="#cb182-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-619"><a href="#cb182-619" aria-hidden="true" tabindex="-1"></a><span class="fu">selector_use</span>(task)</span>
<span id="cb182-620"><a href="#cb182-620" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-621"><a href="#cb182-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-622"><a href="#cb182-622" aria-hidden="true" tabindex="-1"></a>Using this selector in @sec-pipelines-stack, one could use the resulting stacking learner on any classification task with arbitrary target classes.</span>
<span id="cb182-623"><a href="#cb182-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-624"><a href="#cb182-624" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>As the first hint states, two <span class="in">`po("imputelearner")`</span> objects are necessary: one to impute missing values in factor columns using a classification learner, and another to impute missing values in numeric columns using a regression learner.</span>
<span id="cb182-625"><a href="#cb182-625" aria-hidden="true" tabindex="-1"></a>  Additionally, <span class="in">`ppl("robustify")`</span> is used along with the <span class="in">`r ref("ranger::ranger")`</span>-based learners inside <span class="in">`po("imputelearner")`</span> because the data passed to the imputation learners still contains missing values, which <span class="in">`ranger::ranger`</span> cannot handle.</span>
<span id="cb182-626"><a href="#cb182-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-627"><a href="#cb182-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-006}</span></span>
<span id="cb182-628"><a href="#cb182-628" aria-hidden="true" tabindex="-1"></a>gr_impute_factors <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputelearner"</span>, <span class="at">id =</span> <span class="st">"impute_factors"</span>,</span>
<span id="cb182-629"><a href="#cb182-629" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">ppl</span>(<span class="st">"robustify"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-630"><a href="#cb182-630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>),</span>
<span id="cb182-631"><a href="#cb182-631" aria-hidden="true" tabindex="-1"></a>  <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>)</span>
<span id="cb182-632"><a href="#cb182-632" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-633"><a href="#cb182-633" aria-hidden="true" tabindex="-1"></a>gr_impute_numerics <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"imputelearner"</span>, <span class="at">id =</span> <span class="st">"impute_numerics"</span>,</span>
<span id="cb182-634"><a href="#cb182-634" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> <span class="fu">ppl</span>(<span class="st">"robustify"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-635"><a href="#cb182-635" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>),</span>
<span id="cb182-636"><a href="#cb182-636" aria-hidden="true" tabindex="-1"></a>  <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="fu">c</span>(<span class="st">"numeric"</span>, <span class="st">"integer"</span>))</span>
<span id="cb182-637"><a href="#cb182-637" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-638"><a href="#cb182-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-639"><a href="#cb182-639" aria-hidden="true" tabindex="-1"></a>gr_impute <span class="ot">=</span> gr_impute_numerics <span class="sc">%&gt;&gt;%</span> gr_impute_factors</span>
<span id="cb182-640"><a href="#cb182-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-641"><a href="#cb182-641" aria-hidden="true" tabindex="-1"></a>imputed <span class="ot">=</span> gr_impute<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"penguins"</span>))[[<span class="dv">1</span>]]</span>
<span id="cb182-642"><a href="#cb182-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-643"><a href="#cb182-643" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. see how row 4 was imputed</span></span>
<span id="cb182-644"><a href="#cb182-644" aria-hidden="true" tabindex="-1"></a><span class="co"># original:</span></span>
<span id="cb182-645"><a href="#cb182-645" aria-hidden="true" tabindex="-1"></a><span class="fu">tsk</span>(<span class="st">"penguins"</span>)<span class="sc">$</span><span class="fu">data</span>(<span class="at">rows =</span> <span class="dv">4</span>)</span>
<span id="cb182-646"><a href="#cb182-646" aria-hidden="true" tabindex="-1"></a><span class="co"># imputed:</span></span>
<span id="cb182-647"><a href="#cb182-647" aria-hidden="true" tabindex="-1"></a>imputed<span class="sc">$</span><span class="fu">data</span>(<span class="at">rows =</span> <span class="dv">4</span>)</span>
<span id="cb182-648"><a href="#cb182-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-649"><a href="#cb182-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-650"><a href="#cb182-650" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions for @sec-preprocessing</span></span>
<span id="cb182-651"><a href="#cb182-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-652"><a href="#cb182-652" aria-hidden="true" tabindex="-1"></a>We will consider a similar prediction problem as throughout this section, using the King County Housing data instead (available with <span class="in">`tsk("kc_housing")`</span>).</span>
<span id="cb182-653"><a href="#cb182-653" aria-hidden="true" tabindex="-1"></a>To evaluate the models, we again use 10-fold cv and the mean absolute error.</span>
<span id="cb182-654"><a href="#cb182-654" aria-hidden="true" tabindex="-1"></a>The learner we want to use is a elastic-net regression by <span class="in">`lrn("regr.glmnet")`</span>.</span>
<span id="cb182-655"><a href="#cb182-655" aria-hidden="true" tabindex="-1"></a>For now we will ignore the <span class="in">`date`</span> column and simply remove it:</span>
<span id="cb182-656"><a href="#cb182-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-657"><a href="#cb182-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-658"><a href="#cb182-658" aria-hidden="true" tabindex="-1"></a>kc_housing <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"kc_housing"</span>)</span>
<span id="cb182-659"><a href="#cb182-659" aria-hidden="true" tabindex="-1"></a>kc_housing<span class="sc">$</span><span class="fu">select</span>(<span class="fu">setdiff</span>(kc_housing<span class="sc">$</span>feature_names, <span class="st">"date"</span>))</span>
<span id="cb182-660"><a href="#cb182-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-661"><a href="#cb182-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-662"><a href="#cb182-662" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Have a look at the features, are there any features which might be problematic? If so, change or remove them.</span>
<span id="cb182-663"><a href="#cb182-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-664"><a href="#cb182-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-665"><a href="#cb182-665" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(kc_housing)</span>
<span id="cb182-666"><a href="#cb182-666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-667"><a href="#cb182-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-668"><a href="#cb182-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-669"><a href="#cb182-669" aria-hidden="true" tabindex="-1"></a><span class="in">`zipcode`</span> should not really be interpreted as a numeric value, so we cast it to a factor.</span>
<span id="cb182-670"><a href="#cb182-670" aria-hidden="true" tabindex="-1"></a>We could argue to remove <span class="in">`lat`</span> and <span class="in">`long`</span> as handling them as linear effects is not necessarily a suitable, but we will keep them since <span class="in">`glmnet`</span> performs internal feature selection anyways.</span>
<span id="cb182-671"><a href="#cb182-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-672"><a href="#cb182-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-673"><a href="#cb182-673" aria-hidden="true" tabindex="-1"></a>zipencode <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>, <span class="at">mutation =</span> <span class="fu">list</span>(<span class="at">zipcode =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(zipcode)), <span class="at">id =</span> <span class="st">"zipencode"</span>)</span>
<span id="cb182-674"><a href="#cb182-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-675"><a href="#cb182-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-676"><a href="#cb182-676" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Check the dataset and learner properties to understand which preprocessing steps you need to do.</span>
<span id="cb182-677"><a href="#cb182-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-678"><a href="#cb182-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-679"><a href="#cb182-679" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(kc_housing)</span>
<span id="cb182-680"><a href="#cb182-680" aria-hidden="true" tabindex="-1"></a>kc_housing<span class="sc">$</span><span class="fu">missings</span>()</span>
<span id="cb182-681"><a href="#cb182-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-682"><a href="#cb182-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-683"><a href="#cb182-683" aria-hidden="true" tabindex="-1"></a>The data has missings and a categorical feature (since we are encoding the zipcode as a factor).</span>
<span id="cb182-684"><a href="#cb182-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-685"><a href="#cb182-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-686"><a href="#cb182-686" aria-hidden="true" tabindex="-1"></a>glmnet <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.glmnet"</span>)</span>
<span id="cb182-687"><a href="#cb182-687" aria-hidden="true" tabindex="-1"></a>glmnet<span class="sc">$</span>properties</span>
<span id="cb182-688"><a href="#cb182-688" aria-hidden="true" tabindex="-1"></a>glmnet<span class="sc">$</span>feature_types</span>
<span id="cb182-689"><a href="#cb182-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-690"><a href="#cb182-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-691"><a href="#cb182-691" aria-hidden="true" tabindex="-1"></a><span class="in">`glmnet`</span> does not support factors or missing values. So our pipeline needs to handle both.</span>
<span id="cb182-692"><a href="#cb182-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-693"><a href="#cb182-693" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Build a suitable pipeline that allows glmnet to be trained on the dataset.</span>
<span id="cb182-694"><a href="#cb182-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-695"><a href="#cb182-695" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-696"><a href="#cb182-696" aria-hidden="true" tabindex="-1"></a>glmnet_preproc <span class="ot">=</span> GraphLearner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-697"><a href="#cb182-697" aria-hidden="true" tabindex="-1"></a>  zipencode <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-698"><a href="#cb182-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"fixfactors"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-699"><a href="#cb182-699" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"encodeimpact"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-700"><a href="#cb182-700" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb182-701"><a href="#cb182-701" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"missind"</span>,</span>
<span id="cb182-702"><a href="#cb182-702" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">"integer"</span>,</span>
<span id="cb182-703"><a href="#cb182-703" aria-hidden="true" tabindex="-1"></a>        <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>)</span>
<span id="cb182-704"><a href="#cb182-704" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb182-705"><a href="#cb182-705" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"imputehist"</span>,</span>
<span id="cb182-706"><a href="#cb182-706" aria-hidden="true" tabindex="-1"></a>        <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"integer"</span>)</span>
<span id="cb182-707"><a href="#cb182-707" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-708"><a href="#cb182-708" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"featureunion"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-709"><a href="#cb182-709" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"imputeoor"</span>,</span>
<span id="cb182-710"><a href="#cb182-710" aria-hidden="true" tabindex="-1"></a>        <span class="at">affect_columns =</span> <span class="fu">selector_type</span>(<span class="st">"factor"</span>)</span>
<span id="cb182-711"><a href="#cb182-711" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-712"><a href="#cb182-712" aria-hidden="true" tabindex="-1"></a>    glmnet,</span>
<span id="cb182-713"><a href="#cb182-713" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="st">"regr.glmnet_preproc"</span>)</span>
<span id="cb182-714"><a href="#cb182-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-715"><a href="#cb182-715" aria-hidden="true" tabindex="-1"></a>log_glmnet_preproc <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"targettrafo"</span>, <span class="at">graph =</span> glmnet_preproc)</span>
<span id="cb182-716"><a href="#cb182-716" aria-hidden="true" tabindex="-1"></a>log_glmnet_preproc<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>targetmutate.trafo <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x)</span>
<span id="cb182-717"><a href="#cb182-717" aria-hidden="true" tabindex="-1"></a>log_glmnet_preproc<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>targetmutate.inverter <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">list</span>(<span class="at">response =</span> <span class="fu">exp</span>(x<span class="sc">$</span>response))</span>
<span id="cb182-718"><a href="#cb182-718" aria-hidden="true" tabindex="-1"></a>log_glmnet_preproc <span class="ot">=</span> GraphLearner<span class="sc">$</span><span class="fu">new</span>(log_glmnet_preproc, <span class="at">id =</span> <span class="st">"regr.log_glmnet_preproc"</span>)</span>
<span id="cb182-719"><a href="#cb182-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-720"><a href="#cb182-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-721"><a href="#cb182-721" aria-hidden="true" tabindex="-1"></a>First we fix the factor levels to ensure that all 70 zipcodes are fixed.</span>
<span id="cb182-722"><a href="#cb182-722" aria-hidden="true" tabindex="-1"></a>We can consider 70 levels high cardinality, so we use impact encoding.</span>
<span id="cb182-723"><a href="#cb182-723" aria-hidden="true" tabindex="-1"></a>We use the same imputation strategy as in @sec-preprocessing.</span>
<span id="cb182-724"><a href="#cb182-724" aria-hidden="true" tabindex="-1"></a>Since the target is highly skewed, we also apply a log-transformation of the target.</span>
<span id="cb182-725"><a href="#cb182-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-726"><a href="#cb182-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-727"><a href="#cb182-727" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>As a comparison, apply <span class="in">`pipeline_robustify`</span> to glmnet and compare the results with your pipeline.</span>
<span id="cb182-728"><a href="#cb182-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-729"><a href="#cb182-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-730"><a href="#cb182-730" aria-hidden="true" tabindex="-1"></a>glmnet_robustify <span class="ot">=</span> GraphLearner<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb182-731"><a href="#cb182-731" aria-hidden="true" tabindex="-1"></a>    zipencode <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-732"><a href="#cb182-732" aria-hidden="true" tabindex="-1"></a>    mlr3pipelines<span class="sc">::</span><span class="fu">pipeline_robustify</span>() <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-733"><a href="#cb182-733" aria-hidden="true" tabindex="-1"></a>      glmnet,</span>
<span id="cb182-734"><a href="#cb182-734" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"regr.glmnet_robustify"</span></span>
<span id="cb182-735"><a href="#cb182-735" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-736"><a href="#cb182-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-737"><a href="#cb182-737" aria-hidden="true" tabindex="-1"></a>log_glmnet_robustify <span class="ot">=</span> <span class="fu">ppl</span>(<span class="st">"targettrafo"</span>, <span class="at">graph =</span> glmnet_robustify)</span>
<span id="cb182-738"><a href="#cb182-738" aria-hidden="true" tabindex="-1"></a>log_glmnet_robustify<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>targetmutate.trafo <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x)</span>
<span id="cb182-739"><a href="#cb182-739" aria-hidden="true" tabindex="-1"></a>log_glmnet_robustify<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>targetmutate.inverter <span class="ot">=</span> <span class="cf">function</span>(x) <span class="fu">list</span>(<span class="at">response =</span> <span class="fu">exp</span>(x<span class="sc">$</span>response))</span>
<span id="cb182-740"><a href="#cb182-740" aria-hidden="true" tabindex="-1"></a>log_glmnet_robustify <span class="ot">=</span> GraphLearner<span class="sc">$</span><span class="fu">new</span>(log_glmnet_robustify, <span class="at">id =</span> <span class="st">"regr.log_glmnet_robustify"</span>)</span>
<span id="cb182-741"><a href="#cb182-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-742"><a href="#cb182-742" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb182-743"><a href="#cb182-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"regr.featureless"</span>, <span class="at">robust =</span> <span class="cn">TRUE</span>),</span>
<span id="cb182-744"><a href="#cb182-744" aria-hidden="true" tabindex="-1"></a>  glmnet_preproc,</span>
<span id="cb182-745"><a href="#cb182-745" aria-hidden="true" tabindex="-1"></a>  log_glmnet_preproc,</span>
<span id="cb182-746"><a href="#cb182-746" aria-hidden="true" tabindex="-1"></a>  glmnet_robustify,</span>
<span id="cb182-747"><a href="#cb182-747" aria-hidden="true" tabindex="-1"></a>  log_glmnet_robustify</span>
<span id="cb182-748"><a href="#cb182-748" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-749"><a href="#cb182-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-750"><a href="#cb182-750" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(123L)</span>
<span id="cb182-751"><a href="#cb182-751" aria-hidden="true" tabindex="-1"></a>cv10 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>)</span>
<span id="cb182-752"><a href="#cb182-752" aria-hidden="true" tabindex="-1"></a>cv10<span class="sc">$</span><span class="fu">instantiate</span>(kc_housing)</span>
<span id="cb182-753"><a href="#cb182-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-754"><a href="#cb182-754" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(kc_housing, <span class="at">learners =</span> learners, cv10)</span>
<span id="cb182-755"><a href="#cb182-755" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb182-756"><a href="#cb182-756" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.mae"</span>))[, .(learner_id, regr.mae)]</span>
<span id="cb182-757"><a href="#cb182-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-758"><a href="#cb182-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-759"><a href="#cb182-759" aria-hidden="true" tabindex="-1"></a>The log-transformed <span class="in">`glmnet`</span> with impact encoding results in the best model, although only by a very small margin.</span>
<span id="cb182-760"><a href="#cb182-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-761"><a href="#cb182-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-762"><a href="#cb182-762" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Consider the <span class="in">`date`</span> feature: How can you extract information from this feature that <span class="in">`glmnet`</span> can use? Check how much this improves your pipeline.</span>
<span id="cb182-763"><a href="#cb182-763" aria-hidden="true" tabindex="-1"></a>Also consider the spatial nature of the dataset: Can you extract an additional feature from the lat/long coordinates? (Hint: Downtown Seattle has lat/long coordinates <span class="in">`47.605`</span>/<span class="in">`-122.334`</span>).</span>
<span id="cb182-764"><a href="#cb182-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-765"><a href="#cb182-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-766"><a href="#cb182-766" aria-hidden="true" tabindex="-1"></a>extractors <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>, <span class="at">mutation =</span> <span class="fu">list</span>(</span>
<span id="cb182-767"><a href="#cb182-767" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(date),</span>
<span id="cb182-768"><a href="#cb182-768" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance_downtown =</span> <span class="sc">~</span> <span class="fu">sqrt</span>((lat <span class="sc">-</span> <span class="fl">47.605</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (long  <span class="sc">+</span> <span class="fl">122.334</span>)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb182-769"><a href="#cb182-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-770"><a href="#cb182-770" aria-hidden="true" tabindex="-1"></a>kc_housing_full <span class="ot">=</span> extractors<span class="sc">$</span><span class="fu">train</span>(<span class="fu">list</span>(<span class="fu">tsk</span>(<span class="st">"kc_housing"</span>)))[[<span class="dv">1</span>]]</span>
<span id="cb182-771"><a href="#cb182-771" aria-hidden="true" tabindex="-1"></a>kc_housing_full<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"kc_housing_feat_extr"</span></span>
<span id="cb182-772"><a href="#cb182-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-773"><a href="#cb182-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-774"><a href="#cb182-774" aria-hidden="true" tabindex="-1"></a>design_ext <span class="ot">=</span> <span class="fu">benchmark_grid</span>(kc_housing_full, <span class="at">learners =</span> learners, cv10)</span>
<span id="cb182-775"><a href="#cb182-775" aria-hidden="true" tabindex="-1"></a>bmr_ext <span class="ot">=</span> <span class="fu">benchmark</span>(design_ext)</span>
<span id="cb182-776"><a href="#cb182-776" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">combine</span>(bmr_ext)</span>
<span id="cb182-777"><a href="#cb182-777" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"regr.mae"</span>))[, .(learner_id, task_id, regr.mae)]</span>
<span id="cb182-778"><a href="#cb182-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-779"><a href="#cb182-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-780"><a href="#cb182-780" aria-hidden="true" tabindex="-1"></a>We simply convert the <span class="in">`date`</span> feature into a numeric timestamp so that <span class="in">`glmnet`</span> can handle the feature.</span>
<span id="cb182-781"><a href="#cb182-781" aria-hidden="true" tabindex="-1"></a>We create one additional feature as the distance to downtown Seattle.</span>
<span id="cb182-782"><a href="#cb182-782" aria-hidden="true" tabindex="-1"></a>This improves the average error of our model by a further 1600$.</span>
<span id="cb182-783"><a href="#cb182-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-784"><a href="#cb182-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-785"><a href="#cb182-785" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-special</span></span>
<span id="cb182-786"><a href="#cb182-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-787"><a href="#cb182-787" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Run a benchmark experiment on the <span class="in">`"german_credit"`</span> task with algorithms: <span class="in">`lrn("classif.featureless")`</span>, <span class="in">`lrn("classif.log_reg")`</span>, <span class="in">`lrn("classif.ranger")`</span>. Tune the <span class="in">`lrn("classif.featureless")`</span> model using <span class="in">`tunetreshold`</span> and <span class="in">`learner_cv`</span>. Use two-fold CV and evaluate with <span class="in">`msr("classif.costs", costs = costs)`</span> where you should make the parameter <span class="in">`costs`</span> so that the cost of a true positive is -10, the cost of a true negative is -1, the cost of a false positive is 2, and the cost of a false negative is 3. Use <span class="in">`set.seed(11)`</span> to make sure you get the same results as us. Are your results surprising?</span>
<span id="cb182-788"><a href="#cb182-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-789"><a href="#cb182-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-017}</span></span>
<span id="cb182-790"><a href="#cb182-790" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb182-791"><a href="#cb182-791" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb182-792"><a href="#cb182-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-793"><a href="#cb182-793" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">dimnames =</span></span>
<span id="cb182-794"><a href="#cb182-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"Predicted Credit"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>),</span>
<span id="cb182-795"><a href="#cb182-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">Truth =</span> <span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>)))</span>
<span id="cb182-796"><a href="#cb182-796" aria-hidden="true" tabindex="-1"></a>msr_costs <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"classif.costs"</span>, <span class="at">costs =</span> costs)</span>
<span id="cb182-797"><a href="#cb182-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-798"><a href="#cb182-798" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="fu">lrn</span>(<span class="st">"classif.featureless"</span>, <span class="at">predict_type =</span> <span class="st">"prob"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-799"><a href="#cb182-799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"tunethreshold"</span>, <span class="at">measure =</span> msr_costs)</span>
<span id="cb182-800"><a href="#cb182-800" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"german_credit"</span>)</span>
<span id="cb182-801"><a href="#cb182-801" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">as_learner</span>(gr), <span class="fu">lrn</span>(<span class="st">"classif.log_reg"</span>), <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>))</span>
<span id="cb182-802"><a href="#cb182-802" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">2</span>)))</span>
<span id="cb182-803"><a href="#cb182-803" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(msr_costs)[, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">7</span>)]</span>
<span id="cb182-804"><a href="#cb182-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-805"><a href="#cb182-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-806"><a href="#cb182-806" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Train and predict a survival forest using <span class="in">`rfsrc`</span> (from <span class="in">`mlr3extralearners`</span>). Run this experiment using <span class="in">`task = tsk("rats"); split = partition(task)`</span>. Evaluate your model with the RCLL measure.</span>
<span id="cb182-807"><a href="#cb182-807" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-018}</span></span>
<span id="cb182-808"><a href="#cb182-808" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb182-809"><a href="#cb182-809" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb182-810"><a href="#cb182-810" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb182-811"><a href="#cb182-811" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb182-812"><a href="#cb182-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-813"><a href="#cb182-813" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"rats"</span>)</span>
<span id="cb182-814"><a href="#cb182-814" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb182-815"><a href="#cb182-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-816"><a href="#cb182-816" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"surv.rfsrc"</span>)<span class="sc">$</span></span>
<span id="cb182-817"><a href="#cb182-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">train</span>(task, split<span class="sc">$</span>train)<span class="sc">$</span></span>
<span id="cb182-818"><a href="#cb182-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(task, split<span class="sc">$</span>test)<span class="sc">$</span></span>
<span id="cb182-819"><a href="#cb182-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"surv.rcll"</span>))</span>
<span id="cb182-820"><a href="#cb182-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-821"><a href="#cb182-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-822"><a href="#cb182-822" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Estimate the density of the <span class="in">`tsk("precip")`</span> data using <span class="in">`lrn("dens.logspline")`</span> (from <span class="in">`mlr3extralearners`</span>). Run this experiment using <span class="in">`task = tsk("precip"); split = partition(task)`</span>. Evaluate your model with the logloss measure.</span>
<span id="cb182-823"><a href="#cb182-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-019}</span></span>
<span id="cb182-824"><a href="#cb182-824" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb182-825"><a href="#cb182-825" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3proba)</span>
<span id="cb182-826"><a href="#cb182-826" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3extralearners)</span>
<span id="cb182-827"><a href="#cb182-827" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb182-828"><a href="#cb182-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-829"><a href="#cb182-829" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"precip"</span>)</span>
<span id="cb182-830"><a href="#cb182-830" aria-hidden="true" tabindex="-1"></a>split <span class="ot">=</span> <span class="fu">partition</span>(task)</span>
<span id="cb182-831"><a href="#cb182-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-832"><a href="#cb182-832" aria-hidden="true" tabindex="-1"></a><span class="fu">lrn</span>(<span class="st">"dens.logspline"</span>)<span class="sc">$</span></span>
<span id="cb182-833"><a href="#cb182-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">train</span>(task, split<span class="sc">$</span>train)<span class="sc">$</span></span>
<span id="cb182-834"><a href="#cb182-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(task, split<span class="sc">$</span>test)<span class="sc">$</span></span>
<span id="cb182-835"><a href="#cb182-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"dens.logloss"</span>))</span>
<span id="cb182-836"><a href="#cb182-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-837"><a href="#cb182-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-838"><a href="#cb182-838" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Run a benchmark clustering experiment on the <span class="in">`wine`</span> dataset without a label column. Compare the performance of <span class="in">`"clust.kmeans"`</span> learner with <span class="in">`k`</span> equal to 2, 3 and 4 using the silhouette measure. Use insample resampling technique. What value of <span class="in">`k`</span> would you choose based on the silhouette scores?</span>
<span id="cb182-839"><a href="#cb182-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-840"><a href="#cb182-840" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-020}</span></span>
<span id="cb182-841"><a href="#cb182-841" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb182-842"><a href="#cb182-842" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3cluster)</span>
<span id="cb182-843"><a href="#cb182-843" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb182-844"><a href="#cb182-844" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb182-845"><a href="#cb182-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> 2L, <span class="at">id =</span> <span class="st">"k-means, k=2"</span>),</span>
<span id="cb182-846"><a href="#cb182-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> 3L, <span class="at">id =</span> <span class="st">"k-means, k=3"</span>),</span>
<span id="cb182-847"><a href="#cb182-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"clust.kmeans"</span>, <span class="at">centers =</span> 4L, <span class="at">id =</span> <span class="st">"k-means, k=4"</span>)</span>
<span id="cb182-848"><a href="#cb182-848" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-849"><a href="#cb182-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-850"><a href="#cb182-850" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_clust</span>(<span class="fu">tsk</span>(<span class="st">"wine"</span>)<span class="sc">$</span><span class="fu">data</span>()[, <span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb182-851"><a href="#cb182-851" aria-hidden="true" tabindex="-1"></a>measure <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"clust.silhouette"</span>)</span>
<span id="cb182-852"><a href="#cb182-852" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(task, learners, <span class="fu">rsmp</span>(<span class="st">"insample"</span>)))</span>
<span id="cb182-853"><a href="#cb182-853" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(measure)[, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">7</span>)]</span>
<span id="cb182-854"><a href="#cb182-854" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-855"><a href="#cb182-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-856"><a href="#cb182-856" aria-hidden="true" tabindex="-1"></a>Based on the silhouette score, we can choose <span class="in">`k = 2`</span>.</span>
<span id="cb182-857"><a href="#cb182-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-858"><a href="#cb182-858" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Run a (spatially) unbiased classification benchmark experiment on the <span class="in">`"ecuador"`</span> task with a featureless learner and xgboost, evaluate with the binary Brier score.</span>
<span id="cb182-859"><a href="#cb182-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-860"><a href="#cb182-860" aria-hidden="true" tabindex="-1"></a>You can use any resampling method from <span class="in">`r mlr3spatiotempcv`</span>, in this solution we use 4-fold spatial environmental blocking.</span>
<span id="cb182-861"><a href="#cb182-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-862"><a href="#cb182-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-021}</span></span>
<span id="cb182-863"><a href="#cb182-863" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb182-864"><a href="#cb182-864" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3spatial)</span>
<span id="cb182-865"><a href="#cb182-865" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3spatiotempcv)</span>
<span id="cb182-866"><a href="#cb182-866" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11</span>)</span>
<span id="cb182-867"><a href="#cb182-867" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">lrns</span>(<span class="fu">paste0</span>(<span class="st">"classif."</span>, <span class="fu">c</span>(<span class="st">"xgboost"</span>, <span class="st">"featureless"</span>)),</span>
<span id="cb182-868"><a href="#cb182-868" aria-hidden="true" tabindex="-1"></a>  <span class="at">predict_type =</span> <span class="st">"prob"</span>)</span>
<span id="cb182-869"><a href="#cb182-869" aria-hidden="true" tabindex="-1"></a>rsmp_sp <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"spcv_env"</span>, <span class="at">folds =</span> <span class="dv">4</span>)</span>
<span id="cb182-870"><a href="#cb182-870" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(<span class="fu">tsk</span>(<span class="st">"ecuador"</span>), learners, rsmp_sp)</span>
<span id="cb182-871"><a href="#cb182-871" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb182-872"><a href="#cb182-872" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msr</span>(<span class="st">"classif.bbrier"</span>))[, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">7</span>)]</span>
<span id="cb182-873"><a href="#cb182-873" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-874"><a href="#cb182-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-875"><a href="#cb182-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-876"><a href="#cb182-876" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-technical</span></span>
<span id="cb182-877"><a href="#cb182-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-878"><a href="#cb182-878" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Consider the following example where you resample a learner (debug learner, sleeps for 3 seconds during train) on 4 workers using the multisession backend:</span>
<span id="cb182-879"><a href="#cb182-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{r technical-050, eval = FALSE}</span></span>
<span id="cb182-880"><a href="#cb182-880" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb182-881"><a href="#cb182-881" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.debug"</span>, <span class="at">sleep_train =</span> <span class="cf">function</span>() <span class="dv">3</span>)</span>
<span id="cb182-882"><a href="#cb182-882" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">6</span>)</span>
<span id="cb182-883"><a href="#cb182-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-884"><a href="#cb182-884" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">4</span>)</span>
<span id="cb182-885"><a href="#cb182-885" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, learner, resampling)</span>
<span id="cb182-886"><a href="#cb182-886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-887"><a href="#cb182-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-888"><a href="#cb182-888" aria-hidden="true" tabindex="-1"></a>i. Assuming that the learner would actually calculate something and not just sleep: Would all CPUs be busy?</span>
<span id="cb182-889"><a href="#cb182-889" aria-hidden="true" tabindex="-1"></a>ii. Prove your point by measuring the elapsed time, e.g., using <span class="in">`r ref("system.time()")`</span>.</span>
<span id="cb182-890"><a href="#cb182-890" aria-hidden="true" tabindex="-1"></a>iii. What would you change in the setup and why?</span>
<span id="cb182-891"><a href="#cb182-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-892"><a href="#cb182-892" aria-hidden="true" tabindex="-1"></a>Not all CPUs would be utilized in the example.</span>
<span id="cb182-893"><a href="#cb182-893" aria-hidden="true" tabindex="-1"></a>All 4 of them are occupied for the first 4 iterations of the cross validation.</span>
<span id="cb182-894"><a href="#cb182-894" aria-hidden="true" tabindex="-1"></a>The 5th iteration, however, only runs in parallel to the 6th fold, leaving 2 cores idle.</span>
<span id="cb182-895"><a href="#cb182-895" aria-hidden="true" tabindex="-1"></a>This is supported by the elapsed time of roughly 6 seconds for 6 jobs compared to also roughly 6 seconds for 8 jobs:</span>
<span id="cb182-896"><a href="#cb182-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-897"><a href="#cb182-897" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-022, eval = FALSE}</span></span>
<span id="cb182-898"><a href="#cb182-898" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"penguins"</span>)</span>
<span id="cb182-899"><a href="#cb182-899" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.debug"</span>, <span class="at">sleep_train =</span> <span class="cf">function</span>() <span class="dv">3</span>)</span>
<span id="cb182-900"><a href="#cb182-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-901"><a href="#cb182-901" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"multisession"</span>, <span class="at">workers =</span> <span class="dv">4</span>)</span>
<span id="cb182-902"><a href="#cb182-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-903"><a href="#cb182-903" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">6</span>)</span>
<span id="cb182-904"><a href="#cb182-904" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">resample</span>(task, learner, resampling))</span>
<span id="cb182-905"><a href="#cb182-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-906"><a href="#cb182-906" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">8</span>)</span>
<span id="cb182-907"><a href="#cb182-907" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">resample</span>(task, learner, resampling))</span>
<span id="cb182-908"><a href="#cb182-908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-909"><a href="#cb182-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-910"><a href="#cb182-910" aria-hidden="true" tabindex="-1"></a>If possible, the number of resampling iterations should be an integer multiple of the number of workers.</span>
<span id="cb182-911"><a href="#cb182-911" aria-hidden="true" tabindex="-1"></a>Therefore, a simple adaptation either increases the number of folds for improved accuracy of the error estimate or reduces the number of folds for improved runtime.</span>
<span id="cb182-912"><a href="#cb182-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-913"><a href="#cb182-913" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Create a new custom classification measure (either using methods demonstrated in @sec-extending or with <span class="in">`msr("classif.costs")`</span> which scores predictions using the mean over the following classification costs:</span>
<span id="cb182-914"><a href="#cb182-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-915"><a href="#cb182-915" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the learner predicted label "A" and the truth is "A", assign score 0</span>
<span id="cb182-916"><a href="#cb182-916" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the learner predicted label "B" and the truth is "B", assign score 0</span>
<span id="cb182-917"><a href="#cb182-917" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the learner predicted label "A" and the truth is "B", assign score 1</span>
<span id="cb182-918"><a href="#cb182-918" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If the learner predicted label "B" and the truth is "A", assign score 10</span>
<span id="cb182-919"><a href="#cb182-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-920"><a href="#cb182-920" aria-hidden="true" tabindex="-1"></a>The rules can easily be translated to R code where we expect <span class="in">`truth`</span> and <span class="in">`prediction`</span> to be factor vectors of the same length with levels <span class="in">`"A"`</span> and <span class="in">`"B"`</span>:</span>
<span id="cb182-921"><a href="#cb182-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-922"><a href="#cb182-922" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-023}</span></span>
<span id="cb182-923"><a href="#cb182-923" aria-hidden="true" tabindex="-1"></a>costsens <span class="ot">=</span> <span class="cf">function</span>(truth, prediction) {</span>
<span id="cb182-924"><a href="#cb182-924" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">=</span> <span class="fu">numeric</span>(<span class="fu">length</span>(truth))</span>
<span id="cb182-925"><a href="#cb182-925" aria-hidden="true" tabindex="-1"></a>    score[truth <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">&amp;</span> prediction <span class="sc">==</span> <span class="st">"B"</span>] <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb182-926"><a href="#cb182-926" aria-hidden="true" tabindex="-1"></a>    score[truth <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">&amp;</span> prediction <span class="sc">==</span> <span class="st">"A"</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb182-927"><a href="#cb182-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-928"><a href="#cb182-928" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(score)</span>
<span id="cb182-929"><a href="#cb182-929" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-930"><a href="#cb182-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-931"><a href="#cb182-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-932"><a href="#cb182-932" aria-hidden="true" tabindex="-1"></a>This function can be embedded in the <span class="in">`Measure`</span> class accordingly.</span>
<span id="cb182-933"><a href="#cb182-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-934"><a href="#cb182-934" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-024}</span></span>
<span id="cb182-935"><a href="#cb182-935" aria-hidden="true" tabindex="-1"></a>MeasureCustom <span class="ot">=</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(<span class="st">"MeasureCustom"</span>,</span>
<span id="cb182-936"><a href="#cb182-936" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> mlr3<span class="sc">::</span>MeasureClassif, <span class="co"># classification measure</span></span>
<span id="cb182-937"><a href="#cb182-937" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb182-938"><a href="#cb182-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() { <span class="co"># initialize class</span></span>
<span id="cb182-939"><a href="#cb182-939" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb182-940"><a href="#cb182-940" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"custom"</span>, <span class="co"># unique ID</span></span>
<span id="cb182-941"><a href="#cb182-941" aria-hidden="true" tabindex="-1"></a>        <span class="at">packages =</span> <span class="fu">character</span>(), <span class="co"># no dependencies</span></span>
<span id="cb182-942"><a href="#cb182-942" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="fu">character</span>(), <span class="co"># no special properties</span></span>
<span id="cb182-943"><a href="#cb182-943" aria-hidden="true" tabindex="-1"></a>        <span class="at">predict_type =</span> <span class="st">"response"</span>, <span class="co"># measures response prediction</span></span>
<span id="cb182-944"><a href="#cb182-944" aria-hidden="true" tabindex="-1"></a>        <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">Inf</span>), <span class="co"># results in values between (0, 1)</span></span>
<span id="cb182-945"><a href="#cb182-945" aria-hidden="true" tabindex="-1"></a>        <span class="at">minimize =</span> <span class="cn">TRUE</span> <span class="co"># smaller values are better</span></span>
<span id="cb182-946"><a href="#cb182-946" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb182-947"><a href="#cb182-947" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb182-948"><a href="#cb182-948" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb182-949"><a href="#cb182-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-950"><a href="#cb182-950" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb182-951"><a href="#cb182-951" aria-hidden="true" tabindex="-1"></a>    <span class="at">.score =</span> <span class="cf">function</span>(prediction, ...) { <span class="co"># define score as private method</span></span>
<span id="cb182-952"><a href="#cb182-952" aria-hidden="true" tabindex="-1"></a>      <span class="co"># define loss</span></span>
<span id="cb182-953"><a href="#cb182-953" aria-hidden="true" tabindex="-1"></a>      costsens <span class="ot">=</span> <span class="cf">function</span>(truth, prediction) {</span>
<span id="cb182-954"><a href="#cb182-954" aria-hidden="true" tabindex="-1"></a>        score <span class="ot">=</span> <span class="fu">numeric</span>(<span class="fu">length</span>(truth))</span>
<span id="cb182-955"><a href="#cb182-955" aria-hidden="true" tabindex="-1"></a>        score[truth <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">&amp;</span> prediction <span class="sc">==</span> <span class="st">"B"</span>] <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb182-956"><a href="#cb182-956" aria-hidden="true" tabindex="-1"></a>        score[truth <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">&amp;</span> prediction <span class="sc">==</span> <span class="st">"A"</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb182-957"><a href="#cb182-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-958"><a href="#cb182-958" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(score)</span>
<span id="cb182-959"><a href="#cb182-959" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb182-960"><a href="#cb182-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-961"><a href="#cb182-961" aria-hidden="true" tabindex="-1"></a>      <span class="co"># call loss function</span></span>
<span id="cb182-962"><a href="#cb182-962" aria-hidden="true" tabindex="-1"></a>      <span class="fu">costsens</span>(prediction<span class="sc">$</span>truth, prediction<span class="sc">$</span>response)</span>
<span id="cb182-963"><a href="#cb182-963" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb182-964"><a href="#cb182-964" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb182-965"><a href="#cb182-965" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-966"><a href="#cb182-966" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-967"><a href="#cb182-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-968"><a href="#cb182-968" aria-hidden="true" tabindex="-1"></a>An alternative (as pointed to by the hint) can be constructed by first translating the rules to a matrix of misclassification costs, and then feeding this matrix to the constructor of <span class="in">`msr("classif.costs")`</span>:</span>
<span id="cb182-969"><a href="#cb182-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-970"><a href="#cb182-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-025}</span></span>
<span id="cb182-971"><a href="#cb182-971" aria-hidden="true" tabindex="-1"></a><span class="co"># truth in columns, prediction in rows</span></span>
<span id="cb182-972"><a href="#cb182-972" aria-hidden="true" tabindex="-1"></a>C <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb182-973"><a href="#cb182-973" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(C) <span class="ot">=</span> <span class="fu">colnames</span>(C) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>)</span>
<span id="cb182-974"><a href="#cb182-974" aria-hidden="true" tabindex="-1"></a>C</span>
<span id="cb182-975"><a href="#cb182-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-976"><a href="#cb182-976" aria-hidden="true" tabindex="-1"></a><span class="fu">msr</span>(<span class="st">"classif.costs"</span>, <span class="at">costs =</span> C)</span>
<span id="cb182-977"><a href="#cb182-977" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-978"><a href="#cb182-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-979"><a href="#cb182-979" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-large-benchmarking</span></span>
<span id="cb182-980"><a href="#cb182-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-981"><a href="#cb182-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-982"><a href="#cb182-982" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Load the OpenML collection with ID 269, which contains regression tasks from the AutoML benchmark <span class="co">[</span><span class="ot">@amlb2022</span><span class="co">]</span>.</span>
<span id="cb182-983"><a href="#cb182-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-984"><a href="#cb182-984" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-026}</span></span>
<span id="cb182-985"><a href="#cb182-985" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb182-986"><a href="#cb182-986" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-987"><a href="#cb182-987" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3oml)</span>
<span id="cb182-988"><a href="#cb182-988" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3oml"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"off"</span>)</span>
<span id="cb182-989"><a href="#cb182-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-990"><a href="#cb182-990" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"openml"</span>)) {</span>
<span id="cb182-991"><a href="#cb182-991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">"openml"</span>, <span class="st">"manual"</span>), <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb182-992"><a href="#cb182-992" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-993"><a href="#cb182-993" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mlr3oml.cache =</span> <span class="fu">file.path</span>(<span class="st">"openml"</span>, <span class="st">"cache"</span>))</span>
<span id="cb182-994"><a href="#cb182-994" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-995"><a href="#cb182-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-996"><a href="#cb182-996" aria-hidden="true" tabindex="-1"></a>We access the AutoML benchmark suite with ID 269 using the <span class="in">`r ref("mlr3oml::ocl()")`</span> function.</span>
<span id="cb182-997"><a href="#cb182-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1000"><a href="#cb182-1000" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1001"><a href="#cb182-1001" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-1002"><a href="#cb182-1002" aria-hidden="true" tabindex="-1"></a>path_automl_suite <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">"openml"</span>, <span class="st">"manual"</span>, <span class="st">"automl_suite.rds"</span>)</span>
<span id="cb182-1003"><a href="#cb182-1003" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1004"><a href="#cb182-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1005"><a href="#cb182-1005" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-028, eval = !file.exists(path_automl_suite)}</span></span>
<span id="cb182-1006"><a href="#cb182-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3oml)</span>
<span id="cb182-1007"><a href="#cb182-1007" aria-hidden="true" tabindex="-1"></a>automl_suite <span class="ot">=</span> <span class="fu">ocl</span>(<span class="at">id =</span> <span class="dv">269</span>)</span>
<span id="cb182-1008"><a href="#cb182-1008" aria-hidden="true" tabindex="-1"></a>automl_suite<span class="sc">$</span>task_ids</span>
<span id="cb182-1009"><a href="#cb182-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1010"><a href="#cb182-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1013"><a href="#cb182-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1014"><a href="#cb182-1014" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-1015"><a href="#cb182-1015" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(path_automl_suite)) {</span>
<span id="cb182-1016"><a href="#cb182-1016" aria-hidden="true" tabindex="-1"></a>  automl_suite <span class="ot">=</span> <span class="fu">readRDS</span>(path_automl_suite)</span>
<span id="cb182-1017"><a href="#cb182-1017" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb182-1018"><a href="#cb182-1018" aria-hidden="true" tabindex="-1"></a>  <span class="co"># need to access the ids to trigger the download</span></span>
<span id="cb182-1019"><a href="#cb182-1019" aria-hidden="true" tabindex="-1"></a>  automl_suite<span class="sc">$</span>task_ids</span>
<span id="cb182-1020"><a href="#cb182-1020" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(automl_suite, path_automl_suite)</span>
<span id="cb182-1021"><a href="#cb182-1021" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-1022"><a href="#cb182-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1023"><a href="#cb182-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1024"><a href="#cb182-1024" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Find all tasks with less than 4000 observations and convert them to <span class="in">`mlr3`</span> tasks.</span>
<span id="cb182-1025"><a href="#cb182-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1026"><a href="#cb182-1026" aria-hidden="true" tabindex="-1"></a>We can find all tasks with less than 4000 observations by specifying this constraint in <span class="in">`r ref("mlr3oml::list_oml_tasks()")`</span>.</span>
<span id="cb182-1027"><a href="#cb182-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1030"><a href="#cb182-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1031"><a href="#cb182-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-1032"><a href="#cb182-1032" aria-hidden="true" tabindex="-1"></a>path_automl_table <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">"openml"</span>, <span class="st">"manual"</span>, <span class="st">"automl_table.rds"</span>)</span>
<span id="cb182-1033"><a href="#cb182-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1034"><a href="#cb182-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1035"><a href="#cb182-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1036"><a href="#cb182-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-030, eval = !file.exists(path_automl_table)}</span></span>
<span id="cb182-1037"><a href="#cb182-1037" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">=</span> <span class="fu">list_oml_tasks</span>(</span>
<span id="cb182-1038"><a href="#cb182-1038" aria-hidden="true" tabindex="-1"></a>  <span class="at">task_id =</span> automl_suite<span class="sc">$</span>task_ids, <span class="at">number_instances =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4000</span>)</span>
<span id="cb182-1039"><a href="#cb182-1039" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-1040"><a href="#cb182-1040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1041"><a href="#cb182-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1044"><a href="#cb182-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1045"><a href="#cb182-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-1046"><a href="#cb182-1046" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(path_automl_table)) {</span>
<span id="cb182-1047"><a href="#cb182-1047" aria-hidden="true" tabindex="-1"></a>  tbl <span class="ot">=</span> <span class="fu">readRDS</span>(path_automl_table)</span>
<span id="cb182-1048"><a href="#cb182-1048" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb182-1049"><a href="#cb182-1049" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(tbl, path_automl_table)</span>
<span id="cb182-1050"><a href="#cb182-1050" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-1051"><a href="#cb182-1051" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1052"><a href="#cb182-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1053"><a href="#cb182-1053" aria-hidden="true" tabindex="-1"></a>This returns a table which only contains matching tasks from the AutoML benchmark.</span>
<span id="cb182-1054"><a href="#cb182-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1055"><a href="#cb182-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-032}</span></span>
<span id="cb182-1056"><a href="#cb182-1056" aria-hidden="true" tabindex="-1"></a>tbl[, .(task_id, data_id, name, NumberOfInstances)]</span>
<span id="cb182-1057"><a href="#cb182-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1058"><a href="#cb182-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1059"><a href="#cb182-1059" aria-hidden="true" tabindex="-1"></a>We can create <span class="in">`mlr3`</span> tasks from these OpenML IDs using <span class="in">`tsk("oml")`</span>.</span>
<span id="cb182-1060"><a href="#cb182-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1061"><a href="#cb182-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-033}</span></span>
<span id="cb182-1062"><a href="#cb182-1062" aria-hidden="true" tabindex="-1"></a>tasks <span class="ot">=</span> <span class="fu">lapply</span>(tbl<span class="sc">$</span>task_id, <span class="cf">function</span>(id) <span class="fu">tsk</span>(<span class="st">"oml"</span>, <span class="at">task_id =</span> id))</span>
<span id="cb182-1063"><a href="#cb182-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1064"><a href="#cb182-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1065"><a href="#cb182-1065" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Create an experimental design that compares <span class="in">`regr.ranger`</span> to <span class="in">`regr.rpart`</span>, use the robustify pipeline for both learners and a featureless fallback learner. Use three-fold cross-validation instead of the OpenML resamplings.</span>
<span id="cb182-1066"><a href="#cb182-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1067"><a href="#cb182-1067" aria-hidden="true" tabindex="-1"></a>Below, we define the robustified learners with a featureless fallback learner.</span>
<span id="cb182-1068"><a href="#cb182-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1069"><a href="#cb182-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-034}</span></span>
<span id="cb182-1070"><a href="#cb182-1070" aria-hidden="true" tabindex="-1"></a>lrn_ranger <span class="ot">=</span> <span class="fu">as_learner</span>(</span>
<span id="cb182-1071"><a href="#cb182-1071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ppl</span>(<span class="st">"robustify"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-1072"><a href="#cb182-1072" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>))</span>
<span id="cb182-1073"><a href="#cb182-1073" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-1074"><a href="#cb182-1074" aria-hidden="true" tabindex="-1"></a>lrn_ranger<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"ranger"</span></span>
<span id="cb182-1075"><a href="#cb182-1075" aria-hidden="true" tabindex="-1"></a>lrn_ranger<span class="sc">$</span>fallback <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.featureless"</span>)</span>
<span id="cb182-1076"><a href="#cb182-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1077"><a href="#cb182-1077" aria-hidden="true" tabindex="-1"></a>lrn_rpart <span class="ot">=</span> <span class="fu">as_learner</span>(</span>
<span id="cb182-1078"><a href="#cb182-1078" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ppl</span>(<span class="st">"robustify"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-1079"><a href="#cb182-1079" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>))</span>
<span id="cb182-1080"><a href="#cb182-1080" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-1081"><a href="#cb182-1081" aria-hidden="true" tabindex="-1"></a>lrn_rpart<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"rpart"</span></span>
<span id="cb182-1082"><a href="#cb182-1082" aria-hidden="true" tabindex="-1"></a>lrn_rpart<span class="sc">$</span>fallback <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.featureless"</span>)</span>
<span id="cb182-1083"><a href="#cb182-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1084"><a href="#cb182-1084" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(lrn_ranger, lrn_rpart)</span>
<span id="cb182-1085"><a href="#cb182-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1086"><a href="#cb182-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1087"><a href="#cb182-1087" aria-hidden="true" tabindex="-1"></a>Finally, we create the experimental design using <span class="in">`r ref("benchmark_grid()")`</span>.</span>
<span id="cb182-1088"><a href="#cb182-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1089"><a href="#cb182-1089" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-035}</span></span>
<span id="cb182-1090"><a href="#cb182-1090" aria-hidden="true" tabindex="-1"></a><span class="co"># we set the seed, as benchmark_grid instantiates the resamplings</span></span>
<span id="cb182-1091"><a href="#cb182-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb182-1092"><a href="#cb182-1092" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)</span>
<span id="cb182-1093"><a href="#cb182-1093" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tasks, learners, resampling)</span>
<span id="cb182-1094"><a href="#cb182-1094" aria-hidden="true" tabindex="-1"></a>design</span>
<span id="cb182-1095"><a href="#cb182-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1096"><a href="#cb182-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1097"><a href="#cb182-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Create a registry and populate it with the experiments. Optionally: change the cluster function to either "Socket" or "Multicore" (the latter does not work on Windows).</span>
<span id="cb182-1098"><a href="#cb182-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1099"><a href="#cb182-1099" aria-hidden="true" tabindex="-1"></a>We start with loading the relevant libraries and creating a registry.</span>
<span id="cb182-1100"><a href="#cb182-1100" aria-hidden="true" tabindex="-1"></a>By specifying the registry's <span class="in">`file.dir`</span> to <span class="in">`NA`</span> we are using a temporary directory.</span>
<span id="cb182-1101"><a href="#cb182-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1102"><a href="#cb182-1102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-036}</span></span>
<span id="cb182-1103"><a href="#cb182-1103" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb182-1104"><a href="#cb182-1104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3batchmark)</span>
<span id="cb182-1105"><a href="#cb182-1105" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(batchtools)</span>
<span id="cb182-1106"><a href="#cb182-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1107"><a href="#cb182-1107" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">=</span> <span class="fu">makeExperimentRegistry</span>(</span>
<span id="cb182-1108"><a href="#cb182-1108" aria-hidden="true" tabindex="-1"></a>  <span class="at">file.dir =</span> <span class="cn">NA</span>,</span>
<span id="cb182-1109"><a href="#cb182-1109" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1</span>,</span>
<span id="cb182-1110"><a href="#cb182-1110" aria-hidden="true" tabindex="-1"></a>  <span class="at">packages =</span> <span class="st">"mlr3verse"</span></span>
<span id="cb182-1111"><a href="#cb182-1111" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb182-1112"><a href="#cb182-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1113"><a href="#cb182-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1114"><a href="#cb182-1114" aria-hidden="true" tabindex="-1"></a>Then, we change the cluster function to "Multicore" (or "Socket" if you are on Windows).</span>
<span id="cb182-1115"><a href="#cb182-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1116"><a href="#cb182-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-037}</span></span>
<span id="cb182-1117"><a href="#cb182-1117" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb182-1118"><a href="#cb182-1118" aria-hidden="true" tabindex="-1"></a><span class="co"># Mac and Linux</span></span>
<span id="cb182-1119"><a href="#cb182-1119" aria-hidden="true" tabindex="-1"></a>reg<span class="sc">$</span>cluster.functions <span class="ot">=</span> <span class="fu">makeClusterFunctionsMulticore</span>()</span>
<span id="cb182-1120"><a href="#cb182-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1121"><a href="#cb182-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># Windows:</span></span>
<span id="cb182-1122"><a href="#cb182-1122" aria-hidden="true" tabindex="-1"></a>reg<span class="sc">$</span>cluster.functions <span class="ot">=</span> <span class="fu">makeClusterFunctionsSocket</span>()</span>
<span id="cb182-1123"><a href="#cb182-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1124"><a href="#cb182-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRegistry</span>(reg)</span>
<span id="cb182-1125"><a href="#cb182-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1126"><a href="#cb182-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1129"><a href="#cb182-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1130"><a href="#cb182-1130" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb182-1131"><a href="#cb182-1131" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: false</span></span>
<span id="cb182-1132"><a href="#cb182-1132" aria-hidden="true" tabindex="-1"></a>reg<span class="sc">$</span>cluster.functions <span class="ot">=</span> <span class="fu">makeClusterFunctionsInteractive</span>()</span>
<span id="cb182-1133"><a href="#cb182-1133" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRegistry</span>(reg)</span>
<span id="cb182-1134"><a href="#cb182-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1135"><a href="#cb182-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1136"><a href="#cb182-1136" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Submit the jobs and once they are finished, collect the results.</span>
<span id="cb182-1137"><a href="#cb182-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1138"><a href="#cb182-1138" aria-hidden="true" tabindex="-1"></a>The next two steps are to populate the registry with the experiments using <span class="in">`batchmark()`</span> and to submit them.</span>
<span id="cb182-1139"><a href="#cb182-1139" aria-hidden="true" tabindex="-1"></a>By specifying no IDs in <span class="in">`submitJobs()`</span>, all jobs returned by <span class="in">`findNotSubmitted()`</span> are queued, which in this case are all existing jobs.</span>
<span id="cb182-1140"><a href="#cb182-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1141"><a href="#cb182-1141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-038}</span></span>
<span id="cb182-1142"><a href="#cb182-1142" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb182-1143"><a href="#cb182-1143" aria-hidden="true" tabindex="-1"></a><span class="fu">batchmark</span>(design, <span class="at">reg =</span> reg)</span>
<span id="cb182-1144"><a href="#cb182-1144" aria-hidden="true" tabindex="-1"></a><span class="fu">submitJobs</span>(<span class="at">reg =</span> reg)</span>
<span id="cb182-1145"><a href="#cb182-1145" aria-hidden="true" tabindex="-1"></a><span class="fu">waitForJobs</span>(<span class="at">reg =</span> reg)</span>
<span id="cb182-1146"><a href="#cb182-1146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1147"><a href="#cb182-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1148"><a href="#cb182-1148" aria-hidden="true" tabindex="-1"></a>After the execution of the experiment finished, we can collect the results like below.</span>
<span id="cb182-1149"><a href="#cb182-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1150"><a href="#cb182-1150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-040}</span></span>
<span id="cb182-1151"><a href="#cb182-1151" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">reduceResultsBatchmark</span>(<span class="at">reg =</span> reg)</span>
<span id="cb182-1152"><a href="#cb182-1152" aria-hidden="true" tabindex="-1"></a>bmr</span>
<span id="cb182-1153"><a href="#cb182-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1154"><a href="#cb182-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1155"><a href="#cb182-1155" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>Conduct a global Friedman test and interpret the results using <span class="in">`regr.mse`</span>. Why do we not need to use the post-hoc test?</span>
<span id="cb182-1156"><a href="#cb182-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1157"><a href="#cb182-1157" aria-hidden="true" tabindex="-1"></a>As a first step, we load <span class="in">`r ref_pkg("mlr3benchmark")`</span> and create a benchmark aggregate using <span class="in">`msr("regr.mse")`</span>.</span>
<span id="cb182-1158"><a href="#cb182-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1159"><a href="#cb182-1159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-041}</span></span>
<span id="cb182-1160"><a href="#cb182-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3benchmark)</span>
<span id="cb182-1161"><a href="#cb182-1161" aria-hidden="true" tabindex="-1"></a>bma <span class="ot">=</span> <span class="fu">as_benchmark_aggr</span>(bmr, <span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"regr.mse"</span>))</span>
<span id="cb182-1162"><a href="#cb182-1162" aria-hidden="true" tabindex="-1"></a>bma</span>
<span id="cb182-1163"><a href="#cb182-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1164"><a href="#cb182-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1165"><a href="#cb182-1165" aria-hidden="true" tabindex="-1"></a>We can now use the <span class="in">`$friedman_test()`</span> method to apply the test to the experiment results.</span>
<span id="cb182-1166"><a href="#cb182-1166" aria-hidden="true" tabindex="-1"></a>We do not need a post-hoc test, because we are only comparing two algorithms.</span>
<span id="cb182-1167"><a href="#cb182-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1168"><a href="#cb182-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1169"><a href="#cb182-1169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-042}</span></span>
<span id="cb182-1170"><a href="#cb182-1170" aria-hidden="true" tabindex="-1"></a>bma<span class="sc">$</span><span class="fu">friedman_test</span>()</span>
<span id="cb182-1171"><a href="#cb182-1171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1172"><a href="#cb182-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1173"><a href="#cb182-1173" aria-hidden="true" tabindex="-1"></a>This experimental design was not able to detect a significant difference on the 5% level so we cannot reject our null hypothesis that the regression tree performs equally well as the random forest.</span>
<span id="cb182-1174"><a href="#cb182-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1175"><a href="#cb182-1175" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Inspect the ranks of the results.</span>
<span id="cb182-1176"><a href="#cb182-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1177"><a href="#cb182-1177" aria-hidden="true" tabindex="-1"></a>We inspect the ranks using the <span class="in">`$rank_data()`</span> method of the <span class="in">`r ref("BenchmarkAggr")`</span>, where we specify <span class="in">`minimize`</span> to <span class="in">`TRUE`</span>, because a lower mean square error is better.</span>
<span id="cb182-1178"><a href="#cb182-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1179"><a href="#cb182-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-043}</span></span>
<span id="cb182-1180"><a href="#cb182-1180" aria-hidden="true" tabindex="-1"></a>bma<span class="sc">$</span><span class="fu">rank_data</span>(<span class="at">minimize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb182-1181"><a href="#cb182-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1182"><a href="#cb182-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1183"><a href="#cb182-1183" aria-hidden="true" tabindex="-1"></a>The random forest is better on 7 of the 10 tasks.</span>
<span id="cb182-1184"><a href="#cb182-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1185"><a href="#cb182-1185" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-interpretation</span></span>
<span id="cb182-1186"><a href="#cb182-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1187"><a href="#cb182-1187" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Prepare a <span class="in">`mlr3`</span> regression task for <span class="in">`fifa`</span> data. Select only variables describing the age and skills of footballers. Train any predictive model for this task, e.g. <span class="in">`lrn("regr.ranger")`</span>.</span>
<span id="cb182-1188"><a href="#cb182-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1189"><a href="#cb182-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-044, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1190"><a href="#cb182-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DALEX)</span>
<span id="cb182-1191"><a href="#cb182-1191" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb182-1192"><a href="#cb182-1192" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"fifa"</span>, <span class="at">package =</span> <span class="st">"DALEX"</span>)</span>
<span id="cb182-1193"><a href="#cb182-1193" aria-hidden="true" tabindex="-1"></a>old_theme <span class="ot">=</span> <span class="fu">set_theme_dalex</span>(<span class="st">"ema"</span>)</span>
<span id="cb182-1194"><a href="#cb182-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1195"><a href="#cb182-1195" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb182-1196"><a href="#cb182-1196" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span>
<span id="cb182-1197"><a href="#cb182-1197" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb182-1198"><a href="#cb182-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1199"><a href="#cb182-1199" aria-hidden="true" tabindex="-1"></a>fifa20 <span class="ot">=</span> fifa[,<span class="dv">5</span><span class="sc">:</span><span class="dv">42</span>]</span>
<span id="cb182-1200"><a href="#cb182-1200" aria-hidden="true" tabindex="-1"></a>task_fifa <span class="ot">=</span> <span class="fu">as_task_regr</span>(fifa20, <span class="at">target =</span> <span class="st">"value_eur"</span>, <span class="at">id =</span> <span class="st">"fifa20"</span>)</span>
<span id="cb182-1201"><a href="#cb182-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1202"><a href="#cb182-1202" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.ranger"</span>)</span>
<span id="cb182-1203"><a href="#cb182-1203" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(task_fifa)</span>
<span id="cb182-1204"><a href="#cb182-1204" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span>model</span>
<span id="cb182-1205"><a href="#cb182-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1206"><a href="#cb182-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1207"><a href="#cb182-1207" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Use the permutation importance method to calculate variable importance ranking. Which variable is the most important? Is it surprising?</span>
<span id="cb182-1208"><a href="#cb182-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1209"><a href="#cb182-1209" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb182-1210"><a href="#cb182-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1211"><a href="#cb182-1211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-045, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1212"><a href="#cb182-1212" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(iml)</span>
<span id="cb182-1213"><a href="#cb182-1213" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> Predictor<span class="sc">$</span><span class="fu">new</span>(learner,</span>
<span id="cb182-1214"><a href="#cb182-1214" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> fifa20,</span>
<span id="cb182-1215"><a href="#cb182-1215" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> fifa<span class="sc">$</span>value_eur)</span>
<span id="cb182-1216"><a href="#cb182-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1217"><a href="#cb182-1217" aria-hidden="true" tabindex="-1"></a>effect <span class="ot">=</span> FeatureImp<span class="sc">$</span><span class="fu">new</span>(model,</span>
<span id="cb182-1218"><a href="#cb182-1218" aria-hidden="true" tabindex="-1"></a>                <span class="at">loss =</span> <span class="st">"rmse"</span>)</span>
<span id="cb182-1219"><a href="#cb182-1219" aria-hidden="true" tabindex="-1"></a>effect<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb182-1220"><a href="#cb182-1220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1221"><a href="#cb182-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1222"><a href="#cb182-1222" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb182-1223"><a href="#cb182-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1224"><a href="#cb182-1224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-046, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1225"><a href="#cb182-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DALEX)</span>
<span id="cb182-1226"><a href="#cb182-1226" aria-hidden="true" tabindex="-1"></a>ranger_exp <span class="ot">=</span> DALEX<span class="sc">::</span><span class="fu">explain</span>(learner,</span>
<span id="cb182-1227"><a href="#cb182-1227" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> fifa20,</span>
<span id="cb182-1228"><a href="#cb182-1228" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> fifa<span class="sc">$</span>value_eur,</span>
<span id="cb182-1229"><a href="#cb182-1229" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"Fifa 2020"</span>,</span>
<span id="cb182-1230"><a href="#cb182-1230" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb182-1231"><a href="#cb182-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1232"><a href="#cb182-1232" aria-hidden="true" tabindex="-1"></a>ranger_effect <span class="ot">=</span> <span class="fu">model_parts</span>(ranger_exp, <span class="at">B =</span> <span class="dv">5</span>)</span>
<span id="cb182-1233"><a href="#cb182-1233" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ranger_effect)</span>
<span id="cb182-1234"><a href="#cb182-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_effect)</span>
<span id="cb182-1235"><a href="#cb182-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1236"><a href="#cb182-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1237"><a href="#cb182-1237" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Use the Partial Dependence profile to draw the global behavior of the model for this variable. Is it aligned with your expectations?</span>
<span id="cb182-1238"><a href="#cb182-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1239"><a href="#cb182-1239" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb182-1240"><a href="#cb182-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1241"><a href="#cb182-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-047, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1242"><a href="#cb182-1242" aria-hidden="true" tabindex="-1"></a>num_features <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span>)</span>
<span id="cb182-1243"><a href="#cb182-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1244"><a href="#cb182-1244" aria-hidden="true" tabindex="-1"></a>effect <span class="ot">=</span> FeatureEffects<span class="sc">$</span><span class="fu">new</span>(model)</span>
<span id="cb182-1245"><a href="#cb182-1245" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(effect, <span class="at">features =</span> num_features)</span>
<span id="cb182-1246"><a href="#cb182-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1247"><a href="#cb182-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1248"><a href="#cb182-1248" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb182-1249"><a href="#cb182-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1250"><a href="#cb182-1250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-048, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1251"><a href="#cb182-1251" aria-hidden="true" tabindex="-1"></a>num_features <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span>)</span>
<span id="cb182-1252"><a href="#cb182-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1253"><a href="#cb182-1253" aria-hidden="true" tabindex="-1"></a>ranger_profiles <span class="ot">=</span> <span class="fu">model_profile</span>(ranger_exp, <span class="at">variables =</span> num_features)</span>
<span id="cb182-1254"><a href="#cb182-1254" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_profiles)</span>
<span id="cb182-1255"><a href="#cb182-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1256"><a href="#cb182-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1257"><a href="#cb182-1257" aria-hidden="true" tabindex="-1"></a>4 Choose one of the football players. You can choose some well-known striker (e.g. Robert Lewandowski) or a well-known goalkeeper (e.g. Manuel Neuer). The following tasks are worth repeating for several different choices.</span>
<span id="cb182-1258"><a href="#cb182-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1259"><a href="#cb182-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-049, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1260"><a href="#cb182-1260" aria-hidden="true" tabindex="-1"></a>player_1 <span class="ot">=</span> fifa[<span class="st">"R. Lewandowski"</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">42</span>]</span>
<span id="cb182-1261"><a href="#cb182-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1262"><a href="#cb182-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1263"><a href="#cb182-1263" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>For the selected footballer, calculate and plot the Shapley values. Which variable is locally the most important and has the strongest influence on the valuation of the footballer?</span>
<span id="cb182-1264"><a href="#cb182-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1265"><a href="#cb182-1265" aria-hidden="true" tabindex="-1"></a>**With `iml`**</span>
<span id="cb182-1266"><a href="#cb182-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1267"><a href="#cb182-1267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-050, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1268"><a href="#cb182-1268" aria-hidden="true" tabindex="-1"></a>shapley <span class="ot">=</span> Shapley<span class="sc">$</span><span class="fu">new</span>(model, <span class="at">x.interest =</span> player_1)</span>
<span id="cb182-1269"><a href="#cb182-1269" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(shapley)</span>
<span id="cb182-1270"><a href="#cb182-1270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1271"><a href="#cb182-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1272"><a href="#cb182-1272" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb182-1273"><a href="#cb182-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1274"><a href="#cb182-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-051, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1275"><a href="#cb182-1275" aria-hidden="true" tabindex="-1"></a>ranger_shap <span class="ot">=</span> <span class="fu">predict_parts</span>(ranger_exp,</span>
<span id="cb182-1276"><a href="#cb182-1276" aria-hidden="true" tabindex="-1"></a>             <span class="at">new_observation =</span> player_1,</span>
<span id="cb182-1277"><a href="#cb182-1277" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="st">"shap"</span>, <span class="at">B =</span> <span class="dv">1</span>)</span>
<span id="cb182-1278"><a href="#cb182-1278" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_shap, <span class="at">show_boxplots =</span> <span class="cn">FALSE</span>)</span>
<span id="cb182-1279"><a href="#cb182-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1280"><a href="#cb182-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1281"><a href="#cb182-1281" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>For the selected footballer, calculate the Ceteris Paribus / Individual Conditional Expectation profiles to draw the local behavior of the model for this variable. Is it different from the global behavior?</span>
<span id="cb182-1282"><a href="#cb182-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1283"><a href="#cb182-1283" aria-hidden="true" tabindex="-1"></a>**With `DALEX`**</span>
<span id="cb182-1284"><a href="#cb182-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1285"><a href="#cb182-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r solutions-052, warning=FALSE, message=FALSE}</span></span>
<span id="cb182-1286"><a href="#cb182-1286" aria-hidden="true" tabindex="-1"></a>num_features <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"movement_reactions"</span>, <span class="st">"skill_ball_control"</span>, <span class="st">"age"</span>)</span>
<span id="cb182-1287"><a href="#cb182-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1288"><a href="#cb182-1288" aria-hidden="true" tabindex="-1"></a>ranger_ceteris <span class="ot">=</span> <span class="fu">predict_profile</span>(ranger_exp, player_1)</span>
<span id="cb182-1289"><a href="#cb182-1289" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ranger_ceteris, <span class="at">variables =</span> num_features) <span class="sc">+</span></span>
<span id="cb182-1290"><a href="#cb182-1290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Ceteris paribus for R. Lewandowski"</span>, <span class="st">" "</span>)</span>
<span id="cb182-1291"><a href="#cb182-1291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1292"><a href="#cb182-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1293"><a href="#cb182-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions to @sec-fairness</span></span>
<span id="cb182-1294"><a href="#cb182-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1295"><a href="#cb182-1295" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Load the <span class="in">`adult_train`</span> task and try to build a first model.</span>
<span id="cb182-1296"><a href="#cb182-1296" aria-hidden="true" tabindex="-1"></a>  Train a simple model and evaluate it on the <span class="in">`adult_test`</span> task that is also available with <span class="in">`mlr3fairness`</span>.</span>
<span id="cb182-1297"><a href="#cb182-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1298"><a href="#cb182-1298" aria-hidden="true" tabindex="-1"></a>For now we simply load the data and look at the data.</span>
<span id="cb182-1299"><a href="#cb182-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1302"><a href="#cb182-1302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1303"><a href="#cb182-1303" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3)</span>
<span id="cb182-1304"><a href="#cb182-1304" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3fairness)</span>
<span id="cb182-1305"><a href="#cb182-1305" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8</span>)</span>
<span id="cb182-1306"><a href="#cb182-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1307"><a href="#cb182-1307" aria-hidden="true" tabindex="-1"></a>tsk_adult_train <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"adult_train"</span>)</span>
<span id="cb182-1308"><a href="#cb182-1308" aria-hidden="true" tabindex="-1"></a>tsk_adult_test <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"adult_test"</span>)</span>
<span id="cb182-1309"><a href="#cb182-1309" aria-hidden="true" tabindex="-1"></a>tsk_adult_train</span>
<span id="cb182-1310"><a href="#cb182-1310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1311"><a href="#cb182-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1312"><a href="#cb182-1312" aria-hidden="true" tabindex="-1"></a>We can now train a simple model, e.g., a decision tree and evaluate for accuracy.</span>
<span id="cb182-1313"><a href="#cb182-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1316"><a href="#cb182-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1317"><a href="#cb182-1317" aria-hidden="true" tabindex="-1"></a>learner <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb182-1318"><a href="#cb182-1318" aria-hidden="true" tabindex="-1"></a>learner<span class="sc">$</span><span class="fu">train</span>(tsk_adult_train)</span>
<span id="cb182-1319"><a href="#cb182-1319" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">=</span> learner<span class="sc">$</span><span class="fu">predict</span>(tsk_adult_test)</span>
<span id="cb182-1320"><a href="#cb182-1320" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>()</span>
<span id="cb182-1321"><a href="#cb182-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1322"><a href="#cb182-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1323"><a href="#cb182-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1324"><a href="#cb182-1324" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Assume our goal is to achieve parity in *false omission rates*.</span>
<span id="cb182-1325"><a href="#cb182-1325" aria-hidden="true" tabindex="-1"></a>  Construct a fairness metric that encodes this and againg evaluate your model.</span>
<span id="cb182-1326"><a href="#cb182-1326" aria-hidden="true" tabindex="-1"></a>  Construct a fairness metric that encodes this and evaluate your model.</span>
<span id="cb182-1327"><a href="#cb182-1327" aria-hidden="true" tabindex="-1"></a>  In order to get a deeper understanding, look at the <span class="in">`groupwise_metrics`</span> function to obtain performance in each group.</span>
<span id="cb182-1328"><a href="#cb182-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1329"><a href="#cb182-1329" aria-hidden="true" tabindex="-1"></a>The metric is available via the key <span class="in">`"fairness.fomr"`</span>.</span>
<span id="cb182-1330"><a href="#cb182-1330" aria-hidden="true" tabindex="-1"></a>Note, that evaluating our prediction now requires that we also provide the task.</span>
<span id="cb182-1331"><a href="#cb182-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1334"><a href="#cb182-1334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1335"><a href="#cb182-1335" aria-hidden="true" tabindex="-1"></a>msr_1 <span class="ot">=</span> <span class="fu">msr</span>(<span class="st">"fairness.fomr"</span>)</span>
<span id="cb182-1336"><a href="#cb182-1336" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_1, tsk_adult_test)</span>
<span id="cb182-1337"><a href="#cb182-1337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1338"><a href="#cb182-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1339"><a href="#cb182-1339" aria-hidden="true" tabindex="-1"></a>The <span class="in">`groupwise_metrics`</span> function creates a metric for each group specified in the <span class="in">`pta`</span> column role:</span>
<span id="cb182-1340"><a href="#cb182-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1343"><a href="#cb182-1343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1344"><a href="#cb182-1344" aria-hidden="true" tabindex="-1"></a>tsk_adult_test<span class="sc">$</span>col_roles<span class="sc">$</span>pta</span>
<span id="cb182-1345"><a href="#cb182-1345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1346"><a href="#cb182-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1349"><a href="#cb182-1349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1350"><a href="#cb182-1350" aria-hidden="true" tabindex="-1"></a>msr_2 <span class="ot">=</span> <span class="fu">groupwise_metrics</span>(<span class="at">base_measure =</span> <span class="fu">msr</span>(<span class="st">"classif.fomr"</span>), <span class="at">task =</span> tsk_adult_test)</span>
<span id="cb182-1351"><a href="#cb182-1351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1352"><a href="#cb182-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1353"><a href="#cb182-1353" aria-hidden="true" tabindex="-1"></a>We can then use this metric to evaluate our model again.</span>
<span id="cb182-1354"><a href="#cb182-1354" aria-hidden="true" tabindex="-1"></a>This gives us the false omission rates for male and female individuals separately.</span>
<span id="cb182-1355"><a href="#cb182-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1358"><a href="#cb182-1358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1359"><a href="#cb182-1359" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_2, tsk_adult_test)</span>
<span id="cb182-1360"><a href="#cb182-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1361"><a href="#cb182-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1362"><a href="#cb182-1362" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Improve your model by employing pipelines that use pre- or post-processing methods for fairness.</span>
<span id="cb182-1363"><a href="#cb182-1363" aria-hidden="true" tabindex="-1"></a>  Evaluate your model along the two metrics and visualize the results.</span>
<span id="cb182-1364"><a href="#cb182-1364" aria-hidden="true" tabindex="-1"></a>  Compare the different models using an appropriate visualization.</span>
<span id="cb182-1365"><a href="#cb182-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1366"><a href="#cb182-1366" aria-hidden="true" tabindex="-1"></a>First we can again construct the learners above.</span>
<span id="cb182-1369"><a href="#cb182-1369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1370"><a href="#cb182-1370" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3pipelines)</span>
<span id="cb182-1371"><a href="#cb182-1371" aria-hidden="true" tabindex="-1"></a>lrn_1 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"reweighing_wts"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb182-1372"><a href="#cb182-1372" aria-hidden="true" tabindex="-1"></a>lrn_2 <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner_cv"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb182-1373"><a href="#cb182-1373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"EOd"</span>)</span>
<span id="cb182-1374"><a href="#cb182-1374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1375"><a href="#cb182-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1376"><a href="#cb182-1376" aria-hidden="true" tabindex="-1"></a>And run the benchmark again. Note, that we use three-fold CV this time for comparison.</span>
<span id="cb182-1377"><a href="#cb182-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1380"><a href="#cb182-1380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1381"><a href="#cb182-1381" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(learner, lrn_1, lrn_2)</span>
<span id="cb182-1382"><a href="#cb182-1382" aria-hidden="true" tabindex="-1"></a>design <span class="ot">=</span> <span class="fu">benchmark_grid</span>(tsk_adult_train, learners, <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> 3L))</span>
<span id="cb182-1383"><a href="#cb182-1383" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(design)</span>
<span id="cb182-1384"><a href="#cb182-1384" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="fu">msrs</span>(<span class="fu">c</span>(<span class="st">"classif.acc"</span>, <span class="st">"fairness.fomr"</span>)))</span>
<span id="cb182-1385"><a href="#cb182-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1386"><a href="#cb182-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1387"><a href="#cb182-1387" aria-hidden="true" tabindex="-1"></a>We can now again visualize the result.</span>
<span id="cb182-1388"><a href="#cb182-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1391"><a href="#cb182-1391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1392"><a href="#cb182-1392" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb182-1393"><a href="#cb182-1393" aria-hidden="true" tabindex="-1"></a><span class="fu">fairness_accuracy_tradeoff</span>(bmr, <span class="fu">msr</span>(<span class="st">"fairness.fomr"</span>)) <span class="sc">+</span></span>
<span id="cb182-1394"><a href="#cb182-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="st">"Learner"</span>) <span class="sc">+</span></span>
<span id="cb182-1395"><a href="#cb182-1395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb182-1396"><a href="#cb182-1396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1397"><a href="#cb182-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1398"><a href="#cb182-1398" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Add <span class="in">`"race"`</span> as a second sensitive attribute to your dataset.</span>
<span id="cb182-1399"><a href="#cb182-1399" aria-hidden="true" tabindex="-1"></a>  Add the information to your task and evaluate the initial model again. What changes?</span>
<span id="cb182-1400"><a href="#cb182-1400" aria-hidden="true" tabindex="-1"></a>  Again study the <span class="in">`groupwise_metrics`</span>.</span>
<span id="cb182-1401"><a href="#cb182-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1402"><a href="#cb182-1402" aria-hidden="true" tabindex="-1"></a>This can be achieved by adding "race" to the <span class="in">`"pta"`</span> col_role.</span>
<span id="cb182-1403"><a href="#cb182-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1406"><a href="#cb182-1406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1407"><a href="#cb182-1407" aria-hidden="true" tabindex="-1"></a>tsk_adult_train<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"race"</span>, <span class="at">add_to =</span> <span class="st">"pta"</span>)</span>
<span id="cb182-1408"><a href="#cb182-1408" aria-hidden="true" tabindex="-1"></a>tsk_adult_train</span>
<span id="cb182-1409"><a href="#cb182-1409" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1410"><a href="#cb182-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1413"><a href="#cb182-1413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1414"><a href="#cb182-1414" aria-hidden="true" tabindex="-1"></a>tsk_adult_test<span class="sc">$</span><span class="fu">set_col_roles</span>(<span class="st">"race"</span>, <span class="at">add_to =</span> <span class="st">"pta"</span>)</span>
<span id="cb182-1415"><a href="#cb182-1415" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_1, tsk_adult_test)</span>
<span id="cb182-1416"><a href="#cb182-1416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1417"><a href="#cb182-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1418"><a href="#cb182-1418" aria-hidden="true" tabindex="-1"></a>If we now evaluate for the intersection, we obtain a large deviation from <span class="in">`0`</span>.</span>
<span id="cb182-1419"><a href="#cb182-1419" aria-hidden="true" tabindex="-1"></a>Note, that the metric by default computes the maximum discrepancy between all metrics for the non-binary case.</span>
<span id="cb182-1420"><a href="#cb182-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1421"><a href="#cb182-1421" aria-hidden="true" tabindex="-1"></a>If we now get the <span class="in">`groupwise_metrics`</span>, we will get a metric for the intersection of each group.</span>
<span id="cb182-1422"><a href="#cb182-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1425"><a href="#cb182-1425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1426"><a href="#cb182-1426" aria-hidden="true" tabindex="-1"></a>msr_3 <span class="ot">=</span> <span class="fu">groupwise_metrics</span>(<span class="fu">msr</span>(<span class="st">"classif.fomr"</span>),  tsk_adult_train)</span>
<span id="cb182-1427"><a href="#cb182-1427" aria-hidden="true" tabindex="-1"></a><span class="fu">unname</span>(<span class="fu">sapply</span>(msr_3, <span class="cf">function</span>(x) x<span class="sc">$</span>id))</span>
<span id="cb182-1428"><a href="#cb182-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1429"><a href="#cb182-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1432"><a href="#cb182-1432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1433"><a href="#cb182-1433" aria-hidden="true" tabindex="-1"></a>prediction<span class="sc">$</span><span class="fu">score</span>(msr_3, tsk_adult_test)</span>
<span id="cb182-1434"><a href="#cb182-1434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1435"><a href="#cb182-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1436"><a href="#cb182-1436" aria-hidden="true" tabindex="-1"></a>And we can see, that the reason might be, that the false omission rate for female Amer-Indian-Eskimo is at <span class="in">`1.0`</span>!</span>
<span id="cb182-1437"><a href="#cb182-1437" aria-hidden="true" tabindex="-1"></a>We can investigate this further by looking at actual counts:</span>
<span id="cb182-1438"><a href="#cb182-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1441"><a href="#cb182-1441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb182-1442"><a href="#cb182-1442" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(tsk_adult_test<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"sex"</span>, <span class="st">"target"</span>)))</span>
<span id="cb182-1443"><a href="#cb182-1443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb182-1444"><a href="#cb182-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1445"><a href="#cb182-1445" aria-hidden="true" tabindex="-1"></a>One of the reasons might be that there are only 3 individuals in the "&gt;50k" category!</span>
<span id="cb182-1446"><a href="#cb182-1446" aria-hidden="true" tabindex="-1"></a>This is an often encountered problem, as error metrics have a large variance when samples are small.</span>
<span id="cb182-1447"><a href="#cb182-1447" aria-hidden="true" tabindex="-1"></a>Note, that the pre- and post-processing methods in general do not all support multiple protected attributes.</span>
<span id="cb182-1448"><a href="#cb182-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-1449"><a href="#cb182-1449" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> <br> © Bernd Bischl, Raphael Sonabend, Lars Kotthoff, Michel Lang.</div>   
    <div class="nav-footer-center"><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></div>
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>